# Gitサブモジュール管理ガイド

**作成日**: 2026年1月28日
**更新日**: 2026年1月28日
**目的**: Gitサブモジュールを含むリポジトリの開発・管理方法と注意点

---

## 1. 概要

### サブモジュールとは

Gitサブモジュールは、あるGitリポジトリを別のGitリポジトリのサブディレクトリとして含める仕組みです。

```
donkeycar/                    # 親リポジトリ
├── .git/
├── .gitmodules               # サブモジュール設定ファイル
├── donkeycar/
├── docs/
└── picopico_racers/          # サブモジュール（別リポジトリへの参照）
    └── .git → 実際は参照のみ
```

### 本プロジェクトの構成

| リポジトリ | URL | 役割 |
|-----------|-----|------|
| 親リポジトリ | https://github.com/uecken/donkeycar | Level 4自動運転プロジェクト本体 |
| サブモジュール | https://github.com/fumipi/picopico_racers | Team 10 ミニカーチャレンジ |

---

## 2. 基本操作

### 2.1 クローン時の注意（最重要）

**通常のクローンではサブモジュールの中身は取得されません！**

```bash
# ❌ 通常のクローン - サブモジュールは空ディレクトリになる
git clone https://github.com/uecken/donkeycar.git

# ✅ 推奨: サブモジュールも一緒にクローン
git clone --recurse-submodules https://github.com/uecken/donkeycar.git

# ✅ 既にクローン済みの場合はサブモジュールを初期化
cd donkeycar
git submodule init
git submodule update
# または一括で
git submodule update --init --recursive
```

### 2.2 サブモジュールの更新

```bash
# サブモジュールを最新のリモート状態に更新
cd picopico_racers
git fetch
git checkout main
git pull

# または親リポジトリから一括更新
cd donkeycar
git submodule update --remote
```

### 2.3 サブモジュール内での変更をコミット

```bash
# 1. サブモジュール内で作業
cd picopico_racers
# ... ファイルを編集 ...
git add .
git commit -m "変更内容"
git push  # サブモジュールのリモートにプッシュ

# 2. 親リポジトリでサブモジュール参照を更新
cd ..  # donkeycarに戻る
git add picopico_racers
git commit -m "Update picopico_racers submodule reference"
git push  # 親リポジトリにプッシュ
```

---

## 3. 開発ワークフロー

### 3.1 日常的な作業フロー

```
┌─────────────────────────────────────────────────────────┐
│ 1. 作業開始時                                            │
├─────────────────────────────────────────────────────────┤
│ cd donkeycar                                            │
│ git pull                        # 親リポジトリを更新      │
│ git submodule update --init     # サブモジュールを同期    │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 2. サブモジュール内で作業する場合                         │
├─────────────────────────────────────────────────────────┤
│ cd picopico_racers                                      │
│ git checkout main               # ブランチを確認         │
│ # ... 作業 ...                                          │
│ git add . && git commit -m "..."                        │
│ git push                        # サブモジュールをpush   │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 3. 親リポジトリの参照を更新                              │
├─────────────────────────────────────────────────────────┤
│ cd ..                           # 親リポジトリに戻る     │
│ git add picopico_racers                                 │
│ git commit -m "Update submodule"                        │
│ git push                                                │
└─────────────────────────────────────────────────────────┘
```

### 3.2 チーム開発での注意点

| 状況 | 対処法 |
|------|--------|
| 他のメンバーがサブモジュールを更新した | `git pull` 後に `git submodule update` |
| サブモジュールが「変更あり」と表示される | 参照コミットが更新された可能性 → `git submodule update` |
| サブモジュールがdetached HEAD状態 | `cd submodule && git checkout main` |

---

## 4. よくある問題と解決方法

### 4.1 サブモジュールが空（ファイルがない）

**原因**: クローン時に `--recurse-submodules` を付けなかった

```bash
# 解決方法
git submodule update --init --recursive
```

### 4.2 detached HEAD状態

**原因**: サブモジュールは特定のコミットを指すため、デフォルトでブランチに属さない

```bash
# 状態確認
cd picopico_racers
git status
# → HEAD detached at abc1234

# 解決方法: ブランチに切り替え
git checkout main
```

### 4.3 サブモジュールの変更が親に反映されない

**原因**: サブモジュール内でコミット後、親リポジトリで参照更新を忘れている

```bash
# サブモジュール内でコミット・プッシュ済みの場合
cd donkeycar
git status
# → modified: picopico_racers (new commits)

# 親リポジトリで参照を更新
git add picopico_racers
git commit -m "Update picopico_racers to latest"
git push
```

### 4.4 コンフリクト：サブモジュール参照の衝突

**原因**: 複数人が異なるコミットを参照するようにサブモジュールを更新

```bash
# マージ時にコンフリクトが発生した場合
git status
# → both modified: picopico_racers

# 最新を採用する場合
git checkout --theirs picopico_racers
git add picopico_racers

# または自分の変更を優先
git checkout --ours picopico_racers
git add picopico_racers

git commit
```

### 4.5 サブモジュールを削除したい

```bash
# 1. .gitmodulesからエントリを削除
git config -f .gitmodules --remove-section submodule.picopico_racers

# 2. .git/configからエントリを削除
git config --remove-section submodule.picopico_racers

# 3. キャッシュから削除
git rm --cached picopico_racers

# 4. .git/modules内のディレクトリを削除
rm -rf .git/modules/picopico_racers

# 5. 作業ディレクトリから削除（必要に応じて）
rm -rf picopico_racers

# 6. コミット
git add .gitmodules
git commit -m "Remove picopico_racers submodule"
```

---

## 5. 便利なコマンド集

### 状態確認

```bash
# サブモジュールの状態を確認
git submodule status

# 詳細な状態確認
git submodule foreach 'git status'

# サブモジュールのリモートURLを確認
git config --file .gitmodules --get submodule.picopico_racers.url
```

### 一括操作

```bash
# 全サブモジュールで同じコマンドを実行
git submodule foreach 'git checkout main && git pull'

# 全サブモジュールをリモートの最新に更新
git submodule update --remote --merge
```

### 設定

```bash
# git statusでサブモジュールの変更サマリーを表示
git config status.submodulesummary 1

# git diffでサブモジュールの変更を表示
git config diff.submodule log
```

---

## 6. .gitmodulesファイル

サブモジュール設定は `.gitmodules` ファイルに保存されます。

```ini
[submodule "picopico_racers"]
    path = picopico_racers
    url = https://github.com/fumipi/picopico_racers
```

| 項目 | 説明 |
|------|------|
| `path` | サブモジュールのローカルパス |
| `url` | サブモジュールのリモートURL |
| `branch` | (オプション) 追跡するブランチ |

---

## 7. ベストプラクティス

### 推奨事項

1. **クローン時は必ず `--recurse-submodules` を使用**
   ```bash
   git clone --recurse-submodules <url>
   ```

2. **pull後は `git submodule update` を習慣化**
   ```bash
   git pull && git submodule update --init
   ```

3. **サブモジュール内で作業する前にブランチを確認**
   ```bash
   cd picopico_racers
   git checkout main  # detached HEADを防ぐ
   ```

4. **サブモジュールの変更は2段階でコミット**
   - まずサブモジュール内でコミット・プッシュ
   - 次に親リポジトリで参照更新をコミット・プッシュ

5. **Git設定でサブモジュール表示を有効化**
   ```bash
   git config --global status.submodulesummary 1
   git config --global diff.submodule log
   ```

### 避けるべきこと

| NG | 理由 |
|----|------|
| サブモジュール内で直接コミットせずに親で `git add .` | 意図しない参照更新が起こる |
| `--recurse-submodules` なしでクローン | サブモジュールが空になる |
| detached HEAD状態のまま作業 | コミットが迷子になる可能性 |
| サブモジュールをプッシュせずに親だけプッシュ | 他のメンバーが参照先を取得できない |

---

## 8. CI/CD環境での注意点

### GitHub Actions

```yaml
- uses: actions/checkout@v4
  with:
    submodules: 'recursive'  # サブモジュールを含めてチェックアウト
```

### その他のCI

```bash
# ビルドスクリプトの最初に実行
git submodule update --init --recursive
```

---

## 参考リンク

- [Git公式ドキュメント - サブモジュール](https://git-scm.com/book/ja/v2/Git-%E3%81%AE%E3%81%95%E3%81%BE%E3%81%96%E3%81%BE%E3%81%AA%E3%83%84%E3%83%BC%E3%83%AB-%E3%82%B5%E3%83%96%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB)
- [GitHub Docs - サブモジュールを使う](https://docs.github.com/ja/repositories/working-with-files/managing-large-files/working-with-submodules)
