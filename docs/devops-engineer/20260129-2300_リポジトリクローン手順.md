# リポジトリクローン手順

**作成日**: 2026年1月29日
**担当**: devops-engineer
**対象**: 新規Raspberry Piへのdonkeycarリポジトリ展開

---

## 概要

このドキュメントでは、チームメンバーが新しいRaspberry Piに`donkeycar`リポジトリ（サブモジュール含む）をクローンする手順を説明します。

---

## リポジトリ構成

```
donkeycar/                    ← uecken/donkeycar (main ブランチ)
├── donkeycar/                ← Donkey Carソースコード
├── docs/
│   ├── robotcar-engineer/    ← ハードウェア関連資料
│   ├── devops-engineer/      ← 環境構築関連資料
│   └── ml-engineer/          ← 機械学習関連資料
├── picopico_racers/          ← サブモジュール (fumipi/picopico_racers)
│   ├── mycar/                ← 車両設定 (myconfig.py)
│   └── M5C_JOYCON/           ← コントローラーファームウェア
└── .claude/agents/           ← Claudeエージェント定義
```

| リポジトリ | URL | ブランチ |
|-----------|-----|---------|
| donkeycar | https://github.com/uecken/donkeycar | `main` |
| picopico_racers | https://github.com/fumipi/picopico_racers | `feature/add-m5c-joycon` |

---

## クローン手順

### Step 1: リポジトリをクローン（サブモジュール含む）

```bash
# Raspberry Pi で実行
cd ~
git clone --recursive https://github.com/uecken/donkeycar.git
```

`--recursive` オプションにより、`picopico_racers` サブモジュールも同時にクローンされます。

### Step 2: サブモジュールのブランチを切り替え

サブモジュールはデフォルトで detached HEAD 状態になるため、作業ブランチに切り替えます。

```bash
cd ~/donkeycar/picopico_racers
git checkout feature/add-m5c-joycon
git pull origin feature/add-m5c-joycon
```

### Step 3: mycar ディレクトリの設定

#### オプションA: シンボリックリンクを作成（推奨）

```bash
ln -s ~/donkeycar/picopico_racers/mycar ~/mycar
```

これにより `~/mycar` でアクセスできます。

#### オプションB: 直接パスを使用

```bash
cd ~/donkeycar/picopico_racers/mycar
```

### Step 4: 動作確認

```bash
# 仮想環境を有効化（既存環境がある場合）
source ~/env/bin/activate

# Donkey Car 起動テスト
cd ~/mycar  # または ~/donkeycar/picopico_racers/mycar
python manage.py drive
```

---

## 既にクローン済みの場合

### サブモジュールが未取得の場合

```bash
cd ~/donkeycar
git submodule update --init --recursive
```

### サブモジュールを最新に更新

```bash
cd ~/donkeycar
git pull origin main
git submodule update --remote --merge
```

### サブモジュールのブランチ切り替え

```bash
cd ~/donkeycar/picopico_racers
git fetch origin
git checkout feature/add-m5c-joycon
git pull origin feature/add-m5c-joycon
```

---

## Donkey Car 仮想環境のセットアップ

新しいRaspberry Piで仮想環境がない場合：

### 1. 必要パッケージのインストール

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y python3-pip python3-venv python3-dev \
    libatlas-base-dev libopenjp2-7 libtiff5 libcap-dev
```

### 2. I2C/SPI/カメラの有効化

```bash
sudo raspi-config
# Interface Options → I2C, SPI, Camera を有効化
```

### 3. 仮想環境の作成

```bash
python3 -m venv ~/env --system-site-packages
source ~/env/bin/activate
```

### 4. Donkey Car のインストール

```bash
pip install donkeycar[pi]
```

### 5. pigpio デーモンの設定

```bash
sudo systemctl enable pigpiod
sudo systemctl start pigpiod
```

---

## トラブルシューティング

### サブモジュールがクローンされない

```bash
# 手動で初期化
cd ~/donkeycar
git submodule init
git submodule update
```

### Permission denied エラー

```bash
# SSH鍵が設定されていない場合、HTTPS URLを使用
git clone https://github.com/uecken/donkeycar.git
```

### サブモジュールの変更を反映できない

```bash
# サブモジュールのリモートを確認
cd ~/donkeycar/picopico_racers
git remote -v

# 正しいリモートを設定
git remote set-url origin https://github.com/fumipi/picopico_racers.git
```

### myconfig.py が見つからない

```bash
# パスを確認
ls ~/donkeycar/picopico_racers/mycar/myconfig.py

# シンボリックリンクの確認
ls -la ~/mycar
```

---

## クイックスタート（コピペ用）

新しいRaspberry Piで一括実行：

```bash
# 1. クローン
cd ~
git clone --recursive https://github.com/uecken/donkeycar.git

# 2. サブモジュールブランチ切り替え
cd ~/donkeycar/picopico_racers
git checkout feature/add-m5c-joycon

# 3. シンボリックリンク作成
ln -s ~/donkeycar/picopico_racers/mycar ~/mycar

# 4. 動作確認
source ~/env/bin/activate
cd ~/mycar
python manage.py drive
```

---

## 関連資料

| 資料 | パス |
|------|------|
| Donkey Car学習環境構築ガイド | [20260122-1200_Donkey_Car学習環境構築ガイド.md](./20260122-1200_Donkey_Car学習環境構築ガイド.md) |
| WSL2環境セットアップ記録 | [20260122-1510_WSL2学習環境セットアップ記録.md](./20260122-1510_WSL2学習環境セットアップ記録.md) |
| Gitサブモジュール管理ガイド | [20260128-1600_Gitサブモジュール管理ガイド.md](./20260128-1600_Gitサブモジュール管理ガイド.md) |
| DonkeyCar起動ガイド | [../robotcar-engineer/20260129-1830_DonkeyCar起動ガイド.md](../robotcar-engineer/20260129-1830_DonkeyCar起動ガイド.md) |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026年1月29日 | 初版作成 |
