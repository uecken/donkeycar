# WSL2 Donkey Car学習環境セットアップ記録

**作成日**: 2026年1月22日
**環境**: Windows 11 + WSL2 Ubuntu 22.04 + GTX 1660 Ti

---

## 1. 実施した作業

### 作業サマリー

| 項目 | 内容 |
|------|------|
| 作業日 | 2026年1月22日 |
| 所要時間 | 約30分 |
| 対象環境 | WSL2 Ubuntu 22.04 |
| GPU | NVIDIA GeForce GTX 1660 Ti (6GB) |

### インストールしたソフトウェア

| ソフトウェア | バージョン |
|-------------|-----------|
| Miniconda | 最新版（Python 3.13ベース） |
| Python | 3.11.14（donkey環境） |
| Donkey Car | 5.2.0 |
| TensorFlow | 2.15.1 |
| CUDA（pip経由） | 12.2 |
| cuDNN（pip経由） | 8.9.4 |

---

## 2. 実施手順の詳細

### Step 1: 環境確認

```bash
# WSL2の状態確認
wsl --list --verbose

# 結果
#   Ubuntu-22.04    Running    2
```

```bash
# GPU確認（Windows側）
nvidia-smi

# 結果
# NVIDIA GeForce GTX 1660 Ti, 6144 MiB
# Driver Version: 560.94, CUDA Version: 12.6
```

### Step 2: Minicondaインストール

```bash
# ダウンロード
curl -sL https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -o ~/Miniconda3.sh

# インストール（/home/kenji/miniconda3に配置）
bash ~/Miniconda3.sh -b -p /home/kenji/miniconda3

# 初期化
/home/kenji/miniconda3/bin/conda init bash

# 利用規約同意
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
```

### Step 3: Python 3.11環境作成

```bash
conda create -n donkey python=3.11 -y
```

### Step 4: Donkey Carインストール

```bash
conda activate donkey
pip install donkeycar[pc]
```

### Step 5: TensorFlow GPU版インストール

```bash
pip install 'tensorflow[and-cuda]==2.15.*'
```

### Step 6: GPU認識確認

```bash
python -c "import tensorflow as tf; print('GPU:', tf.config.list_physical_devices('GPU'))"

# 結果
# GPU: [PhysicalDevice(name='/physical_device:GPU:0', device_type='GPU')]
```

---

## 3. 環境の起動方法

### 方法A: コマンドプロンプト/PowerShellから

```powershell
# WSL2 Ubuntu 22.04を起動
wsl -d Ubuntu-22.04
```

その後、Ubuntu内で：

```bash
# Conda環境を有効化
source ~/miniconda3/etc/profile.d/conda.sh
conda activate donkey
```

### 方法B: Windows Terminalから

1. Windows Terminalを開く
2. ドロップダウンから「Ubuntu 22.04」を選択
3. 以下を実行：

```bash
source ~/miniconda3/etc/profile.d/conda.sh
conda activate donkey
```

### 方法C: ワンライナー起動

```powershell
wsl -d Ubuntu-22.04 -- bash -c "source ~/miniconda3/etc/profile.d/conda.sh && conda activate donkey && bash"
```

---

## 4. 利用方法

### 4.1 プロジェクト作成

```bash
# Donkey Carプロジェクト作成
donkey createcar --path ~/mycar
cd ~/mycar
```

### 4.2 データ転送（Raspberry Piから）

```bash
# Raspberry Piからデータを転送
rsync -rv pi@<RASPBERRY_PI_IP>:~/mycar/data/ ~/mycar/data/

# 例: IPが192.168.1.100の場合
rsync -rv pi@192.168.1.100:~/mycar/data/ ~/mycar/data/
```

### 4.3 モデル学習

```bash
# 基本学習
donkey train --tub ./data/tub_* --model ./models/mypilot.h5

# モデルタイプ指定（categorical推奨）
donkey train --tub ./data/tub_* --model ./models/mypilot.h5 --type categorical
```

### 4.4 学習済みモデルをRaspberry Piへ転送

```bash
# TFLiteモデルを転送
scp ./models/mypilot.tflite pi@<RASPBERRY_PI_IP>:~/mycar/models/
```

### 4.5 その他のコマンド

```bash
# 不良データ削除（Webインターフェース）
donkey tubclean

# 学習データの可視化
donkey tubplot --tub ./data/tub_*

# 動画作成
donkey makemovie --tub ./data/tub_* --model ./models/mypilot.h5

# UI起動（データ管理）
donkey ui
```

---

## 5. Windowsファイルへのアクセス

### WSL2からWindowsファイルにアクセス

```bash
# Cドライブ
cd /mnt/c/Users/<ユーザー名>/

# 例: donkeycarプロジェクトフォルダ
cd /mnt/c/Users/thefu/Documents/donkeycar/
```

### WindowsからWSL2ファイルにアクセス

エクスプローラーで以下を入力：
```
\\wsl$\Ubuntu-22.04\home\kenji\
```

---

## 6. 警告メッセージについて

TensorFlow実行時に以下の警告が表示されますが、**無視して問題ありません**：

| 警告 | 原因 | 影響 |
|------|------|------|
| `NUMA node` | WSL2の仕様 | なし |
| `TF-TRT Warning` | TensorRT未インストール | なし（推論最適化未使用） |
| `cuDNN/cuFFT factory` | 重複登録警告 | なし |

---

## 7. トラブルシューティング

### GPUが認識されない場合

```bash
# 1. nvidia-smiで確認
nvidia-smi

# 2. Windows側のドライバを更新
# NVIDIAの公式サイトから最新ドライバをダウンロード

# 3. WSL2を再起動
wsl --shutdown
wsl -d Ubuntu-22.04
```

### Conda環境が見つからない場合

```bash
# Condaの初期化を再実行
source ~/miniconda3/etc/profile.d/conda.sh

# または.bashrcを再読み込み
source ~/.bashrc
```

### メモリ不足の場合

`C:\Users\<ユーザー名>\.wslconfig` を作成：

```ini
[wsl2]
memory=16GB
processors=8
swap=8GB
```

設定後、PowerShellで：
```powershell
wsl --shutdown
```

---

## 8. 環境情報まとめ

### パス情報

| 項目 | パス |
|------|------|
| Miniconda | `/home/kenji/miniconda3/` |
| Conda環境（donkey） | `/home/kenji/miniconda3/envs/donkey/` |
| Donkey Carプロジェクト | `~/mycar/`（作成後） |

### バージョン確認コマンド

```bash
# Python
python --version
# Python 3.11.14

# TensorFlow
python -c "import tensorflow as tf; print(tf.__version__)"
# 2.15.1

# Donkey Car
donkey --version
# v5.2.0

# GPU確認
python -c "import tensorflow as tf; print(tf.config.list_physical_devices('GPU'))"
```

---

## 9. 学習時間の目安

| データ量 | GTX 1660 Ti |
|---------|-------------|
| 1,000枚 | 約15秒 |
| 10,000枚 | 約2-3分 |
| 50,000枚 | 約10-15分 |

---

## 10. 動作検証結果（サンプルデータ学習テスト）

### 検証日時
2026年1月22日 18:57〜19:04

### テスト内容
公式サンプルデータセットを使用した学習テストを実施。

### データセット情報

| 項目 | 内容 |
|------|------|
| ソース | [autorope/donkey_datasets](https://github.com/autorope/donkey_datasets) |
| データセット名 | circuit_launch_20210716_1715 |
| 画像数 | 17,706枚 |
| トレーニング/検証分割 | 12,706件 / 3,177件 |

### 学習コマンド

```bash
cd ~/mycar
donkey train --tub ./data/murmurpi4_circuit_launch_20210716_1715/data --model ./models/test_pilot.h5 --type linear
```

### 結果

| 項目 | 結果 |
|------|------|
| **学習時間** | **5分31秒** |
| **GPU使用** | ✅ GTX 1660 Ti (Compute Capability 7.5) |
| **cuDNN** | ✅ バージョン 8904 |
| **出力モデル（Keras）** | test_pilot.h5 (9.9MB) |
| **出力モデル（TFLite）** | test_pilot.tflite (3.3MB) |
| **学習履歴グラフ** | test_pilot.png |

### 生成ファイル

```
~/mycar/models/
├── database.json      # メタデータ
├── test_pilot.h5      # Kerasモデル（学習用PC向け）
├── test_pilot.png     # 学習履歴グラフ
└── test_pilot.tflite  # TFLiteモデル（Raspberry Pi向け）
```

### GPU動作確認ログ（抜粋）

```
StreamExecutor device (0): NVIDIA GeForce GTX 1660 Ti, Compute Capability 7.5
Loaded cuDNN version 8904
Compiled cluster using XLA!
////////// Finished training in: 0:05:31.556198 //////////
```

### 結論

WSL2 + GTX 1660 Ti環境でDonkey Carの学習が正常に動作することを確認しました。

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026年1月22日 | 初版作成 - WSL2環境セットアップ完了 |
| 2026年1月22日 | サンプルデータ学習テスト結果を追記 |
