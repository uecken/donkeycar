# Donkey Car 起動ガイド

**作成日**: 2026年1月29日
**最終更新**: 2026年1月29日
**担当**: robotcar-engineer

---

## 1. 概要

### 1.1 目的

本ガイドは Donkey Car の起動方法を包括的に説明し、手動運転、ジョイスティック運転、自動運転、キャリブレーション、データ収集など各種運用シナリオに対応できるようにします。

### 1.2 対象環境

| 項目 | 仕様 |
|------|------|
| **Donkey Car バージョン** | 5.1 以上 |
| **実車** | Raspberry Pi 4 (`ssh koito@192.168.50.3`) |
| **OS** | Raspberry Pi OS Bookworm (64-bit) |
| **Python** | 3.11 (Bookworm 標準) |
| **仮想環境** | `~/donkey_env` |
| **mycar パス** | `~/picopico_racers/mycar` |

---

## 2. 前提条件（環境準備）

### 2.1 SSH 接続

```bash
# 実車への接続
ssh koito@192.168.50.3
```

### 2.2 仮想環境のアクティベート

```bash
# Donkey Car 仮想環境を有効化
source ~/donkey_env/bin/activate

# プロンプトが (donkey_env) に変わることを確認
```

### 2.3 作業ディレクトリへの移動

```bash
# mycar ディレクトリに移動
cd ~/picopico_racers/mycar
```

### 2.4 環境確認コマンド

```bash
# Python バージョン確認
python --version
# 期待値: Python 3.11.x

# Donkey Car バージョン確認
donkey --version
# 期待値: donkeycar x.x.x

# I2C デバイス確認（PCA9685）
i2cdetect -y 1
# 0x40 が表示されることを確認

# カメラ動作確認
libcamera-still -o test.jpg --timeout 1000
```

---

## 3. 基本起動コマンド一覧

### 3.1 manage.py のコマンド体系

Donkey Car の主要コマンドは `manage.py` を通じて実行します。

```
Usage:
    manage.py (drive) [--model=<model>] [--js] [--type=<type>] [--camera=<camera>] [--meta=<key:value> ...] [--myconfig=<filename>]
    manage.py (train) [--tubs=tubs] (--model=<model>) [--type=<type>]
```

### 3.2 donkey コマンド（グローバル）

`donkey` コマンドは Donkey Car フレームワーク全体のユーティリティです。

| コマンド | 説明 |
|---------|------|
| `donkey createcar` | 新しい mycar ディレクトリを作成 |
| `donkey findcar` | ネットワーク上の Donkey Car を検索 |
| `donkey calibrate` | PWM キャリブレーション |
| `donkey train` | モデル学習 |
| `donkey tubplot` | Tub データの可視化 |
| `donkey tubhist` | Tub データのヒストグラム表示 |
| `donkey makemovie` | Tub データから動画作成 |
| `donkey createjs` | カスタムジョイスティック作成 |
| `donkey ui` | GUI ツール起動 |

---

## 4. 手動運転モード（Web UI）

### 4.1 基本起動

```bash
cd ~/picopico_racers/mycar
source ~/donkey_env/bin/activate

# Web UI で起動（デフォルト）
python manage.py drive
```

### 4.2 Web UI へのアクセス

起動後、ブラウザで以下にアクセスします：

```
http://<ホスト名>.local:8887
または
http://192.168.50.3:8887
```

### 4.3 Web UI の操作

| 操作 | 説明 |
|------|------|
| **左ドラッグ** | ステアリング操作 |
| **上下ドラッグ** | スロットル操作 |
| **Mode ボタン** | user / local_angle / local の切り替え |
| **Recording ボタン** | データ記録の開始/停止 |

### 4.4 カスタムポート指定

```bash
# ポート番号を変更して起動
# myconfig.py で WEB_CONTROL_PORT を変更
WEB_CONTROL_PORT = 8888
```

### 4.5 Web UI 関連設定（myconfig.py）

```python
#WEB CONTROL
WEB_CONTROL_PORT = 8887          # Web UI のポート番号
WEB_INIT_MODE = "user"           # 起動時のモード (user|local_angle|local)
USE_FPV = False                  # FPV プレビュー
```

---

## 5. ジョイスティック運転モード

### 5.1 基本起動

```bash
# --js オプションでジョイスティックモード
python manage.py drive --js
```

### 5.2 myconfig.py でのデフォルト化

```python
#JOYSTICK
USE_JOYSTICK_AS_DEFAULT = True      # 起動時に自動でジョイスティック有効化
JOYSTICK_MAX_THROTTLE = 0.5         # 最大スロットル (0.0-1.0)
JOYSTICK_STEERING_SCALE = 1.0       # ステアリング感度
AUTO_RECORD_ON_THROTTLE = True      # スロットル連動自動録画
CONTROLLER_TYPE = 'xbox'            # コントローラータイプ
JOYSTICK_DEADZONE = 0.01            # デッドゾーン
JOYSTICK_THROTTLE_DIR = -1.0        # スロットル方向 (-1.0 または 1.0)
JOYSTICK_DEVICE_FILE = "/dev/input/js0"  # デバイスファイル
```

### 5.3 サポートされるコントローラータイプ

| タイプ | 説明 |
|--------|------|
| `ps3` | PlayStation 3 コントローラー |
| `ps4` | PlayStation 4 コントローラー |
| `xbox` | Xbox ワイヤレスコントローラー |
| `F710` | Logitech Gamepad F710 |
| `nimbus` | SteelSeries Nimbus |
| `wiiu` | Wii U Pro コントローラー |
| `rc3` | 3チャンネル RC コントローラー |
| `pigpio_rc` | GPIO 経由 RC 受信機 |
| `MM1` | RoboHAT MM1 |
| `custom` | カスタムジョイスティック（my_joystick.py） |
| `mock` | モック（テスト用） |

### 5.4 Xbox コントローラーの操作

| 操作 | 機能 |
|------|------|
| **左スティック（水平）** | ステアリング |
| **右スティック（垂直）** | スロットル |
| **A ボタン** | 緊急停止 |
| **B ボタン** | モード切替 |
| **X ボタン** | 録画開始/停止 |
| **Y ボタン** | 定速走行 ON/OFF |
| **LB** | スロットル減少 |
| **RB** | スロットル増加 |

### 5.5 M5C_JOYCON 使用時

M5C_JOYCON（BLE Gamepad）を使用する場合：

```python
# myconfig.py 設定
USE_JOYSTICK_AS_DEFAULT = True
CONTROLLER_TYPE = 'xbox'  # または 'custom'
JOYSTICK_DEADZONE = 0.05
JOYSTICK_THROTTLE_DIR = -1.0
JOYSTICK_DEVICE_FILE = "/dev/input/js0"
```

詳細は `docs/robotcar-engineer/20260129-1600_M5C_JOYCON_DonkeyCar統合ガイド.md` を参照してください。

---

## 6. 自動運転モード（モデル使用）

### 6.1 学習済みモデルで起動

```bash
# .h5 モデルを使用
python manage.py drive --model=models/mypilot.h5

# TFLite モデルを使用
python manage.py drive --model=models/mypilot.tflite --type=tflite_linear

# モデルタイプを明示的に指定
python manage.py drive --model=models/mypilot.h5 --type=linear
```

### 6.2 サポートされるモデルタイプ

| タイプ | 説明 | ファイル形式 |
|--------|------|-------------|
| `linear` | 線形回帰モデル | .h5, .savedmodel |
| `categorical` | カテゴリカルモデル | .h5, .savedmodel |
| `tflite_linear` | TensorFlow Lite | .tflite |
| `tensorrt_linear` | TensorRT 最適化 | .trt |
| `memory` | LSTM 時系列モデル | .h5 |
| `imu` | 視覚 + IMU 統合 | .h5 |
| `behavior` | 行動認識モデル | .h5 |
| `localizer` | 位置推定モデル | .h5 |
| `3d_cnn` | 3D 畳み込みモデル | .h5 |

### 6.3 モデルとジョイスティックの併用

```bash
# ジョイスティック + モデル（手動介入可能）
python manage.py drive --model=models/mypilot.h5 --js
```

### 6.4 運転モードの切り替え

| モード | ステアリング | スロットル |
|--------|-------------|-----------|
| `user` | 手動 | 手動 |
| `local_angle` | AI | 手動 |
| `local` | AI | AI |

モード切り替え方法：
- Web UI: Mode ボタンをクリック
- ジョイスティック: 割り当てられたボタンを押す

### 6.5 AI スロットル調整

```python
# myconfig.py
AI_THROTTLE_MULT = 1.0              # AI スロットルの倍率
AI_LAUNCH_DURATION = 0.0            # AI ブースト持続時間
AI_LAUNCH_THROTTLE = 0.0            # AI ブーススロットル値
AI_LAUNCH_ENABLE_BUTTON = 'R2'      # ブースト有効化ボタン
```

---

## 7. キャリブレーションモード

### 7.1 PCA9685 キャリブレーション

```bash
# チャンネル 0（スロットル/ESC）のキャリブレーション
donkey calibrate --channel=0

# チャンネル 1（ステアリング/サーボ）のキャリブレーション
donkey calibrate --channel=1
```

### 7.2 PWM Pin 指定によるキャリブレーション

```bash
# PCA9685 のピン指定形式
donkey calibrate --pwm-pin="PCA9685.1:40.0"   # バス1、アドレス0x40、チャンネル0
donkey calibrate --pwm-pin="PCA9685.1:40.1"   # バス1、アドレス0x40、チャンネル1
```

### 7.3 キャリブレーション操作

キャリブレーション起動後、PWM 値を入力してテストします：

```
Enter a PWM setting to test ('q' for quit) (0-1500): 370
Enter a PWM setting to test ('q' for quit) (0-1500): 290
Enter a PWM setting to test ('q' for quit) (0-1500): 460
Enter a PWM setting to test ('q' for quit) (0-1500): q
```

### 7.4 キャリブレーション値の記録

測定した値を `myconfig.py` に反映：

```python
PWM_STEERING_THROTTLE = {
    "PWM_STEERING_PIN": "PCA9685.1:40.1",
    "PWM_STEERING_SCALE": 1.0,
    "PWM_STEERING_INVERTED": False,
    "PWM_THROTTLE_PIN": "PCA9685.1:40.0",
    "PWM_THROTTLE_SCALE": 1.0,
    "PWM_THROTTLE_INVERTED": False,

    # ステアリング値（キャリブレーション結果）
    "STEERING_LEFT_PWM": 460,         # 左いっぱい
    "STEERING_RIGHT_PWM": 290,        # 右いっぱい

    # スロットル値（キャリブレーション結果）
    "THROTTLE_FORWARD_PWM": 500,      # 最大前進
    "THROTTLE_STOPPED_PWM": 370,      # 停止
    "THROTTLE_REVERSE_PWM": 220,      # 最大後退
}
```

### 7.5 Web UI キャリブレーション

```bash
# calibrate.py で起動
python calibrate.py drive
```

ブラウザで `http://<ホスト名>.local:8887/calibrate` にアクセス。

---

## 8. データ収集・学習関連コマンド

### 8.1 データ収集（走行記録）

```bash
# 通常起動でデータ収集
python manage.py drive

# 録画開始: Web UI の Recording ボタン、またはジョイスティックの録画ボタン
# 録画停止: 同じ操作を繰り返す
```

データは `data/` ディレクトリに Tub 形式で保存されます。

### 8.2 データ収集設定

```python
# myconfig.py
AUTO_RECORD_ON_THROTTLE = True      # スロットル連動自動録画
AUTO_CREATE_NEW_TUB = True          # 起動ごとに新しい Tub を作成
RECORD_DURING_AI = False            # AI モード中の録画
```

### 8.3 モデル学習

#### ローカル学習（Raspberry Pi）

```bash
# 基本的な学習コマンド
python train.py --tubs=data/ --model=models/mypilot.h5

# モデルタイプ指定
python train.py --tubs=data/ --model=models/mypilot.h5 --type=linear

# 複数 Tub 指定
python train.py --tubs=data/tub_1,data/tub_2 --model=models/mypilot.h5
```

#### donkey train コマンド

```bash
donkey train --tubs=data/ --model=models/mypilot.h5 --type=linear
```

### 8.4 学習設定

```python
# myconfig.py
DEFAULT_AI_FRAMEWORK = 'tensorflow'   # tensorflow または pytorch
DEFAULT_MODEL_TYPE = 'linear'         # モデルタイプ
BATCH_SIZE = 128                      # バッチサイズ
TRAIN_TEST_SPLIT = 0.8                # 訓練/検証分割比
MAX_EPOCHS = 100                      # 最大エポック数
USE_EARLY_STOP = True                 # 早期停止
EARLY_STOP_PATIENCE = 5               # 早期停止の待機エポック数
CREATE_TF_LITE = True                 # TFLite モデルの自動生成
```

### 8.5 Tub データの可視化

```bash
# 予測プロット
donkey tubplot --tub=data/tub_1 --model=models/mypilot.h5

# ヒストグラム
donkey tubhist --tub=data/tub_1 --record=user/angle
```

### 8.6 動画作成

```bash
# Tub から動画作成
donkey makemovie --tub=data/tub_1 --out=movie.mp4

# モデル予測オーバーレイ
donkey makemovie --tub=data/tub_1 --model=models/mypilot.h5 --out=movie.mp4
```

### 8.7 最後の N 件レコード削除

ジョイスティックの特定ボタン（通常 X ボタン）で直近 100 件のレコードを削除できます（ミス走行の取り消し）。

---

## 9. トラブルシューティング

### 9.1 起動時のエラー

| 症状 | 原因 | 対処法 |
|------|------|--------|
| `ModuleNotFoundError` | 仮想環境が有効化されていない | `source ~/donkey_env/bin/activate` |
| `FileNotFoundError: config.py` | 作業ディレクトリが違う | `cd ~/picopico_racers/mycar` |
| `I2C Error` | PCA9685 接続不良 | `i2cdetect -y 1` で確認、配線チェック |
| `Camera Error` | カメラ未検出 | `libcamera-hello` でテスト |

### 9.2 Web UI 関連

| 症状 | 原因 | 対処法 |
|------|------|--------|
| 接続できない | ファイアウォール | `sudo ufw allow 8887` |
| 画像が表示されない | カメラエラー | カメラケーブルを確認 |
| 操作が遅延する | ネットワーク遅延 | 有線 LAN 使用を検討 |

### 9.3 ジョイスティック関連

| 症状 | 原因 | 対処法 |
|------|------|--------|
| 検出されない | デバイス未接続 | `ls /dev/input/js*` で確認 |
| 方向が逆 | 極性設定 | `JOYSTICK_THROTTLE_DIR` を変更 |
| ドリフトする | デッドゾーン不足 | `JOYSTICK_DEADZONE` を増やす |

### 9.4 自動運転関連

| 症状 | 原因 | 対処法 |
|------|------|--------|
| モデル読み込みエラー | ファイルパス間違い | 絶対パスで指定 |
| 推論が遅い | メモリ不足 | TFLite モデルを使用 |
| 直進しない | キャリブレーション不良 | 再キャリブレーション |

### 9.5 デバッグコマンド

```bash
# 詳細ログ出力
python manage.py drive 2>&1 | tee drive.log

# プロセス確認
ps aux | grep python

# メモリ使用量確認
free -h

# CPU 温度確認
vcgencmd measure_temp
```

---

## 10. クイックリファレンス（コマンド早見表）

### 10.1 起動コマンド

```bash
# 環境準備
ssh koito@192.168.50.3
source ~/donkey_env/bin/activate
cd ~/picopico_racers/mycar

# Web UI 起動
python manage.py drive

# ジョイスティック起動
python manage.py drive --js

# モデル起動
python manage.py drive --model=models/mypilot.h5

# 全オプション
python manage.py drive --model=models/mypilot.h5 --js --type=linear
```

### 10.2 キャリブレーション

```bash
# PCA9685 キャリブレーション
donkey calibrate --channel=0        # ESC/スロットル
donkey calibrate --channel=1        # サーボ/ステアリング

# PWM ピン指定
donkey calibrate --pwm-pin="PCA9685.1:40.0"
```

### 10.3 学習コマンド

```bash
# モデル学習
python train.py --tubs=data/ --model=models/mypilot.h5

# donkey コマンド
donkey train --tubs=data/ --model=models/mypilot.h5 --type=linear
```

### 10.4 ユーティリティ

```bash
# Tub 可視化
donkey tubplot --tub=data/tub_1 --model=models/mypilot.h5
donkey tubhist --tub=data/tub_1

# 動画作成
donkey makemovie --tub=data/tub_1 --out=movie.mp4

# カスタムジョイスティック作成
donkey createjs

# 車両検索
donkey findcar
```

### 10.5 設定ファイル（myconfig.py 最小構成）

```python
# ドライブトレイン
DRIVE_TRAIN_TYPE = "PWM_STEERING_THROTTLE"

PWM_STEERING_THROTTLE = {
    "PWM_STEERING_PIN": "PCA9685.1:40.1",
    "PWM_STEERING_SCALE": 1.0,
    "PWM_STEERING_INVERTED": False,
    "PWM_THROTTLE_PIN": "PCA9685.1:40.0",
    "PWM_THROTTLE_SCALE": 1.0,
    "PWM_THROTTLE_INVERTED": False,
    "STEERING_LEFT_PWM": 460,
    "STEERING_RIGHT_PWM": 290,
    "THROTTLE_FORWARD_PWM": 500,
    "THROTTLE_STOPPED_PWM": 370,
    "THROTTLE_REVERSE_PWM": 220,
}

# ジョイスティック
USE_JOYSTICK_AS_DEFAULT = True
CONTROLLER_TYPE = "xbox"
JOYSTICK_MAX_THROTTLE = 0.5
AUTO_RECORD_ON_THROTTLE = True
```

---

## 11. 運用チェックリスト

### 11.1 走行前チェック

- [ ] バッテリー残量確認
- [ ] SSH 接続確認
- [ ] 仮想環境アクティベート
- [ ] I2C デバイス認識確認 (`i2cdetect -y 1`)
- [ ] カメラ動作確認
- [ ] ジョイスティック接続確認（使用時）

### 11.2 データ収集チェック

- [ ] `data/` ディレクトリの空き容量確認
- [ ] `AUTO_CREATE_NEW_TUB = True` 設定
- [ ] 録画開始/停止の動作確認
- [ ] `JOYSTICK_MAX_THROTTLE` が適切な値

### 11.3 自動運転チェック

- [ ] モデルファイルの存在確認
- [ ] モデルタイプの指定確認
- [ ] `AI_THROTTLE_MULT` の設定確認
- [ ] 緊急停止操作の確認

---

## 12. 参考資料

### 12.1 公式ドキュメント

- [Donkey Car Documentation](https://docs.donkeycar.com/)
- [Donkey Car GitHub](https://github.com/autorope/donkeycar)

### 12.2 プロジェクト内資料

| 資料名 | パス |
|--------|------|
| M5C_JOYCON 統合ガイド | `docs/robotcar-engineer/20260129-1600_M5C_JOYCON_DonkeyCar統合ガイド.md` |
| PWM 動作調査レポート | `docs/robotcar-engineer/20260128-1730_PWM動作調査レポート.md` |
| キャリブレーション保存調査 | `docs/robotcar-engineer/20260128-1930_キャリブレーション値保存調査.md` |

### 12.3 ソースコード参照

| ファイル | 説明 |
|---------|------|
| `donkeycar/management/base.py` | donkey コマンド定義 |
| `donkeycar/templates/complete.py` | manage.py テンプレート |
| `donkeycar/parts/controller.py` | ジョイスティック制御 |
| `picopico_racers/mycar/myconfig.py` | 現在の設定ファイル |

---

## 13. 更新履歴

| 日付 | 内容 |
|------|------|
| 2026年1月29日 | 初版作成 |
