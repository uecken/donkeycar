# ジョイスティック値とPWM幅の関係

**作成日**: 2026年1月30日
**担当**: robotcar-engineer
**対象**: Donkey Car のジョイスティック入力からPWM出力への変換フロー

---

## 概要

このドキュメントでは、ジョイスティックの入力値がどのようにPWMパルス幅に変換されるかを解説する。

---

## 変換フロー全体図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ジョイスティック → PWM 変換フロー                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  【ジョイスティック入力】                                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ axis_val: -1.0 〜 +1.0 （スティック物理位置）                          │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                    │                              │                          │
│                    ▼                              ▼                          │
│  【JoystickController（controller.py）】                                     │
│  ┌────────────────────────────┐    ┌────────────────────────────────────┐   │
│  │ ステアリング計算            │    │ スロットル計算                      │   │
│  │ angle = steering_scale     │    │ throttle = throttle_dir            │   │
│  │         × axis_val         │    │           × axis_val               │   │
│  │                            │    │           × throttle_scale         │   │
│  │ 範囲: -1.0 〜 +1.0         │    │ 範囲: -1.0 〜 +1.0                 │   │
│  └────────────────────────────┘    └────────────────────────────────────┘   │
│                    │                              │                          │
│                    ▼                              ▼                          │
│  【PWMSteering / PWMThrottle（actuator.py）】                               │
│  ┌────────────────────────────┐    ┌────────────────────────────────────┐   │
│  │ map_range()でPWM値に変換   │    │ map_range()でPWM値に変換           │   │
│  │                            │    │                                    │   │
│  │ pulse = map_range(         │    │ if throttle > 0:                   │   │
│  │   angle,                   │    │   pulse = map_range(throttle,      │   │
│  │   -1, +1,                  │    │     0, 1, zero_pulse, max_pulse)   │   │
│  │   left_pulse, right_pulse) │    │ else:                              │   │
│  │                            │    │   pulse = map_range(throttle,      │   │
│  │                            │    │     -1, 0, min_pulse, zero_pulse)  │   │
│  └────────────────────────────┘    └────────────────────────────────────┘   │
│                    │                              │                          │
│                    ▼                              ▼                          │
│  【PWMコントローラー（PCA9685）】                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ PWM値（0〜4095）→ パルス幅（μs）                                      │   │
│  │                                                                       │   │
│  │ パルス幅 = PWM値 / 4096 × 周期（50Hz = 20000μs）                     │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 1. ステアリング（左右）の変換

### 1.1 JoystickController での計算

```python
# donkeycar/parts/controller.py line 1017
def set_steering(self, axis_val):
    self.angle = self.steering_scale * axis_val
```

| 変数 | 設定項目 | 範囲 | 説明 |
|------|---------|------|------|
| `axis_val` | （ジョイスティック入力） | -1.0 〜 +1.0 | スティックの物理位置 |
| `steering_scale` | `JOYSTICK_STEERING_SCALE` | -1.0 〜 +1.0 | 感度・反転設定 |
| `angle` | （出力） | -1.0 〜 +1.0 | PWMSteeringへの入力 |

### 1.2 PWMSteering での変換

```python
# donkeycar/parts/actuator.py line 313-318
def run_threaded(self, angle):
    angle = utils.clamp(angle, self.LEFT_ANGLE, self.RIGHT_ANGLE)  # -1 〜 +1 にクランプ
    self.pulse = dk.utils.map_range(angle,
                                    self.LEFT_ANGLE, self.RIGHT_ANGLE,   # -1, +1
                                    self.left_pulse, self.right_pulse)   # PWM値
```

### 1.3 map_range 関数

```python
# donkeycar/utils.py line 311-321
def map_range(x, X_min, X_max, Y_min, Y_max):
    '''
    Linear mapping between two ranges of values
    '''
    X_range = X_max - X_min
    Y_range = Y_max - Y_min
    XY_ratio = X_range / Y_range

    y = ((x - X_min) / XY_ratio + Y_min) // 1

    return int(y)
```

**数式**:
```
pulse = (angle - (-1)) / (1 - (-1)) × (right_pulse - left_pulse) + left_pulse
      = (angle + 1) / 2 × (right_pulse - left_pulse) + left_pulse
```

### 1.4 ステアリング計算例（HBX 2192）

**設定値**:
```python
STEERING_LEFT_PWM = 460
STEERING_RIGHT_PWM = 230
JOYSTICK_STEERING_SCALE = 1.0
```

| ジョイスティック | axis_val | angle | PWM値 | パルス幅（50Hz）|
|-----------------|----------|-------|-------|----------------|
| 左いっぱい | -1.0 | -1.0 | 460 | 2246μs |
| 中央 | 0.0 | 0.0 | 345 | 1684μs |
| 右いっぱい | +1.0 | +1.0 | 230 | 1123μs |

**パルス幅計算**:
```
パルス幅(μs) = PWM値 / 4096 × 20000μs
```

---

## 2. スロットル（前後）の変換

### 2.1 JoystickController での計算

```python
# donkeycar/parts/controller.py line 1021-1024
def set_throttle(self, axis_val):
    self.last_throttle_axis_val = axis_val
    self.throttle = (self.throttle_dir * axis_val * self.throttle_scale)
```

| 変数 | 設定項目 | 範囲 | 説明 |
|------|---------|------|------|
| `axis_val` | （ジョイスティック入力） | -1.0 〜 +1.0 | スティックの物理位置 |
| `throttle_dir` | `JOYSTICK_THROTTLE_DIR` | -1.0 or +1.0 | 方向反転 |
| `throttle_scale` | `JOYSTICK_MAX_THROTTLE` | 0.0 〜 1.0 | **最大速度制限** |
| `throttle` | （出力） | -1.0 〜 +1.0 | PWMThrottleへの入力 |

**重要**: `JOYSTICK_MAX_THROTTLE = 0.5` の場合、スティックを最大に倒しても `throttle = 0.5` までしか出力されない。

### 2.2 PWMThrottle での変換

```python
# donkeycar/parts/actuator.py line 368-375
def run_threaded(self, throttle):
    throttle = utils.clamp(throttle, self.MIN_THROTTLE, self.MAX_THROTTLE)  # -1 〜 +1
    if throttle > 0:
        self.pulse = dk.utils.map_range(throttle, 0, self.MAX_THROTTLE,
                                        self.zero_pulse, self.max_pulse)
    else:
        self.pulse = dk.utils.map_range(throttle, self.MIN_THROTTLE, 0,
                                        self.min_pulse, self.zero_pulse)
```

**重要**: 前進（throttle > 0）と後退（throttle < 0）で別々の範囲にマッピングされる。

### 2.3 スロットル計算式

**前進時（throttle > 0）**:
```
pulse = throttle / 1.0 × (max_pulse - zero_pulse) + zero_pulse
```

**後退時（throttle < 0）**:
```
pulse = (throttle - (-1)) / (0 - (-1)) × (zero_pulse - min_pulse) + min_pulse
      = (throttle + 1) × (zero_pulse - min_pulse) + min_pulse
```

### 2.4 スロットル計算例（HBX 2192）

**設定値**:
```python
THROTTLE_FORWARD_PWM = 330   # max_pulse（前進最大）
THROTTLE_STOPPED_PWM = 307   # zero_pulse（停止）
THROTTLE_REVERSE_PWM = 281   # min_pulse（後退最大）

JOYSTICK_MAX_THROTTLE = 0.5  # throttle_scale
JOYSTICK_THROTTLE_DIR = -1.0 # throttle_dir
```

#### JOYSTICK_MAX_THROTTLE = 1.0 の場合

| ジョイスティック | axis_val | throttle | PWM値 | パルス幅 |
|-----------------|----------|----------|-------|----------|
| 前進最大 | -1.0 | +1.0 | 330 | 1611μs |
| 停止 | 0.0 | 0.0 | 307 | 1499μs |
| 後退最大 | +1.0 | -1.0 | 281 | 1372μs |

#### JOYSTICK_MAX_THROTTLE = 0.5 の場合（50%制限）

| ジョイスティック | axis_val | throttle | PWM値 | パルス幅 |
|-----------------|----------|----------|-------|----------|
| 前進最大 | -1.0 | **+0.5** | 318 | 1553μs |
| 停止 | 0.0 | 0.0 | 307 | 1499μs |
| 後退最大 | +1.0 | **-0.5** | 294 | 1436μs |

**計算**:
```
前進50%: pulse = 0.5 / 1.0 × (330 - 307) + 307 = 318.5 ≈ 318
後退50%: pulse = (-0.5 + 1) × (307 - 281) + 281 = 0.5 × 26 + 281 = 294
```

---

## 3. PWM値とパルス幅の関係

### 3.1 PCA9685の計算式

PCA9685は12ビット（0〜4095）のPWM出力を持つ。

```
パルス幅(μs) = PWM値 / 4096 × 周期(μs)
```

50Hz（標準サーボ周波数）の場合:
```
周期 = 1 / 50Hz = 0.02秒 = 20000μs
パルス幅(μs) = PWM値 / 4096 × 20000 = PWM値 × 4.883
```

### 3.2 PWM値 ↔ パルス幅 換算表

| PWM値 | パルス幅(μs) | 用途例 |
|-------|-------------|--------|
| 205 | 1000μs | サーボ最小 |
| 307 | 1499μs | ニュートラル |
| 410 | 2002μs | サーボ最大 |
| 281 | 1372μs | ESC後退最大 |
| 330 | 1611μs | ESC前進最大 |

### 3.3 逆算式（パルス幅 → PWM値）

```
PWM値 = パルス幅(μs) / 20000 × 4096 = パルス幅 × 0.2048
```

| パルス幅(μs) | PWM値 |
|-------------|-------|
| 1000μs | 205 |
| 1500μs | 307 |
| 2000μs | 410 |

---

## 4. 設定項目の影響まとめ

### 4.1 ジョイスティック設定の効果

| 設定項目 | 効果 | PWMへの影響 |
|---------|------|------------|
| `JOYSTICK_STEERING_SCALE = 0.5` | ステアリング感度50% | PWM可動範囲が半分に |
| `JOYSTICK_STEERING_SCALE = -1.0` | 左右反転 | left_pulseとright_pulseが入れ替わった動作 |
| `JOYSTICK_MAX_THROTTLE = 0.5` | **最大速度50%** | max_pulse/min_pulseに到達しない |
| `JOYSTICK_THROTTLE_DIR = -1.0` | 前後反転 | スティック上が前進 |

### 4.2 PWM設定の効果

| 設定項目 | 効果 | パルス幅への影響 |
|---------|------|----------------|
| `STEERING_LEFT_PWM` | 左最大舵角 | 左いっぱい時のパルス幅 |
| `STEERING_RIGHT_PWM` | 右最大舵角 | 右いっぱい時のパルス幅 |
| `THROTTLE_FORWARD_PWM` | 前進最大速度 | throttle=1.0時のパルス幅 |
| `THROTTLE_STOPPED_PWM` | 停止（ニュートラル） | throttle=0時のパルス幅 |
| `THROTTLE_REVERSE_PWM` | 後退最大速度 | throttle=-1.0時のパルス幅 |

---

## 5. 実践的な設定ガイド

### 5.1 安全な初期設定

```python
# myconfig.py

# ジョイスティック設定
USE_JOYSTICK_AS_DEFAULT = True
CONTROLLER_TYPE = "rc3"
JOYSTICK_DEVICE_FILE = "/dev/input/js0"

# 感度設定（安全のため制限）
JOYSTICK_STEERING_SCALE = 1.0     # フル可動
JOYSTICK_MAX_THROTTLE = 0.3       # ★30%制限（初心者向け）
JOYSTICK_THROTTLE_DIR = -1.0      # スティック上が前進

# PWM設定（HBX 2192用）
PWM_STEERING_THROTTLE = {
    "STEERING_LEFT_PWM": 460,
    "STEERING_RIGHT_PWM": 230,
    "THROTTLE_FORWARD_PWM": 330,
    "THROTTLE_STOPPED_PWM": 307,
    "THROTTLE_REVERSE_PWM": 281,
}
```

### 5.2 速度制限の効果

`JOYSTICK_MAX_THROTTLE` による速度制限:

| 設定値 | throttle最大値 | PWM範囲（前進） | 実効パルス範囲 |
|--------|---------------|----------------|---------------|
| 1.0 | ±1.0 | 307〜330 | 1499〜1611μs |
| 0.5 | ±0.5 | 307〜318 | 1499〜1553μs |
| 0.3 | ±0.3 | 307〜314 | 1499〜1533μs |

### 5.3 トラブルシューティング

| 症状 | 原因 | 解決策 |
|------|------|--------|
| ステアリングが逆 | `JOYSTICK_STEERING_SCALE` の符号 | `-1.0` に変更 |
| 前後が逆 | `JOYSTICK_THROTTLE_DIR` の符号 | `1.0` に変更 |
| 速度が出ない | `JOYSTICK_MAX_THROTTLE` が低い | 値を上げる（最大1.0） |
| 急発進する | `JOYSTICK_MAX_THROTTLE` が高い | 値を下げる（0.3〜0.5推奨） |
| PWM範囲が狭い | キャリブレーション不足 | `donkey calibrate` で調整 |

---

## 6. デバッグ用コマンド

### 6.1 現在の設定確認

```bash
cd ~/mycar
python3 -c "
import donkeycar as dk
cfg = dk.load_config()
print('=== ジョイスティック設定 ===')
print('JOYSTICK_STEERING_SCALE:', cfg.JOYSTICK_STEERING_SCALE)
print('JOYSTICK_MAX_THROTTLE:', cfg.JOYSTICK_MAX_THROTTLE)
print('JOYSTICK_THROTTLE_DIR:', cfg.JOYSTICK_THROTTLE_DIR)
print()
print('=== PWM設定 ===')
print('STEERING_LEFT_PWM:', cfg.STEERING_LEFT_PWM)
print('STEERING_RIGHT_PWM:', cfg.STEERING_RIGHT_PWM)
print('THROTTLE_FORWARD_PWM:', cfg.THROTTLE_FORWARD_PWM)
print('THROTTLE_STOPPED_PWM:', cfg.THROTTLE_STOPPED_PWM)
print('THROTTLE_REVERSE_PWM:', cfg.THROTTLE_REVERSE_PWM)
"
```

### 6.2 PWM値計算スクリプト

```python
# PWM値からパルス幅を計算
def pwm_to_us(pwm_value, freq_hz=50):
    period_us = 1_000_000 / freq_hz  # 50Hz → 20000μs
    return pwm_value / 4096 * period_us

# パルス幅からPWM値を計算
def us_to_pwm(pulse_us, freq_hz=50):
    period_us = 1_000_000 / freq_hz
    return int(pulse_us / period_us * 4096)

# 使用例
print(f"PWM 307 → {pwm_to_us(307):.0f}μs")
print(f"1500μs → PWM {us_to_pwm(1500)}")
```

---

## 関連資料

| 資料名 | パス |
|--------|------|
| M5C_JOYCON動作問題調査 | `docs/robotcar-engineer/20260129-2100_M5C_JOYCON動作問題調査.md` |
| HBX2192制御調査 | `docs/robotcar-engineer/20260128-2010_HBX2192制御調査.md` |
| DonkeyCar起動ガイド | `docs/robotcar-engineer/20260129-1830_DonkeyCar起動ガイド.md` |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-30 00:10 | 初版作成 |
