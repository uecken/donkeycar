# HBX 2192 制御調査レポート

**作成日**: 2026年1月28日
**担当**: robotcar-engineer
**対象**: picopico_racersプロジェクト

---

## 目次

1. [HBX 2192 仕様概要](#1-hbx-2192-仕様概要)
2. [「動かないことがある」原因の推測](#2-動かないことがある原因の推測)
3. [Donkey CarからHBX 2192を制御する方法](#3-donkey-carからhbx-2192を制御する方法)
4. [HBX 2192の改造オプション](#4-hbx-2192の改造オプション)
5. [推奨アプローチ](#5-推奨アプローチ)
6. [モータードライバーの安全性比較](#6-モータードライバーの安全性比較)

---

## 1. HBX 2192 仕様概要

### 1.1 基本スペック

| 項目 | 仕様 |
|------|------|
| **ブランド** | HBX (Haiboxing) |
| **スケール** | 1/18 |
| **タイプ** | ドリフトカー |
| **駆動方式** | 4WD |
| **最高速度** | 35 km/h |
| **サイズ** | 25 x 10.5 x 6.8 cm |
| **ホイールベース** | 19 cm |
| **地上高** | 1.5 cm |
| **材質** | ABS、ナイロン、アルミ合金、電子部品 |

### 1.2 モーター・サーボ構成

**重要**: HBX 2192は**標準的なRCカー構成**です。

| コンポーネント | 数量 | 用途 |
|---------------|------|------|
| **RCモーター（ブラシモーター）** | 1つ | 前後移動（スロットル）用 |
| **サーボモーター** | 1つ | 左右ステアリング用 |

この構成は**差動2輪駆動（DC_TWO_WHEEL）ではありません**。Donkey Carでは以下のドライブトレインタイプが適切です:

- **PWM_STEERING_THROTTLE**: 標準ESC + サーボ構成
- **SERVO_HBRIDGE_2PIN**: サーボ + Hブリッジ2ピンモード
- **SERVO_HBRIDGE_3PIN**: サーボ + Hブリッジ3ピンモード

### 1.3 モーター仕様

| 項目 | 仕様 |
|------|------|
| **モーター型式** | RC370 強磁力ブラシモーター |
| **モータータイプ** | **ブラシ付きDCモーター** |
| **パーツ番号** | 29026（370 Motor + Motor Pinion セット） |
| **動作電圧** | 7.4V（バッテリー電圧） |

**370モーターの一般的な仕様**:
- 直径: 24mm
- シャフト径: 2mm
- 全長: 約45mm
- 電圧範囲: 3〜7.2VDC（標準）、最大12V
- 無負荷回転数: 約16,500〜21,000 RPM @ 6V
- 出力: 約2W

### 1.4 ESC仕様

| 項目 | 仕様 |
|------|------|
| **タイプ** | 30A 防水ESC（レシーバー一体型） |
| **防水規格** | IPX4（防滴） |
| **入力電圧** | 7.4V（2S LiPo/Li-ion） |
| **出力** | ブラシモーター用 |

**重要**: HBX 2192のESCはレシーバー（受信機）と一体型の「ESC/Receiver 2-in-1」基板であり、標準的なRCサーボ用PWM信号（1000〜2000μs）を入力できる独立したESCではない可能性が高い。

### 1.5 サーボ仕様

| 項目 | 仕様 |
|------|------|
| **タイプ** | 5線式サーボ（高性能） |
| **特徴** | ステアリング範囲が広い |
| **コネクタ** | 5ピン専用コネクタ |

**5線式サーボの特徴**:
- 標準的な3線式RCサーボ（信号・電源・GND）とは異なる
- 内蔵ジャイロとの連携、またはモーター+ポテンショメーターの直接接続の可能性
- HBXのドリフトカーには「外部制御可能なジャイロスコープ」が搭載されている

### 1.6 バッテリー仕様

| 項目 | 仕様 |
|------|------|
| **タイプ** | 7.4V 800mAh Li-ion バッテリー |
| **セル構成** | 2S（2セル直列） |
| **公称電圧** | 7.4V（3.7V × 2セル） |
| **満充電電圧** | **8.4V**（4.2V × 2セル） |
| **放電終止電圧** | 6.0V（3.0V × 2セル） |
| **充電時間** | 約180分 |
| **走行時間** | 約15分/充電 |

> **重要: モータードライバー選定時の注意**
> 2S LiPoバッテリーは満充電時に**8.4V**に達します。モータードライバーを選定する際は、この満充電電圧に対応できるICを選んでください。
> - **TC78H653FTG（最大7.5V）は非対応** - 満充電時に定格を超えてしまいます
> - **TC78H660FNG（最大16V）は対応** - 十分な余裕があります

### 1.7 受信機/送信機

| 項目 | 仕様 |
|------|------|
| **周波数** | 2.4GHz |
| **チャンネル** | 2チャンネル（ステアリング・スロットル） |
| **通信距離** | 60m |
| **送信機電源** | 単三電池 x 2本 |

### 1.8 その他の機能

- LEDライティングシステム（方向指示器、ブレーキランプ、走行灯をシミュレート）
- 金属製ドライブシャフト
- アルミリング付き金属スプリングショックアブソーバー
- 独立サスペンション
- ナイロン製トランスミッションシャフト

---

## 2. 「動かないことがある」原因の推測

### 2.1 最も可能性の高い原因

#### 2.1.1 5線式サーボの非互換性（最有力）

**問題**: HBX 2192の5線式サーボは、標準的な3線式RCサーボ（PWM信号で制御）とは異なる可能性が高い。

**5線式の構造**:
- 2線: DCモーター接続（+/-）
- 3線: ポテンショメーター（フィードバック用）

この場合、サーボは単なる「ギヤードDCモーター + 位置フィードバック」であり、**内蔵コントローラがない**。制御はESC/Receiver基板内の回路が担っている。

**PCA9685からのPWM信号を直接接続しても動作しない**理由:
- サーボ内部にPWMデコーダーがない
- 標準1000〜2000μsのパルス幅を理解できない

#### 2.1.2 ESC/Receiver一体型基板の問題

HBX 2192のESCはレシーバーと一体型であり:
- 標準的なESC入力端子（3ピンサーボコネクタ）がない可能性
- プロプライエタリなプロトコルを使用している可能性
- 外部からの制御信号を受け付けない設計

#### 2.1.3 ジャイロ統合の影響

HBX 2192はドリフトカーであり、「外部制御可能なジャイロスコープ」を搭載:
- ジャイロがステアリングサーボ信号を介入・補正
- ジャイロの設定によっては外部信号が無視される
- ジャイロのキャリブレーションが必要

### 2.2 PCA9685発振器問題との関連

以前の調査（20260128-1730_PWM動作調査レポート.md）で判明した問題:

| 問題 | 影響 |
|------|------|
| **クローンPCA9685の出力振幅** | 一部のクローン品はPWM出力が極端に低い（約5mV） |
| **発振器精度** | 内蔵発振器の精度により周波数がずれる |
| **電源ノイズ** | 不安定な電源でPWM信号にジッターが発生 |

**HBX 2192での影響**:
- もし5線式サーボが標準PWM対応だった場合、クローンPCA9685の低出力が原因の可能性
- ただし、5線式サーボ自体がPWM非対応の可能性が高い

### 2.3 ESCキャリブレーション問題

ESCのキャリブレーションがずれていると:

| 症状 | 原因 |
|------|------|
| **スロットルに無反応** | ニュートラル位置が認識されていない |
| **急発進** | フルスロットル位置のキャリブレーションずれ |
| **不安定な動作** | スロットルトリム/エンドポイントの不一致 |

**ESCキャリブレーション手順**（一般的なRC ESC）:
1. 送信機をON
2. フルスロットル状態で車両をON
3. 確認音/LED点滅を待つ
4. ニュートラルに戻す
5. 確認音/LED点滅で完了

### 2.4 電源・配線の問題

| 問題箇所 | 症状 |
|----------|------|
| **バッテリー電圧低下** | 低電圧保護で動作停止 |
| **コネクタの接触不良** | 間欠的に動作しない |
| **配線の断線** | 特定の動作のみ不可 |
| **GND未接続** | 信号が認識されない |

### 2.5 受信機・送信機の問題

| 問題 | 確認方法 |
|------|----------|
| **ペアリング未完了** | LEDインジケーター確認 |
| **周波数干渉** | 他の2.4GHz機器から離す |
| **送信機電池切れ** | 新品電池に交換 |
| **受信機故障** | 別の送信機でテスト |

---

## 3. Donkey CarからHBX 2192を制御する方法

### 3.1 構成オプション比較

| 構成 | 難易度 | コスト | 安定性 | 推奨度 |
|------|--------|--------|--------|--------|
| **A. 標準構成（ESC/サーボ交換）** | 中 | 中 | 高 | ★★★★★ |
| **B. Hブリッジ構成** | 高 | 低 | 高 | ★★★★☆ |
| **C. 既存ESC/サーボ流用** | 低 | 最低 | 低 | ★★☆☆☆ |

### 3.2 構成A: 標準Donkey Car構成（推奨）

ESCとサーボを標準的なRCパーツに交換し、PCA9685またはGPIO直接制御で制御。

#### 必要な交換パーツ

| パーツ | 推奨品 | 価格目安 |
|--------|--------|----------|
| **ESC** | Hobbywing QuicRun 1060 / HobbyKing 30A | 2,000〜3,000円 |
| **サーボ** | SG90 / MG90S（3線式標準サーボ） | 300〜500円 |

#### 配線

```
Raspberry Pi
    │
    └── I2C (GPIO 2,3)
            │
            └── PCA9685 (0x40)
                    ├── Ch0 ──→ ステアリングサーボ（3線式）
                    └── Ch1 ──→ ESC（スロットル）
                            │
                            └── モーター（370ブラシモーター流用可）
```

#### myconfig.py設定例

```python
# 標準構成: PCA9685経由
DRIVE_TRAIN_TYPE = "PWM_STEERING_THROTTLE"

# ステアリングキャリブレーション値
STEERING_CHANNEL = 0
STEERING_LEFT_PWM = 460
STEERING_RIGHT_PWM = 290

# スロットルキャリブレーション値
THROTTLE_CHANNEL = 1
THROTTLE_FORWARD_PWM = 500
THROTTLE_STOPPED_PWM = 370
THROTTLE_REVERSE_PWM = 240
```

### 3.3 構成B: Hブリッジ構成

ESCの代わりにHブリッジICでブラシモーターを直接制御。

#### 必要なパーツ

| パーツ | 推奨品 | 価格目安 |
|--------|--------|----------|
| **Hブリッジ** | TB6612FNG / L298N | 400〜600円 |
| **サーボ** | SG90 / MG90S（3線式） | 300〜500円 |

#### 配線（TB6612FNG）

```
Raspberry Pi
    ├── GPIO 18 (PWM0) ──→ サーボ信号
    ├── GPIO 13 (PWM1) ──→ TB6612FNG PWMA
    ├── GPIO 17 ──→ TB6612FNG AIN1
    ├── GPIO 27 ──→ TB6612FNG AIN2
    │
    └── TB6612FNG
            ├── AO1 ──→ モーター+
            └── AO2 ──→ モーター-
```

#### myconfig.py設定例

> **重要**: `SERVO_HBRIDGE_2PIN`はハードウェアPWMのみでは実現できません。
> GPIO 13とGPIO 19は同じPWM1チャンネルを共有するため、異なるPWM信号を出力できません。
> 代わりに`SERVO_HBRIDGE_3PIN`を使用してください。

```python
# Hブリッジ構成: サーボ + TB6612FNG（3ピンモード）
DRIVE_TRAIN_TYPE = "SERVO_HBRIDGE_3PIN"

SERVO_HBRIDGE_3PIN = {
    # ステアリングサーボ（GPIO18でハードウェアPWM0）
    "PWM_STEERING_PIN": "PIGPIO.BCM.18",
    "PWM_STEERING_SCALE": 1.0,
    "PWM_STEERING_INVERTED": False,
    "STEERING_LEFT_PWM": 460,
    "STEERING_RIGHT_PWM": 290,

    # スロットル（TB6612FNG 3ピンモード）
    "FWD_PIN": "RPI_GPIO.BCM.17",   # 正転方向（TTL出力）
    "BWD_PIN": "RPI_GPIO.BCM.27",   # 逆転方向（TTL出力）
    "DUTY_PIN": "PIGPIO.BCM.13",    # 速度PWM（ハードウェアPWM1）
}
# → ハードウェアPWM 2チャンネル + GPIO 2ピンでOK
```

### 3.4 構成C: 既存ESC/サーボ流用（非推奨）

既存のESC/Receiver一体型基板を流用しようとする場合。

#### 問題点

1. **5線式サーボの非互換性**: 標準PWM信号を理解しない可能性
2. **ESC入力端子の不在**: 外部制御信号を受け付けない設計
3. **プロプライエタリプロトコル**: 2.4GHz通信の独自仕様

#### 試行手順（もし試す場合）

1. ESC基板上のサーボ/モーター接続端子を特定
2. テスターで電圧・信号を確認
3. オシロスコープでPWM波形を観測
4. 同じ波形をPCA9685から出力して動作確認

**この構成は時間と労力の割に成功率が低いため、構成Aまたは構成Bを推奨。**

### 3.5 GPIO直接制御（PCA9685なし）

PCA9685を使わず、Raspberry PiのGPIOから直接制御する方法。

#### 利点

- PCA9685モジュール不要
- I2C通信のレイテンシーなし
- シンプルな配線

#### 制限

> **重要: ハードウェアPWMは2チャンネルのみ**
> - PWM0: GPIO 12 と GPIO 18 は**同じチャンネル**（同じ信号を出力）
> - PWM1: GPIO 13 と GPIO 19 は**同じチャンネル**（同じ信号を出力）
> - サーボ（PWM0）+ ESC/モーター速度（PWM1）で2チャンネルを使い切る
> - `SERVO_HBRIDGE_2PIN`（正転PWM + 逆転PWM）は実現不可能
> - 3チャンネル以上はソフトウェアPWMまたはPCA9685が必要

#### myconfig.py設定例

```python
# GPIO直接制御（PIGPIO使用）
DRIVE_TRAIN_TYPE = "PWM_STEERING_THROTTLE"

PWM_STEERING_PIN = "PIGPIO.BCM.18"     # ハードウェアPWM0
PWM_THROTTLE_PIN = "PIGPIO.BCM.13"     # ハードウェアPWM1

STEERING_LEFT_PWM = 460
STEERING_RIGHT_PWM = 290

THROTTLE_FORWARD_PWM = 500
THROTTLE_STOPPED_PWM = 370
THROTTLE_REVERSE_PWM = 240
```

---

## 4. HBX 2192の改造オプション

### 4.1 オプション1: 標準ESC/サーボをそのまま使う

**難易度**: 低
**成功確率**: 低〜中

#### 手順

1. ESC/Receiver基板の出力端子を調査
2. 標準PWM信号（1000〜2000μs、50Hz）を入力してテスト
3. 動作すれば流用、しなければ交換

#### 必要な調査

- 基板上のコネクタピンアサイン
- サーボ制御信号の仕様
- ESC入力信号の仕様

### 4.2 オプション2: ESCを交換

**難易度**: 中
**成功確率**: 高

#### 推奨ESC

| 製品 | 電流 | 特徴 | 価格 |
|------|------|------|------|
| **Hobbywing QuicRun 1060** | 60A | プログラマブル、ブラシモーター対応 | 3,000円 |
| **HobbyKing 30A Brushed** | 30A | 低コスト、シンプル | 1,500円 |
| **Generic Brushed ESC** | 30A | 最安価 | 500〜1,000円 |

#### 注意点

- **ブラシモーター用ESC**を選択（HBX 2192は370ブラシモーター）
- BEC（バッテリーエリミネーター回路）付きを推奨（サーボ電源供給）
- 7.4V（2S）対応を確認

### 4.3 オプション3: Hブリッジに置き換え

**難易度**: 中〜高
**成功確率**: 高

#### 推奨Hブリッジ

| 製品 | 電流 | 効率 | 特徴 | 価格 |
|------|------|------|------|------|
| **TB6612FNG** | 1.2A連続/3.2Aピーク | >90% | 3.3Vロジック対応、小型 | 400円 |
| **L298N** | 2A連続/3Aピーク | 40〜70% | 入手容易、ヒートシンク必要 | 300円 |
| **L9110S** | 0.8A連続 | 約85% | 超小型、低電流向け | 200円 |

#### 370モーターとの相性

- 370モーターの消費電流: 約0.3A（無負荷）〜1A（負荷時）
- **TB6612FNG（1.2A連続）で十分対応可能**
- L9110Sは電流不足の可能性あり

### 4.4 オプション4: サーボを交換

**難易度**: 低
**成功確率**: 高

#### 推奨サーボ

| 製品 | トルク | 速度 | 特徴 | 価格 |
|------|--------|------|------|------|
| **SG90** | 1.8kg.cm | 0.12s/60° | 超小型、プラギヤ | 300円 |
| **MG90S** | 2.2kg.cm | 0.1s/60° | 小型、メタルギヤ | 500円 |
| **MG996R** | 13kg.cm | 0.17s/60° | 大型、高トルク | 800円 |

#### 注意点

- HBX 2192のサーボマウントサイズを確認
- 1/18スケールには**SG90またはMG90S**が適合する可能性が高い
- 取り付けブラケットの加工が必要な場合あり

### 4.5 改造オプション比較

| オプション | 難易度 | コスト | 信頼性 | 推奨度 |
|-----------|--------|--------|--------|--------|
| 既存流用 | 低 | 0円 | 低 | ★★☆☆☆ |
| ESC交換 | 中 | 1,500〜3,000円 | 高 | ★★★★★ |
| Hブリッジ | 中〜高 | 400〜600円 | 高 | ★★★★☆ |
| サーボ交換 | 低 | 300〜500円 | 高 | ★★★★★ |

---

## 5. 推奨アプローチ

### 5.1 問題解決の優先順位

#### Step 1: 既存構成の診断（所要時間: 1〜2時間）

1. **送信機/受信機の動作確認**
   - 新品電池を装着
   - ペアリング状態を確認（LEDインジケーター）
   - 付属コントローラーでの動作テスト

2. **バッテリー電圧確認**
   - 充電状態を確認（7.4V以上あるか）
   - コネクタの接触不良をチェック

3. **配線の確認**
   - ESC/サーボの接続を確認
   - 断線や接触不良をチェック

#### Step 2: 5線式サーボの調査（所要時間: 2〜3時間）

1. **コネクタのピンアサイン調査**
   - 各線の電圧をテスターで確認
   - GND（黒）、電源（赤）、信号を特定

2. **オシロスコープで信号観測**（推奨）
   - 純正コントローラー使用時の信号波形を確認
   - PWM信号か、アナログ信号か判別

3. **PCA9685からの信号注入テスト**
   - 標準PWM（1500μs、50Hz）を送信
   - 動作するか確認

#### Step 3: 部品交換の判断（結果に応じて）

**結果A: 既存構成で動作した場合**
→ PCA9685のクローン品問題の可能性。正規品に交換または電圧レベルシフター追加

**結果B: 5線式サーボがPWM非対応の場合**
→ サーボ交換（推奨: MG90S）

**結果C: ESCが外部制御非対応の場合**
→ ESC交換（推奨: Hobbywing QuicRun 1060）またはHブリッジ構成へ

### 5.2 推奨構成（最終形）

**コストと信頼性のバランスを考慮した推奨構成**:

#### 構成A: ESC使用（最も簡単）

```
Raspberry Pi 4
    │
    ├── GPIO 18 (PWM0) ──→ MG90Sサーボ（交換品）
    │
    └── GPIO 13 (PWM1) ──→ ブラシESC（交換品）
                                │
                                └── 370モーター（既存流用）

※ ハードウェアPWM 2チャンネルでOK
```

#### 構成B: TB6612FNG使用（低コスト、推奨）

```
Raspberry Pi 4
    │
    ├── GPIO 18 (PWM0) ──→ MG90Sサーボ（交換品）
    │
    ├── GPIO 13 (PWM1) ──→ TB6612FNG PWMA（モーター速度）
    ├── GPIO 17 (TTL)  ──→ TB6612FNG AIN1（正転方向）
    └── GPIO 27 (TTL)  ──→ TB6612FNG AIN2（逆転方向）
                                │
                                └── 370モーター（既存流用）

※ ハードウェアPWM 2チャンネル + GPIO 2ピンでOK
```

#### 必要なパーツ

| パーツ | 製品 | 価格 |
|--------|------|------|
| サーボ | MG90S | 500円 |
| ESC | HobbyKing 30A Brushed ESC | 1,500円 |
| **合計** | | **2,000円** |

#### myconfig.py設定（構成A: ESC使用）

```python
# 推奨構成A: GPIO直接制御 + ESC
DRIVE_TRAIN_TYPE = "PWM_STEERING_THROTTLE"

PWM_STEERING_THROTTLE = {
    # ステアリング（GPIO18 ハードウェアPWM0）
    "PWM_STEERING_PIN": "PIGPIO.BCM.18",
    "PWM_STEERING_SCALE": 1.0,
    "PWM_STEERING_INVERTED": False,
    "STEERING_LEFT_PWM": 460,      # キャリブレーション必要
    "STEERING_RIGHT_PWM": 290,     # キャリブレーション必要

    # スロットル（GPIO13 ハードウェアPWM1）
    "PWM_THROTTLE_PIN": "PIGPIO.BCM.13",
    "PWM_THROTTLE_SCALE": 1.0,
    "PWM_THROTTLE_INVERTED": False,
    "THROTTLE_FORWARD_PWM": 500,   # キャリブレーション必要
    "THROTTLE_STOPPED_PWM": 370,   # キャリブレーション必要
    "THROTTLE_REVERSE_PWM": 240,   # キャリブレーション必要
}
```

#### myconfig.py設定（構成B: TB6612FNG使用、推奨）

```python
# 推奨構成B: GPIO直接制御 + TB6612FNG（3ピンモード）
DRIVE_TRAIN_TYPE = "SERVO_HBRIDGE_3PIN"

SERVO_HBRIDGE_3PIN = {
    # ステアリング（GPIO18 ハードウェアPWM0）
    "PWM_STEERING_PIN": "PIGPIO.BCM.18",
    "PWM_STEERING_SCALE": 1.0,
    "PWM_STEERING_INVERTED": False,
    "STEERING_LEFT_PWM": 460,      # キャリブレーション必要
    "STEERING_RIGHT_PWM": 290,     # キャリブレーション必要

    # スロットル（TB6612FNG 3ピンモード）
    "FWD_PIN": "RPI_GPIO.BCM.17",  # 正転方向（TTL）
    "BWD_PIN": "RPI_GPIO.BCM.27",  # 逆転方向（TTL）
    "DUTY_PIN": "PIGPIO.BCM.13",   # 速度PWM（ハードウェアPWM1）
}
```

### 5.3 コスト比較

| 構成 | サーボ | スロットル | 合計コスト |
|------|--------|-----------|-----------|
| **構成A: ESC使用** | MG90S (500円) | ブラシESC (1,500円) | **2,000円** |
| **構成B: TB6612FNG** | MG90S (500円) | TB6612FNG (400円) | **900円** |

**構成Bを推奨する理由**:
- 低コスト（ESCの約1/4の価格）
- TB6612FNGは安全機能内蔵（過電流、短絡、過熱、低電圧保護）
- 正転・逆転・ブレーキの細かい制御が可能
- 3.3Vロジック対応でRaspberry Piと直接接続可能

### 5.4 まとめ

| 優先度 | アクション | 目的 |
|--------|-----------|------|
| 1 | 既存構成の診断 | 交換が本当に必要か確認 |
| 2 | 5線式サーボの調査 | PWM互換性を確認 |
| 3 | サーボ交換（MG90S） | 確実な制御を実現 |
| 4 | ESC交換またはHブリッジ化 | スロットル制御を確立 |
| 5 | キャリブレーション | 最適な動作範囲を設定 |

---

## 6. モータードライバーの安全性比較

モータードライバーIC（L298N、TB6612FNG、DRV8835、TC78H660FNG等）の詳細な安全性比較については、以下の専門資料を参照してください：

**詳細資料**: [20260128-2100_モータードライバーIC調査.md](./20260128-2100_モータードライバーIC調査.md)

### 6.1 要約: HBX 2192への推奨

**推奨IC**: **TB6612FNG**、**DRV8835**、または **TC78H660FNG**

| IC | 価格 | 電圧範囲 | 2S LiPo対応 | 特徴 | 推奨度 |
|----|------|----------|------------|------|--------|
| **DRV8835** | 550円 | 2-11V | **○** | PHASE/ENABLEモードがSERVO_HBRIDGE_3PINに最適 | ★★★★☆ |
| **TC78H660FNG** | 110円 | 2.5-16V | **○** | 最安価、保護機能内蔵 | ★★★★★ |
| **TB6612FNG** | 180円 | 2.5-13.5V | **○** | 情報豊富、実績あり | ★★★★☆ |

> **警告: TC78H653FTGは2S LiPo非対応**
> TC78H653FTGの最大電圧は7.5Vのため、2S LiPoバッテリー（満充電8.4V）には使用**不可**です。
> 型番が似ているTC78H660FNG（最大16V）とは異なる製品です。

**選定理由**:
1. **1モーター + 1サーボ構成**に最適
2. **370モーターの電流（〜1A）**に対応可能
3. **3.3Vロジック対応**でRaspberry Piと直接接続可能
4. **高効率（>90%）**でバッテリー寿命向上

**具体的な実装手順**: [20260128-2130_DRV8835配線ガイド.md](./20260128-2130_DRV8835配線ガイド.md)

---

## 7. ハードウェアPWM + ソフトウェアPWM混在構成の検討

### 7.1 検討の背景

Raspberry Pi 4のハードウェアPWMは2チャンネルのみであり、`SERVO_HBRIDGE_2PIN`モード（サーボ用PWM + 前進PWM + 後退PWM = 3チャンネル必要）をハードウェアPWMのみで実現することはできない。

**提案された構成**:
- **サーボ制御**: ハードウェアPWM（GPIO 18, PWM0）
- **モーター前進**: ハードウェアPWM（GPIO 13, PWM1）
- **モーター後退**: ソフトウェアPWM（GPIO 19など）

この構成が実現可能かを検討する。

### 7.2 L298N_HBridge_2pinクラスの動作原理

`donkeycar/parts/actuator.py`の`L298N_HBridge_2pin`クラスを分析した結果:

```python
class L298N_HBridge_2pin(object):
    def __init__(self, pin_forward:PwmPin, pin_backward:PwmPin, ...):
        # 両方のピンはPwmPinとして初期化
        self.pin_forward = pin_forward
        self.pin_backward = pin_backward
        self.pin_forward.start(0)
        self.pin_backward.start(0)

    def run(self, throttle:float) -> None:
        if self.throttle > self.zero_throttle:
            # 前進時: 後退ピンは0、前進ピンにduty cycle
            self.pin_backward.duty_cycle(0)
            self.pin_forward.duty_cycle(self.throttle)
        elif self.throttle < -self.zero_throttle:
            # 後退時: 前進ピンは0、後退ピンにduty cycle
            self.pin_forward.duty_cycle(0)
            self.pin_backward.duty_cycle(-self.throttle)
        else:
            # 停止時: 両方0
            self.pin_forward.duty_cycle(0)
            self.pin_backward.duty_cycle(0)
```

**重要な特性**:
1. **排他的動作**: 前進PWMと後退PWMは**同時に出力されない**
2. **duty_cycle API**: 両ピンとも`PwmPin.duty_cycle()`メソッドで制御
3. **0〜1の範囲**: duty cycleは0（0%）〜1（100%）の浮動小数点値

### 7.3 Donkey Carのピン実装分析

`donkeycar/parts/pins.py`を分析した結果、異なるピンプロバイダーを混在させることが**可能**であることが確認された。

#### ピンプロバイダーの種類

| プロバイダー | 実装クラス | PWMタイプ | 特徴 |
|-------------|-----------|----------|------|
| `RPI_GPIO` | `PwmPinGpio` | ソフトウェアPWM | RPi.GPIO使用、任意ピン対応 |
| `PIGPIO` | `PwmPinPigpio` | ソフトウェアPWM | pigpioデーモン使用、任意ピン対応 |
| `PCA9685` | `PwmPinPCA9685` | ハードウェアPWM | I2C接続、16チャンネル |

#### PIGPIOのPWM実装

```python
class PwmPinPigpio(PwmPin):
    def start(self, duty: float = 0) -> None:
        self.pgpio = self.pgpio or pigpio.pi()
        self.pgpio.set_mode(self.pin_number, pigpio.OUTPUT)
        self.pgpio.set_PWM_frequency(self.pin_number, self.frequency)
        self.pgpio.set_PWM_range(self.pin_number, 4095)  # 12bit解像度
        self.pgpio.set_PWM_dutycycle(self.pin_number, int(duty * 4095))

    def duty_cycle(self, duty: float) -> None:
        self.pgpio.set_PWM_dutycycle(self.pin_number, int(duty * 4095))
```

**重要**: PIGPIOは`hardware_PWM()`と`set_PWM_dutycycle()`の2つのPWM出力方法を持つ:
- `hardware_PWM()`: GPIO 12/13/18/19のみ、ハードウェアPWM（高精度）
- `set_PWM_dutycycle()`: **任意のGPIOピン**、ソフトウェアPWM

現在のDonkey Car実装（`PwmPinPigpio`）は**`set_PWM_dutycycle()`を使用**している。これはソフトウェアPWMである。

### 7.4 ピンプロバイダー混在の可否

`pins.py`の設定コメントより:

> RPI_GPIO, PIGPIO and PCA9685 can be mixed arbitrarily, although it is discouraged to mix RPI_GPIO and PIGPIO.

つまり:
- **混在可能**: 異なるプロバイダーを同一構成で使用可能
- **非推奨**: RPI_GPIOとPIGPIOの混在は推奨されない（内部的な競合の可能性）
- **推奨**: 同一プロバイダーでの統一

### 7.5 技術的実現可能性の評価

#### 提案構成の実現可能性

```python
SERVO_HBRIDGE_2PIN = {
    "PWM_STEERING_PIN": "PIGPIO.BCM.18",  # サーボ（ソフトウェアPWM ※現実装）
    "FWD_DUTY_PIN": "PIGPIO.BCM.13",      # 前進（ソフトウェアPWM）
    "BWD_DUTY_PIN": "PIGPIO.BCM.19",      # 後退（ソフトウェアPWM）
}
```

**結論**: **技術的に実現可能**

理由:
1. `L298N_HBridge_2pin`クラスは`PwmPin`インターフェースのみを要求
2. `PwmPinPigpio`は任意のGPIOピンでソフトウェアPWMを提供
3. 前進/後退は排他的動作のため、同時に高精度PWMを必要としない

### 7.6 PIGPIOソフトウェアPWMの品質評価

#### pigpio set_PWM_dutycycle()の特性

| 項目 | 仕様 |
|------|------|
| **解像度** | デフォルト255段階、最大40000段階 |
| **周波数** | 40Hz〜8000Hz（ピン依存） |
| **ジッター** | 数μs程度（DMAベース） |
| **同時出力** | 最大32ピン |

pigpioのソフトウェアPWMは**DMA（Direct Memory Access）ベース**であり、通常のソフトウェアPWMよりも高精度である。

#### RPi.GPIO vs pigpio ソフトウェアPWMの比較

| 項目 | RPi.GPIO | pigpio |
|------|----------|--------|
| **方式** | タイマー割り込み | DMAバッファ |
| **ジッター** | 100μs〜数ms | 1〜5μs |
| **CPU負荷** | 高（割り込み処理） | 低（DMA転送） |
| **安定性** | システム負荷に依存 | 安定 |
| **評価** | モーター制御には**不十分** | **実用レベル** |

### 7.7 前進/後退の動作品質差

#### L298N_HBridge_2pinの排他的動作

`L298N_HBridge_2pin`クラスの動作ロジック:

| スロットル値 | 前進ピン | 後退ピン |
|-------------|---------|---------|
| > 0 (前進) | duty_cycle | 0 |
| < 0 (後退) | 0 | duty_cycle |
| = 0 (停止) | 0 | 0 |

**重要**: 前進と後退は**同時に動作しない**

#### ハードウェアPWM vs ソフトウェアPWM使用時の差

| 動作 | 使用ピン | PWMタイプ | 品質 |
|------|---------|----------|------|
| 前進 | GPIO 13 | ソフトウェアPWM (pigpio) | 高 |
| 後退 | GPIO 19 | ソフトウェアPWM (pigpio) | 高 |

**結論**: 現在のDonkey Car実装では、GPIO 13でもGPIO 19でも**両方ともソフトウェアPWM**を使用している。そのため、前進/後退で品質差は**発生しない**。

### 7.8 ハードウェアPWMを活用する方法

現在のDonkey Car実装（`PwmPinPigpio`）はソフトウェアPWMを使用しているが、pigpioの`hardware_PWM()`を使うことでハードウェアPWMを活用できる。

#### pigpioのハードウェアPWM API

```python
# ハードウェアPWM（GPIO 12/13/18/19のみ対応）
pi.hardware_PWM(gpio, frequency, dutycycle)
# dutycycleは0〜1000000（0〜100%を100万分率で指定）
```

**対応ピン**:
- PWM0: GPIO 12, GPIO 18
- PWM1: GPIO 13, GPIO 19

#### カスタム実装による最適化案

```python
class PwmPinPigpioHardware(PwmPin):
    """ハードウェアPWM対応ピン（GPIO 12/13/18/19専用）"""
    HARDWARE_PWM_PINS = {12, 13, 18, 19}

    def __init__(self, pin_number: int, frequency_hz: float = 50, pgpio=None):
        if pin_number not in self.HARDWARE_PWM_PINS:
            raise ValueError(f"GPIO {pin_number} does not support hardware PWM")
        self.pin_number = pin_number
        self.frequency = int(frequency_hz)
        self.pgpio = pgpio
        self._state = PinState.NOT_STARTED

    def start(self, duty: float = 0):
        self.pgpio = self.pgpio or pigpio.pi()
        self.pgpio.hardware_PWM(self.pin_number, self.frequency, int(duty * 1000000))
        self._state = duty

    def duty_cycle(self, duty: float):
        self.pgpio.hardware_PWM(self.pin_number, self.frequency, int(duty * 1000000))
        self._state = duty
```

しかし、**この実装はDonkey Car標準には含まれていない**。

### 7.9 結論と推奨

#### 技術的結論

| 項目 | 判定 | 理由 |
|------|------|------|
| **技術的実現可能性** | **○ 可能** | Donkey Carのピンプロバイダー設計で混在対応 |
| **実用性** | **○ 実用的** | pigpioのDMAベースソフトウェアPWMは十分な精度 |
| **前進/後退の品質差** | **○ 差なし** | 排他動作のため、同時使用なし |
| **推奨度** | **△ 条件付き推奨** | 動作はするが、SERVO_HBRIDGE_3PINの方がシンプル |

#### SERVO_HBRIDGE_2PIN vs SERVO_HBRIDGE_3PIN比較

| 項目 | SERVO_HBRIDGE_2PIN | SERVO_HBRIDGE_3PIN |
|------|-------------------|-------------------|
| **必要PWM** | 3チャンネル | 2チャンネル |
| **必要GPIO** | 0（PWMのみ） | 2（方向制御用TTL） |
| **実装複雑性** | 高（3PWM管理） | 低（2PWM + 2TTL） |
| **ハードウェアPWM対応** | 困難（2ch制限） | **容易**（2chで足りる） |
| **モータードライバー互換性** | L9110S等の2pin専用 | TB6612FNG等の3pin対応 |

#### 最終推奨

**SERVO_HBRIDGE_3PINを推奨する**

理由:
1. ハードウェアPWM 2チャンネルで完結
2. 方向制御はTTL（HIGH/LOW）で十分
3. TB6612FNG、DRV8835等の一般的なモータードライバーと相性が良い
4. 設定・デバッグがシンプル

**SERVO_HBRIDGE_2PINを選択する場合**:
- L9110S/HG7881など2pin専用ドライバーを使用する場合
- pigpioのソフトウェアPWMで十分な精度が得られる場合

#### 設定例（参考: SERVO_HBRIDGE_2PIN + ソフトウェアPWM混在）

```python
# SERVO_HBRIDGE_2PIN（ソフトウェアPWM混在構成）
# 注意: この構成は動作しますが、SERVO_HBRIDGE_3PINを推奨
DRIVE_TRAIN_TYPE = "SERVO_HBRIDGE_2PIN"

SERVO_HBRIDGE_2PIN = {
    # ステアリング（GPIO18: pigpioソフトウェアPWM）
    "PWM_STEERING_PIN": "PIGPIO.BCM.18",
    "PWM_STEERING_SCALE": 1.0,
    "PWM_STEERING_INVERTED": False,
    "STEERING_LEFT_PWM": 460,
    "STEERING_RIGHT_PWM": 290,

    # モーター前進（GPIO13: pigpioソフトウェアPWM）
    "FWD_DUTY_PIN": "PIGPIO.BCM.13",
    # モーター後退（GPIO19: pigpioソフトウェアPWM）
    "BWD_DUTY_PIN": "PIGPIO.BCM.19",
}
```

**注意**: 上記構成では、GPIO 13とGPIO 19は**同じハードウェアPWMチャンネル（PWM1）を共有**するが、現在のDonkey Car実装（`PwmPinPigpio`）は**ソフトウェアPWM**を使用するため、**問題なく動作する**。

---

## 関連資料

このレポートと関連する他の調査資料：

| 資料名 | 内容 | リンク |
|--------|------|--------|
| GPIO直接制御調査 | GPIO制御の全体像、Donkey Car対応状況 | [20260128-2000_GPIO直接制御調査.md](./20260128-2000_GPIO直接制御調査.md) |
| モータードライバーIC調査 | IC比較・選定・安全性の詳細 | [20260128-2100_モータードライバーIC調査.md](./20260128-2100_モータードライバーIC調査.md) |
| DRV8835配線ガイド | 具体的な実装手順 | [20260128-2130_DRV8835配線ガイド.md](./20260128-2130_DRV8835配線ガイド.md) |
| PWM動作調査レポート | PCA9685の問題点 | [20260128-1730_PWM動作調査レポート.md](./20260128-1730_PWM動作調査レポート.md) |

---

## 参考資料

### HBX 2192 関連

- [HBX 2192 Banggood製品ページ](https://usa.banggood.com/HBX-2192-2193-1-or-18-2_4G-4WD-RC-Car-Drift-LED-Light-High-Speed-Racing-RTR-Vehicles-Models-Full-Propotional-Control-Electric-Toys-p-2006818.html)
- [Haiboxing RC Car Parts 29026 Motor](https://www.haiboxingtoys.com/hbx-2192-2193-2195-parts-upgrade-parts/5525-haiboxing-hbx-2192-2193-2195-parts-motor-29026.html)
- [HBX 2192 2193 2195 Parts Catalog](https://www.haiboxingtoys.com/282-hbx-2192-2193-2195-parts-upgrade-parts)

### 370モーター関連

- [370 Motor Specification (Handsontec PDF)](https://www.handsontec.com/dataspecs/motor_fan/370-Motor.pdf)
- [370 vs 380 Motor Comparison](https://majesticrc.com/370-vs-380-motor/)

### Donkey Car関連

- [Donkey Car Actuators Documentation](https://docs.donkeycar.com/parts/actuators/)
- [Donkey Car Calibration Guide](https://docs.donkeycar.com/guide/calibrate/)
- [Donkey Car Pin Configuration](https://docs.donkeycar.com/parts/pins/)

### ESC/トラブルシューティング

- [RC Car Not Responding to Throttle](https://www.goodiesrc.com/rc-car-not-responding-to-throttle-heres-why/)
- [RC Car ESC Calibration](https://www.rcneeds.com/rc-car-not-responding-to-throttle/)

### PCA9685関連

- [PCA9685 Servo Driver Guide (Adafruit)](https://cdn-learn.adafruit.com/downloads/pdf/16-channel-pwm-servo-driver.pdf)
- [PCA9685 Issues with Clone Boards (Arduino Forum)](https://forum.arduino.cc/t/problem-with-pca9685-16-channel-servo-driver/889397)

### モータードライバー安全性関連

- [TB6612FNG Motor Driver: Better Than the L298N? (Hackster.io)](https://www.hackster.io/news/tb6612fng-motor-driver-better-than-the-l298n-7499a7574e63)
- [TB6612FNG H-Bridge with Arduino (DroneBot Workshop)](https://dronebotworkshop.com/tb6612fng-h-bridge/)
- [L298N Motor Driver Board – Drive Modes (DPRG)](https://www.dprg.org/l298n-motor-driver-board-drive-modes/)
- [L298N Brake State (Arduino Forum)](https://forum.arduino.cc/t/l298n-brake-state/575263)
- [L298N Short-circuit protection (Electro-Tech-Online)](https://www.electro-tech-online.com/threads/l298-short-circuit-protection.42989/)
- [Over Current Protection for Motor Driver L298 (EEVblog Forum)](https://www.eevblog.com/forum/projects/over-current-protection-for-motor-driver(l298)/)
- [Raspberry Pi killed by L298N (Raspberry Pi Forums)](https://forums.raspberrypi.com/viewtopic.php?t=99733)

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026年1月28日 | 初版作成 |
| 2026年1月28日 | HBX 2192が1モーター + 1サーボ構成であることを明記 |
| 2026年1月28日 | **重要な修正**: ハードウェアPWM 2チャンネル制限を明記。SERVO_HBRIDGE_3PINを推奨構成として整理 |
| 2026年1月28日 | 資料整理: 安全性比較を簡略化し、詳細はモータードライバーIC調査を参照。関連資料セクション追加 |
| 2026年1月28日 | **重要な修正**: 2S LiPoバッテリー電圧（満充電8.4V）に関する注意事項を追記。TC78H653FTG（最大7.5V）は2S LiPo非対応であることを明記 |
| 2026年1月28日 | ハードウェアPWM + ソフトウェアPWM混在構成の検討セクションを追加。L298N_HBridge_2pinの動作原理、PIGPIOソフトウェアPWMの品質評価、SERVO_HBRIDGE_2PIN vs 3PIN比較を記載 |
