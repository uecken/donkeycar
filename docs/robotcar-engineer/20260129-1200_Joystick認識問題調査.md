# Joystick認識問題調査報告

**作成日**: 2026年1月29日
**最終更新**: 2026年1月29日 19:30
**調査対象**: M5C_JOYCON が Donkey Car で制御できない問題
**ステータス**: **解決済み**

## 原因（結論）

**`myconfig.py` で `USE_JOYSTICK_AS_DEFAULT = False` が設定されていた。**

```bash
(env) koito@donkey10:~/mycar $ python3 -c "import myconfig; print(myconfig.USE_JOYSTICK_AS_DEFAULT)"
False
```

これにより、`--js` フラグなしで起動した場合、ジョイスティックコントローラーが追加されなかった。

---

## 問題の概要

### 症状
- `jstest /dev/input/js0` は成功（ジョイスティックはLinuxレベルで認識されている）
- `python manage.py drive` を実行してもJoystickControllerが追加されていない
- ログに `Adding part XboxOneJoystickController` などのジョイスティック関連のメッセージがない

### 実際の設定（myconfig.py）
```python
USE_JOYSTICK_AS_DEFAULT = False  # <- これが原因
CONTROLLER_TYPE = "xbox"
```

## 調査結果

### 1. コードフロー分析

#### manage.py の動作
1. `drive()` 関数が `use_joystick=args['--js']` で呼び出される
2. `--js` フラグなしで起動した場合、`use_joystick` は `None`（falsy）
3. `add_user_controller()` 内で以下の条件が評価される：

```python
# manage.py line 710
if use_joystick or cfg.USE_JOYSTICK_AS_DEFAULT:
    # ジョイスティックコントローラーを追加
```

この条件が True の場合のみ、ジョイスティックが追加される。

#### get_js_controller() の動作
```python
# controller.py line 1706-1738
def get_js_controller(cfg):
    if cfg.CONTROLLER_TYPE == "xbox":
        cont_class = XboxOneJoystickController
    # ...
    ctr = cont_class(
        throttle_dir=cfg.JOYSTICK_THROTTLE_DIR,
        throttle_scale=cfg.JOYSTICK_MAX_THROTTLE,
        steering_scale=cfg.JOYSTICK_STEERING_SCALE,
        auto_record_on_throttle=cfg.AUTO_RECORD_ON_THROTTLE,
        dev_fn=cfg.JOYSTICK_DEVICE_FILE)
    return ctr
```

### 2. 考えられる原因

#### 原因1: 設定ファイルのパス問題（最も可能性が高い）

**問題**: Raspberry Pi上で `~/mycar` と `~/picopico_racers/mycar` の2つのディレクトリが存在する可能性がある。

ログに「mycarパス: `~/mycar`」とある場合、実際に使用されているのは `~/mycar` であり、`picopico_racers/mycar` の設定は適用されていない。

**確認方法**:
```bash
ssh koito@192.168.50.3
cat ~/mycar/myconfig.py | grep -E "USE_JOYSTICK|CONTROLLER_TYPE"
```

#### 原因2: myconfig.py のシンタックスエラー

**問題**: myconfig.py にシンタックスエラーがあると、設定が読み込まれず、config.py のデフォルト値が使用される。

**確認方法**:
```bash
ssh koito@192.168.50.3
cd ~/mycar
python3 -c "import myconfig; print(myconfig.USE_JOYSTICK_AS_DEFAULT)"
```

#### 原因3: config.py の USE_JOYSTICK_AS_DEFAULT が False

**問題**: `~/mycar/config.py` の `USE_JOYSTICK_AS_DEFAULT` が `False` に設定されている可能性。

picopico_racers/mycar/config.py では line 563 で `USE_JOYSTICK_AS_DEFAULT = True` だが、別のconfig.pyを使用している可能性。

**確認方法**:
```bash
ssh koito@192.168.50.3
cat ~/mycar/config.py | grep USE_JOYSTICK_AS_DEFAULT
```

#### 原因4: JOYSTICK_DEVICE_FILE の設定不足

**問題**: `myconfig.py` で `JOYSTICK_DEVICE_FILE` が設定されていない場合、`config.py` のデフォルト値 `/dev/input/js0` が使用される。これは正しいが、明示的に設定することを推奨。

### 3. XboxOneJoystick と M5C_JOYCON の互換性

M5C_JOYCON は Xbox コントローラーとして認識されているが、ボタン/軸のマッピングが異なる可能性がある。

XboxOneJoystick のデフォルトマッピング：
```python
axis_names = {
    0x00 : 'left_stick_horz',
    0x01 : 'left_stick_vert',
    0x05 : 'right_stick_vert',
    0x02 : 'right_stick_horz',
    0x0a : 'left_trigger',
    0x09 : 'right_trigger',
    0x10 : 'dpad_horiz',
    0x11 : 'dpad_vert'
}

button_names = {
    0x130: 'a_button',
    0x131: 'b_button',
    0x133: 'x_button',
    0x134: 'y_button',
    0x13b: 'options',
    0x136: 'left_shoulder',
    0x137: 'right_shoulder',
}
```

## 解決策

### Step 1: 設定の確認と修正

Raspberry Pi で以下のコマンドを実行して、現在の設定を確認：

```bash
ssh koito@192.168.50.3
cd ~/mycar

# 設定を確認
python3 -c "
import donkeycar as dk
cfg = dk.load_config()
print('USE_JOYSTICK_AS_DEFAULT:', cfg.USE_JOYSTICK_AS_DEFAULT)
print('CONTROLLER_TYPE:', cfg.CONTROLLER_TYPE)
print('JOYSTICK_DEVICE_FILE:', cfg.JOYSTICK_DEVICE_FILE)
"
```

### Step 2: myconfig.py の修正

`~/mycar/myconfig.py` に以下の設定を追加または確認：

```python
# ジョイスティック設定
USE_JOYSTICK_AS_DEFAULT = True
CONTROLLER_TYPE = "xbox"
JOYSTICK_DEVICE_FILE = "/dev/input/js0"

# スロットル設定
JOYSTICK_MAX_THROTTLE = 1.0
JOYSTICK_STEERING_SCALE = 1.0
JOYSTICK_THROTTLE_DIR = -1.0
JOYSTICK_DEADZONE = 0.01
AUTO_RECORD_ON_THROTTLE = False
```

### Step 3: 明示的に --js フラグで起動

設定の問題を回避するため、明示的に `--js` フラグを使用：

```bash
cd ~/mycar
python manage.py drive --js
```

### Step 4: デバッグログの有効化

問題が続く場合、ログレベルを DEBUG に変更して詳細情報を取得：

```python
# myconfig.py に追加
LOGGING_LEVEL = 'DEBUG'
```

### Step 5: カスタムコントローラーの作成（必要に応じて）

M5C_JOYCON のマッピングが Xbox と異なる場合、カスタムコントローラーを作成：

```bash
donkey createjs
```

これにより `my_joystick.py` が作成され、ボタン/軸のマッピングをカスタマイズできる。

## 追加調査事項

### jstest の出力確認

```bash
jstest /dev/input/js0
```

の出力から、以下を確認：
- 軸の数とインデックス
- ボタンの数とインデックス
- 各軸/ボタンの動作範囲

### evtest による詳細確認

```bash
sudo apt install evtest
sudo evtest /dev/input/event*  # js0に対応するeventデバイスを選択
```

## 結論

**原因特定**: `~/mycar/myconfig.py` で `USE_JOYSTICK_AS_DEFAULT = False` が設定されていたことが原因。

---

## Donkey Car 設定ファイル読み込みの仕組み

### 設定ファイルの読み込み順序

Donkey Car は `donkeycar/config.py` の `load_config()` 関数で設定を読み込む。

```
1. config.py（ベース設定）を読み込み
   ↓
2. myconfig.py（ユーザー設定）が存在すれば上書き
   ↓
3. 最終的な設定オブジェクトを返す
```

#### ソースコード（donkeycar/config.py）
```python
def load_config(config_path=None, myconfig="myconfig.py"):
    # 1. config.py を読み込み
    cfg = Config()
    cfg.from_pyfile(config_path)

    # 2. myconfig.py があれば上書き
    personal_cfg_path = config_path.replace("config.py", myconfig)
    if os.path.exists(personal_cfg_path):
        personal_cfg = Config()
        personal_cfg.from_pyfile(personal_cfg_path)
        cfg.from_object(personal_cfg)  # <- myconfig の値で上書き

    return cfg
```

### 重要なポイント

1. **myconfig.py が優先**: config.py で `True` でも、myconfig.py で `False` なら `False` になる
2. **大文字の変数のみ**: 設定として認識されるのは大文字のみ（`USE_JOYSTICK_AS_DEFAULT` など）
3. **シンタックスエラー時**: myconfig.py にエラーがあると読み込まれず、config.py の値が使われる

### ディレクトリ構成（Raspberry Pi）

```
~/mycar           <- 現在使用中のDonkey Carディレクトリ
  ├── config.py   <- ベース設定（donkey createcar で生成）
  ├── myconfig.py <- ユーザー設定（ここを編集する）
  └── manage.py
~/donkeycar       <- Donkey Carソースコード
~/env             <- 仮想環境
```

---

## 設定確認コマンド

Raspberry Pi で以下のコマンドを実行して設定を確認できる。

### 1. myconfig.py の直接確認

```bash
cd ~/mycar
python3 -c "import myconfig; print('USE_JOYSTICK_AS_DEFAULT:', myconfig.USE_JOYSTICK_AS_DEFAULT)"
```

### 2. Donkey Car が読み込む最終設定の確認

```bash
cd ~/mycar
python3 -c "
import donkeycar as dk
cfg = dk.load_config()
print('=== Joystick Settings ===')
print('USE_JOYSTICK_AS_DEFAULT:', cfg.USE_JOYSTICK_AS_DEFAULT)
print('CONTROLLER_TYPE:', cfg.CONTROLLER_TYPE)
print('JOYSTICK_DEVICE_FILE:', cfg.JOYSTICK_DEVICE_FILE)
print('JOYSTICK_MAX_THROTTLE:', cfg.JOYSTICK_MAX_THROTTLE)
print('JOYSTICK_STEERING_SCALE:', cfg.JOYSTICK_STEERING_SCALE)
print('JOYSTICK_THROTTLE_DIR:', cfg.JOYSTICK_THROTTLE_DIR)
print('AUTO_RECORD_ON_THROTTLE:', cfg.AUTO_RECORD_ON_THROTTLE)
"
```

### 3. 全設定の表示

```bash
cd ~/mycar
python3 -c "
import donkeycar as dk
cfg = dk.load_config()
cfg.show()
" | grep -i joystick
```

---

## 解決方法

### 方法1: myconfig.py を直接編集

```bash
# Raspberry Pi で実行
cd ~/mycar
nano myconfig.py
```

以下の行を追加または修正:

```python
# ジョイスティック設定
USE_JOYSTICK_AS_DEFAULT = True
CONTROLLER_TYPE = "xbox"
JOYSTICK_DEVICE_FILE = "/dev/input/js0"
```

### 方法2: sed で一括変更（コピペで実行可能）

```bash
# Raspberry Pi で実行
cd ~/mycar

# USE_JOYSTICK_AS_DEFAULT = False を True に変更
sed -i 's/USE_JOYSTICK_AS_DEFAULT\s*=\s*False/USE_JOYSTICK_AS_DEFAULT = True/' myconfig.py

# 変更を確認
grep USE_JOYSTICK_AS_DEFAULT myconfig.py
```

### 方法3: Python で設定変更

```bash
cd ~/mycar
python3 << 'EOF'
# myconfig.py を読み込んで修正
with open('myconfig.py', 'r') as f:
    content = f.read()

# USE_JOYSTICK_AS_DEFAULT を True に変更
import re
content = re.sub(
    r'USE_JOYSTICK_AS_DEFAULT\s*=\s*False',
    'USE_JOYSTICK_AS_DEFAULT = True',
    content
)

with open('myconfig.py', 'w') as f:
    f.write(content)

print("myconfig.py updated successfully")
EOF
```

### 方法4: 起動時に --js フラグを使用（設定変更不要）

```bash
cd ~/mycar
python manage.py drive --js
```

`--js` フラグを指定すると、`USE_JOYSTICK_AS_DEFAULT` の値に関係なくジョイスティックが有効になる。

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-29 | 初版作成 |
| 2026-01-29 19:30 | 原因特定: USE_JOYSTICK_AS_DEFAULT = False が原因。設定ファイル読み込みの仕組みと解決方法を追記 |
