# PCA9685キャリブレーション値保存調査レポート

**作成日**: 2026年1月28日
**担当**: robotcar-engineer
**調査テーマ**: PCA9685のキャリブレーション値（reference_clock_speed等）の保存機構

---

## 1. 調査概要

### 調査目的
PCA9685のキャリブレーション値（特に`reference_clock_speed`）が保存されるようになっているか調査する。

### 調査対象
1. picopico_racersのテストコード
2. Donkey Car本体のPCA9685関連コード
3. Adafruit PCA9685ライブラリ
4. PCA9685ハードウェア仕様

---

## 2. 調査結果

### 2.1 picopico_racersのテストコード

#### 調査対象ファイル
| ファイル | パス |
|----------|------|
| servo_test.py | `picopico_racers/test_codes/` |
| motor_esc_test.py | `picopico_racers/test_codes/` |
| servo_sweep_test.py | `picopico_racers/test_codes/` |
| servo_test.py | `picopico_racers/` |
| motor_esc_test.py | `picopico_racers/` |

#### 結論: キャリブレーション値の保存機能なし

テストコードの現状:

```python
# picopico_racers/test_codes/motor_esc_test.py
i2c = busio.I2C(SCL, SDA)
pca = PCA9685(i2c)
pca.frequency = 50  # 固定値、キャリブレーションなし
```

**問題点**:
- `reference_clock_speed`の設定なし
- PWM値（1370us, 1500us等）はハードコードされている
- キャリブレーション結果を保存する仕組みがない
- 毎回手動でコードを編集する必要がある

---

### 2.2 picopico_racers/mycar/myconfig.py

#### 現状の設定

```python
PWM_STEERING_THROTTLE = {
    "PWM_STEERING_PIN": "PCA9685.1:40.1",
    "PWM_STEERING_SCALE": 1.0,              # 周波数補正用（60hz基準）
    "PWM_STEERING_INVERTED": False,
    "PWM_THROTTLE_PIN": "PCA9685.1:40.0",
    "PWM_THROTTLE_SCALE": 1.0,
    "PWM_THROTTLE_INVERTED": False,
    "STEERING_LEFT_PWM": 460,
    "STEERING_RIGHT_PWM": 230,
    "THROTTLE_FORWARD_PWM": 324,            # 1370us相当
    "THROTTLE_STOPPED_PWM": 307,            # 1500us相当
    "THROTTLE_REVERSE_PWM": 287,            # 1610us相当
}
```

#### 結論: PWM値は保存されるが、reference_clock_speedの設定項目がない

**設定可能な項目**:
- `STEERING_LEFT_PWM`, `STEERING_RIGHT_PWM` - ステアリングのPWM値
- `THROTTLE_*_PWM` - スロットルのPWM値
- `PWM_*_SCALE` - 周波数補正係数

**設定不可能な項目**:
- `reference_clock_speed` - 発振器周波数
- PCA9685のprescale値の直接指定

---

### 2.3 Donkey Car本体のPCA9685関連コード

#### 2.3.1 `donkeycar/parts/pins.py` - PCA9685クラス

```python
class PCA9685:
    '''Pin controller using PCA9685 boards.'''
    def __init__(self, busnum: int, address: int, frequency: int):
        import Adafruit_PCA9685
        # ...
        self.pwm = Adafruit_PCA9685.PCA9685(address=address)
        self.pwm.set_pwm_freq(frequency)  # frequencyのみ設定可能
        self._frequency = frequency
```

**結論**: Donkey Carの`pins.py`は`reference_clock_speed`をサポートしていない

#### 2.3.2 `donkeycar/parts/actuator.py` - 非推奨PCA9685クラス

```python
@deprecated("Deprecated in favor or PulseController...")
class PCA9685:
    def __init__(self, channel, address=0x40, frequency=60, busnum=None, init_delay=0.1):
        self.default_freq = 60
        self.pwm_scale = frequency / self.default_freq  # スケール補正
        # ...
        self.pwm.set_pwm_freq(frequency)
```

**結論**: こちらも`reference_clock_speed`非対応。`pwm_scale`で間接的に補正する設計。

#### 2.3.3 `donkeycar/management/base.py` - calibrateコマンド

```python
class CalibrateCar(BaseCommand):
    def run(self, args):
        # ...
        parser.add_argument('--pwmFreq', default=60, help="The frequency to use for the PWM")
        # reference_clock_speed の引数なし
```

**結論**: `donkey calibrate`コマンドにも`reference_clock_speed`の設定オプションなし

#### 2.3.4 設定ファイル（config.py / myconfig.py）

`donkeycar/templates/cfg_complete.py`を確認:

```python
#9865, over rides only if needed, ie. TX2..
PCA9685_I2C_ADDR = 0x40     #I2C address
PCA9685_I2C_BUSNUM = None   #None will auto detect
# reference_clock_speed の設定項目なし
```

**結論**: Donkey Car標準設定ファイルに`reference_clock_speed`の項目がない

---

### 2.4 Adafruit PCA9685ライブラリ

#### 2.4.1 Adafruit_CircuitPython_PCA9685（新ライブラリ）

```python
# 初期化時にreference_clock_speedを指定可能
pca = PCA9685(i2c, reference_clock_speed=25630710)
```

**公式ドキュメントより**:
> The internal reference clock is 25MHz but may vary slightly with environmental conditions and manufacturing variances. Providing a more precise `reference_clock_speed` can improve the accuracy of the frequency and duty_cycle computations.

**参考**: [Adafruit PCA9685 Library API Reference](https://docs.circuitpython.org/projects/pca9685/en/latest/api.html)

#### 2.4.2 キャリブレーション方法

Adafruitはキャリブレーション用サンプルを提供:

```python
# calibration.py の例
# オシロスコープで測定した周波数に基づいて補正
measured_frequency = 52.0  # 実測値
target_frequency = 50.0
actual_osc = 25000000 * (measured_frequency / target_frequency)
pca.reference_clock_speed = actual_osc  # 例: 26,000,000 Hz
```

**参考**: [Adafruit PCA9685 Calibration Example](https://docs.circuitpython.org/projects/pca9685/en/latest/examples.html)

#### 2.4.3 保存機能

**結論**: Adafruitライブラリ自体には値を永続化する機能はない

- `reference_clock_speed`は毎回PCA9685オブジェクト初期化時に指定する必要がある
- 値はRAM上にのみ存在し、電源OFFで消える
- 永続化するにはアプリケーション側（config.pyなど）で管理する必要がある

---

### 2.5 PCA9685ハードウェア仕様

#### 2.5.1 不揮発性メモリの有無

**結論: PCA9685にはEEPROMや不揮発性メモリがない**

PCA9685データシートおよび調査結果より:
- PCA9685チップ自体にキャリブレーション値を保存する機能はない
- すべてのレジスタは電源OFF時にリセットされる
- 設定は毎回ソフトウェアから行う必要がある

**参考**: [PCA9685 Datasheet (NXP)](https://cdn-shop.adafruit.com/datasheets/PCA9685.pdf)

#### 2.5.2 レジスタマップ

| レジスタ | 機能 | 揮発性 |
|---------|------|--------|
| MODE1 | モード設定 | 揮発性 |
| MODE2 | モード設定 | 揮発性 |
| PRE_SCALE | PWM周波数設定 | 揮発性 |
| LEDn_ON/OFF | 各チャンネルPWM設定 | 揮発性 |
| ALL_LED_ON/OFF | 全チャンネル一括設定 | 揮発性 |

**すべてのレジスタが揮発性（電源OFFで初期値に戻る）**

#### 2.5.3 外部クロック入力

PCA9685は外部クロック入力（EXTCLK）をサポート:
- 最大50MHzの外部クロックを使用可能
- 複数のPCA9685を同期させる場合に使用
- 高精度なクロック源を使用することで発振器問題を回避可能

ただし、これもハードウェア変更が必要であり、キャリブレーション値の保存とは異なるアプローチ。

---

## 3. 問題点のまとめ

### 3.1 現状の問題

| レベル | 問題点 | 影響度 |
|--------|--------|--------|
| **picopico_racers** | キャリブレーション値の保存機能なし | 高 |
| **picopico_racers** | reference_clock_speedの設定なし | 高 |
| **Donkey Car** | pins.pyがreference_clock_speedをサポートしていない | 中 |
| **Donkey Car** | config.pyにreference_clock_speed項目なし | 中 |
| **Adafruitライブラリ** | 値の永続化機能なし | 低（設計上の問題ではない） |
| **PCA9685ハードウェア** | EEPROMなし | 低（仕様上の制限） |

### 3.2 影響

1. **毎回の初期化が必要**: PCA9685の電源ON時に毎回キャリブレーション値を設定する必要がある
2. **コード修正が必要**: キャリブレーション結果をコードに反映させる手動作業が必要
3. **移植性の問題**: 別のRaspberry PiやPCA9685ボードに変更した場合、再キャリブレーションが必要

---

## 4. 推奨対策

### 4.1 picopico_racersテストコードへの対策

#### A. reference_clock_speedパラメータの追加

```python
# テストコードの先頭に追加
REFERENCE_CLOCK_SPEED = 25000000  # デフォルト値（キャリブレーション後に更新）

def create_pca():
    i2c = busio.I2C(SCL, SDA)
    pca = PCA9685(i2c, reference_clock_speed=REFERENCE_CLOCK_SPEED)
    pca.frequency = 50
    return pca
```

#### B. キャリブレーション値を外部ファイルに保存

```python
# calibration_config.py（新規作成）
"""
PCA9685キャリブレーション設定
オシロスコープで測定した値を記入すること
"""
REFERENCE_CLOCK_SPEED = 26076200  # 実測した発振器周波数(Hz)
PWM_FREQUENCY = 50  # 目標PWM周波数(Hz)
```

```python
# テストコードで読み込み
from calibration_config import REFERENCE_CLOCK_SPEED, PWM_FREQUENCY

pca = PCA9685(i2c, reference_clock_speed=REFERENCE_CLOCK_SPEED)
pca.frequency = PWM_FREQUENCY
```

### 4.2 picopico_racers/mycar/myconfig.pyへの対策

#### 新しい設定項目の追加

```python
# myconfig.py に追加
# PCA9685 キャリブレーション設定
PCA9685_REFERENCE_CLOCK_SPEED = 25000000  # 実測した発振器周波数(Hz)
# オシロスコープで50Hzを狙って測定し、実際の周波数から逆算:
# 例: 52Hz測定時 → 25000000 * (52/50) = 26000000
```

### 4.3 Donkey Car本体への対策提案

#### donkeycar/parts/pins.py の修正提案

```python
class PCA9685:
    def __init__(self, busnum: int, address: int, frequency: int,
                 reference_clock_speed: int = 25000000):  # 追加パラメータ
        import Adafruit_PCA9685
        # ...
        self.pwm = Adafruit_PCA9685.PCA9685(
            address=address,
            reference_clock_speed=reference_clock_speed  # 追加
        )
        self.pwm.set_pwm_freq(frequency)
```

#### config.pyへの設定項目追加提案

```python
# PCA9685 キャリブレーション
PCA9685_REFERENCE_CLOCK_SPEED = 25000000  # 内部発振器の実測周波数(Hz)
```

### 4.4 キャリブレーションスクリプトの作成

```python
#!/usr/bin/env python3
"""
PCA9685 キャリブレーションスクリプト
使用方法:
1. オシロスコープをPCA9685のPWM出力に接続
2. このスクリプトを実行
3. 測定した周波数を入力
4. 計算されたreference_clock_speedをconfig.pyに記入
"""
import time
from board import SCL, SDA
import busio
from adafruit_pca9685 import PCA9685

TARGET_FREQ = 50  # 目標周波数

print("=== PCA9685 キャリブレーション ===")
print(f"目標周波数: {TARGET_FREQ}Hz")

i2c = busio.I2C(SCL, SDA)
pca = PCA9685(i2c)
pca.frequency = TARGET_FREQ

# テスト信号出力
pca.channels[0].duty_cycle = 0x7FFF  # 50% duty

print("\nPWM信号をチャンネル0から出力中...")
print("オシロスコープで周波数を測定してください。")
print()

try:
    measured = float(input("測定した周波数(Hz)を入力: "))

    # reference_clock_speedを計算
    default_clock = 25000000
    actual_clock = int(default_clock * (measured / TARGET_FREQ))

    print(f"\n=== 結果 ===")
    print(f"目標周波数: {TARGET_FREQ}Hz")
    print(f"実測周波数: {measured}Hz")
    print(f"偏差: {((measured - TARGET_FREQ) / TARGET_FREQ * 100):+.1f}%")
    print(f"\nreference_clock_speed = {actual_clock}")
    print(f"\n以下をconfig.pyに追記してください:")
    print(f"PCA9685_REFERENCE_CLOCK_SPEED = {actual_clock}")

except KeyboardInterrupt:
    print("\nキャンセルされました")
finally:
    pca.channels[0].duty_cycle = 0
    pca.deinit()
```

---

## 5. 結論

### 5.1 現状

| 項目 | 状態 |
|------|------|
| picopico_racersでのキャリブレーション値保存 | **未実装** |
| Donkey Carでのreference_clock_speedサポート | **未サポート** |
| PCA9685ハードウェアでの不揮発性保存 | **不可能**（EEPROM非搭載） |
| Adafruitライブラリでの永続化 | **アプリ側で対応必要** |

### 5.2 対応の優先度

| 対応策 | 優先度 | 難易度 | 効果 |
|--------|--------|--------|------|
| myconfig.pyにREFERENCE_CLOCK_SPEED追加 | **高** | 低 | 高 |
| テストコードのキャリブレーション対応 | **高** | 低 | 高 |
| キャリブレーションスクリプト作成 | **中** | 低 | 中 |
| Donkey Car本体pins.pyの修正 | **低** | 中 | 中 |

### 5.3 推奨アクション

1. **即座に実施**: `picopico_racers/mycar/myconfig.py`に`PCA9685_REFERENCE_CLOCK_SPEED`項目を追加
2. **次に実施**: キャリブレーションスクリプトを作成し、実測値を取得
3. **将来的に**: Donkey Car本家へのPR検討（pins.pyのreference_clock_speedサポート）

---

## 6. 参考資料

### 公式ドキュメント
- [Adafruit PCA9685 Library API Reference](https://docs.circuitpython.org/projects/pca9685/en/latest/api.html)
- [Adafruit PCA9685 Library - Introduction](https://docs.circuitpython.org/projects/pca9685/en/latest/)
- [PCA9685 Datasheet (NXP)](https://cdn-shop.adafruit.com/datasheets/PCA9685.pdf)
- [PCA9685 Datasheet (Digi-Key)](https://www.digikey.com/htmldatasheets/production/1640697/0/0/1/pca9685-datasheet.html)

### GitHub
- [Adafruit_CircuitPython_PCA9685](https://github.com/adafruit/Adafruit_CircuitPython_PCA9685)
- [Adafruit_Python_PCA9685 (deprecated)](https://github.com/adafruit/Adafruit_Python_PCA9685)
- [PCA9685_Frequency_Calibration](https://github.com/va3wam/PCA9685_Frequency_Calibration)

### 関連調査レポート

| 資料名 | 内容 | リンク |
|--------|------|--------|
| PWM動作調査レポート | PCA9685発振器精度問題の詳細 | [20260128-1730_PWM動作調査レポート.md](./20260128-1730_PWM動作調査レポート.md) |
| RCサーボ許容範囲調査 | 発振器偏差がサーボに与える影響 | [20260128-1830_RCサーボ許容範囲調査レポート.md](./20260128-1830_RCサーボ許容範囲調査レポート.md) |
| GPIO直接制御調査 | PCA9685を使わない制御方法 | [20260128-2000_GPIO直接制御調査.md](./20260128-2000_GPIO直接制御調査.md) |
