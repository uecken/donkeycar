# Donkeycar IMU対応一覧

**作成日**: 2026年2月12日
**作成者**: robotcar-engineer
**対象バージョン**: Donkeycar >= 5.1

---

## 概要

Donkeycarで標準対応しているIMU（慣性計測ユニット）センサーについてまとめた資料です。対応センサー、接続方法、設定パラメータ、出力データ形式を整理しています。

---

## 対応IMUセンサー一覧

| センサー | 対応ファイル | 接続方式 | 主な特徴 |
|----------|-------------|----------|----------|
| **MPU6050** | `donkeycar/parts/imu.py` | I2C | 6軸（加速度3軸 + ジャイロ3軸）、温度センサー内蔵 |
| **MPU9250** | `donkeycar/parts/imu.py` | I2C | 9軸（加速度3軸 + ジャイロ3軸 + 磁気3軸）、温度センサー内蔵 |
| **Intel RealSense D435i** | `donkeycar/parts/realsense435i.py` | USB | 深度カメラ内蔵IMU（加速度3軸 + ジャイロ3軸） |
| **Intel RealSense T265** | `donkeycar/parts/realsense2.py` | USB | トラッキングカメラ内蔵IMU（VIO対応）、位置・速度・加速度出力 |

---

## 詳細仕様

### 1. MPU6050

**ファイル**: `c:\Users\thefu\Documents\donkeycar\donkeycar\parts\imu.py`

#### 基本情報

| 項目 | 内容 |
|------|------|
| **センサータイプ** | 6軸IMU（加速度 + ジャイロ） |
| **インターフェース** | I2C |
| **デフォルトアドレス** | `0x68`（AD0ピンをHighにすると`0x69`） |
| **必要ライブラリ** | `mpu6050-raspberrypi` |

#### インストール方法

```bash
# SMBusのインストール
sudo apt install python3-smbus

# または詳細インストール
sudo apt-get install i2c-tools libi2c-dev python-dev python3-dev
git clone https://github.com/pimoroni/py-smbus.git
cd py-smbus/library
python setup.py build
sudo python setup.py install

# MPU6050ライブラリ
pip install mpu6050-raspberrypi
```

#### 出力データ

| 出力キー | 説明 | 単位 |
|----------|------|------|
| `imu/acl_x` | X軸加速度 | m/s² |
| `imu/acl_y` | Y軸加速度 | m/s² |
| `imu/acl_z` | Z軸加速度 | m/s² |
| `imu/gyr_x` | X軸角速度 | °/s |
| `imu/gyr_y` | Y軸角速度 | °/s |
| `imu/gyr_z` | Z軸角速度 | °/s |
| `temp` | 温度 | ℃ |

**注意**: `run_threaded()`の戻り値には温度が含まれますが、Vehicle pipelineへの出力では温度は記録されません。

#### DLP（Digital Low Pass Filter）設定

MPU6050はデジタルローパスフィルタを内蔵しており、ノイズを低減できます。

| DLP設定値 | 加速度帯域幅 | ジャイロ帯域幅 | サンプリングレート |
|-----------|-------------|---------------|-------------------|
| 0 | 260 Hz | 256 Hz | 8 kHz |
| 1 | 184 Hz | 188 Hz | 1 kHz |
| 2 | 94 Hz | 98 Hz | 1 kHz |
| 3 | 44 Hz | 42 Hz | 1 kHz |
| 4 | 21 Hz | 20 Hz | 1 kHz |
| 5 | 10 Hz | 10 Hz | 1 kHz |
| 6 | 5 Hz | 5 Hz | 1 kHz |

---

### 2. MPU9250

**ファイル**: `c:\Users\thefu\Documents\donkeycar\donkeycar\parts\imu.py`

#### 基本情報

| 項目 | 内容 |
|------|------|
| **センサータイプ** | 9軸IMU（加速度 + ジャイロ + 磁気） |
| **インターフェース** | I2C |
| **デフォルトアドレス** | MPU9250: `0x68`、AK8963（磁気センサー）: `0x0C` |
| **必要ライブラリ** | `mpu9250-jmdev` |

#### インストール方法

```bash
pip install mpu9250-jmdev
```

#### デフォルト設定

コード内で以下の設定が使用されます：

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `GFS_1000` | ±1000 °/s | ジャイロスケール |
| `AFS_4G` | ±4G | 加速度スケール |
| `AK8963_BIT_16` | 16bit | 磁気センサー分解能 |
| `AK8963_MODE_C100HZ` | 100Hz | 磁気センサー連続測定モード |

#### 出力データ

| 出力キー | 説明 | 単位 |
|----------|------|------|
| `imu/acl_x` | X軸加速度 | m/s² |
| `imu/acl_y` | Y軸加速度 | m/s² |
| `imu/acl_z` | Z軸加速度 | m/s² |
| `imu/gyr_x` | X軸角速度 | °/s |
| `imu/gyr_y` | Y軸角速度 | °/s |
| `imu/gyr_z` | Z軸角速度 | °/s |
| `mag_x` | X軸磁気（内部のみ） | μT |
| `mag_y` | Y軸磁気（内部のみ） | μT |
| `mag_z` | Z軸磁気（内部のみ） | μT |
| `temp` | 温度 | ℃ |

**注意**: MPU9250の磁気データは内部で取得されますが、`run_threaded()`では出力されません。磁気データを使用したい場合はコードの修正が必要です。

---

### 3. Intel RealSense D435i

**ファイル**: `c:\Users\thefu\Documents\donkeycar\donkeycar\parts\realsense435i.py`

#### 基本情報

| 項目 | 内容 |
|------|------|
| **センサータイプ** | 深度カメラ + IMU（D435iのみ、D435はIMU非搭載） |
| **インターフェース** | USB 3.0 |
| **必要ライブラリ** | `pyrealsense2` |

#### IMUストリーム設定

| パラメータ | 値 |
|-----------|-----|
| 加速度サンプリングレート | 63 Hz |
| ジャイロサンプリングレート | 200 Hz |
| データフォーマット | `motion_xyz32f` |

#### 出力データ

| 出力キー | 説明 | 単位 |
|----------|------|------|
| `cam/image_array` | RGBカメラ画像 | numpy array |
| `cam/depth_array` | 深度画像 | numpy array (uint16) |
| `imu/acl_x` | X軸加速度 | m/s² |
| `imu/acl_y` | Y軸加速度 | m/s² |
| `imu/acl_z` | Z軸加速度 | m/s² |
| `imu/gyr_x` | X軸角速度（ピッチ） | rad/s |
| `imu/gyr_y` | Y軸角速度（ヨー） | rad/s |
| `imu/gyr_z` | Z軸角速度（ロール） | rad/s |

---

### 4. Intel RealSense T265

**ファイル**: `c:\Users\thefu\Documents\donkeycar\donkeycar\parts\realsense2.py`

#### 基本情報

| 項目 | 内容 |
|------|------|
| **センサータイプ** | トラッキングカメラ（VIO：Visual-Inertial Odometry） |
| **インターフェース** | USB 3.0推奨（USB 2.0でも動作可能） |
| **必要ライブラリ** | `pyrealsense2` |

#### 特徴

- Movidius チップによるオンボードセンサーフュージョン
- ワールド座標系での位置・速度・加速度を直接出力
- ホイールオドメトリ入力との連携が可能

#### 出力データ

| 出力キー | 説明 | 単位 |
|----------|------|------|
| `pos` | 位置（x, y, z） | meters |
| `vel` | 速度（x, y, z） | m/s |
| `acc` | 加速度（x, y, z） | m/s² |
| `img` | フィッシュアイカメラ画像（オプション） | numpy array |

**注意**: T265はIntelにより生産終了となっています。

---

## 設定ファイル（myconfig.py）

### MPU6050/MPU9250用設定

```python
# IMU設定
HAVE_IMU = True                 # IMUを使用する場合はTrue
IMU_SENSOR = 'mpu6050'          # 'mpu6050' または 'mpu9250'
IMU_ADDRESS = 0x68              # I2Cアドレス（AD0ピンがHighの場合は0x69）
IMU_DLP_CONFIG = 0              # DLPフィルタ設定（0:無効, 1-6:有効）
```

### RealSense D435i用設定

```python
# カメラタイプをD435に設定
CAMERA_TYPE = "D435"

# Intel Realsense D435/D435i設定
REALSENSE_D435_RGB = True       # RGBカメラを有効化
REALSENSE_D435_DEPTH = True     # 深度カメラを有効化
REALSENSE_D435_IMU = True       # IMUを有効化（D435iのみ）
REALSENSE_D435_ID = None        # カメラのシリアル番号（複数接続時に指定）
```

---

## IMUモデル（機械学習）

Donkeycarには、画像とIMUデータを組み合わせた学習モデルが用意されています。

**ファイル**: `c:\Users\thefu\Documents\donkeycar\donkeycar\parts\keras.py`

### KerasIMU クラス

```python
class KerasIMU(KerasPilot):
    """
    画像とIMUベクトルを入力として受け取り、
    ステアリングとスロットルを出力するKerasパート
    """
```

#### 入力データ

| 入力 | 形状 | 説明 |
|------|------|------|
| `img_in` | (120, 160, 3) | カメラ画像 |
| `imu_in` | (6,) | IMUデータ（acl_x, acl_y, acl_z, gyr_x, gyr_y, gyr_z） |

#### モデル構造

```
画像入力 → CNN層 → Dense(100) → Dropout(0.1)
                                    ↓
IMU入力 → Dense(14) → Dense(14) → Dense(14)
                                    ↓
                        結合（concatenate）
                                    ↓
                    Dense(50) → Dropout(0.1)
                                    ↓
                    Dense(50) → Dropout(0.1)
                                    ↓
                    ステアリング出力, スロットル出力
```

---

## 接続図（Raspberry Pi 4）

```
Raspberry Pi 4 GPIO
├── I2C1 (GPIO 2: SDA, GPIO 3: SCL)
│   └── MPU6050/MPU9250 (0x68)
│       ├── VCC → 3.3V
│       ├── GND → GND
│       ├── SDA → GPIO 2 (Pin 3)
│       ├── SCL → GPIO 3 (Pin 5)
│       └── AD0 → GND (0x68) または 3.3V (0x69)
│
└── USB 3.0
    └── Intel RealSense D435i / T265
```

---

## センサー比較表

| 項目 | MPU6050 | MPU9250 | D435i | T265 |
|------|---------|---------|-------|------|
| **軸数** | 6軸 | 9軸 | 6軸 | 6軸（+VIO） |
| **加速度** | ✓ | ✓ | ✓ | ✓ |
| **ジャイロ** | ✓ | ✓ | ✓ | ✓ |
| **磁気** | - | ✓ | - | - |
| **位置出力** | - | - | - | ✓ |
| **接続** | I2C | I2C | USB | USB |
| **価格帯** | 安価 | 安価 | 高価 | 生産終了 |
| **追加機能** | 温度 | 温度 | 深度カメラ | トラッキング |
| **DLPフィルタ** | ✓ | ✓ | N/A | N/A |
| **キャリブレーション** | 手動 | 自動（初期化時） | 不要 | 不要 |

---

## 使用例

### MPU6050の単体テスト

```bash
cd ~/donkeycar
python donkeycar/parts/imu.py mpu6050 0
```

### MPU9250の単体テスト

```bash
cd ~/donkeycar
python donkeycar/parts/imu.py mpu9250 1
```

### RealSense D435i IMUテスト

```bash
cd ~/donkeycar
python donkeycar/parts/realsense435i.py --imu
```

---

## 注意事項

1. **I2C有効化**: Raspberry Piでは事前にI2Cを有効化する必要があります
   ```bash
   sudo raspi-config
   # Interface Options → I2C → Enable
   ```

2. **MPU9250のキャリブレーション**: 初期化時に`calibrateMPU6500()`が自動実行されます。キャリブレーション中はセンサーを動かさないでください。

3. **RealSense USB接続**: D435i/T265はUSB 3.0推奨です。USB 2.0では帯域幅不足でIMUデータが取得できない場合があります。

4. **BNO055について**: CLAUDE.mdに記載がありますが、現在のDonkeycarコードベースではBNO055の直接サポートは実装されていません。使用する場合はカスタムパーツの作成が必要です。

---

## 参考リンク

- [Donkeycar公式ドキュメント - IMU](https://docs.donkeycar.com/parts/imu/)
- [MPU6050 DLPフィルタ設定](https://ulrichbuschbaum.wordpress.com/2015/01/18/using-the-mpu6050s-dlpf/)
- [Intel RealSense SDK](https://github.com/IntelRealSense/librealsense)
- [mpu6050-raspberrypi ライブラリ](https://pypi.org/project/mpu6050-raspberrypi/)
- [mpu9250-jmdev ライブラリ](https://pypi.org/project/mpu9250-jmdev/)

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026年2月12日 | 初版作成 |
