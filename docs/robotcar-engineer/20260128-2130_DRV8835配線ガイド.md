# DRV8835 配線ガイド - HBX 2192用

**作成日**: 2026年1月28日
**最終更新**: 2026年1月28日
**対象車両**: HBX 2192（1モーター + 1サーボ構成）
**作成者**: robotcar-engineer

---

## 目次

1. [DRV8835の仕様](#1-drv8835の仕様)
2. [配線図](#2-配線図)
3. [ピンアサイン表](#3-ピンアサイン表)
4. [Donkey Car設定（myconfig.py）](#4-donkey-car設定myconfigpy)
5. [テストコード](#5-テストコード)
6. [注意事項](#6-注意事項)
7. [参考資料](#参考資料)
8. [Donkey CarをDRV8835で動かす手順](#8-donkey-carをdrv8835で動かす手順)
   - [8.1 前提条件](#81-前提条件)
   - [8.2 myconfig.pyの設定手順](#82-myconfigpyの設定手順)
   - [8.3 キャリブレーション手順](#83-キャリブレーション手順)
   - [8.4 動作確認手順](#84-動作確認手順)
   - [8.5 トラブルシューティング](#85-トラブルシューティング)
   - [8.6 実際のmyconfig.py設定例（コピペ可能）](#86-実際のmyconfigpy設定例コピペ可能)

---

## 1. DRV8835の仕様

### 1.1 基本仕様

| 項目 | 仕様 |
|------|------|
| **メーカー** | Texas Instruments |
| **チップ型番** | DRV8835 |
| **チャンネル数** | 2ch（デュアルHブリッジ） |
| **モーター電圧（VM）** | 2V - 11V |
| **ロジック電圧（VCC）** | 2V - 7V（**1.8V動作も可能**） |
| **出力電流** | 1.5A（連続）/ 1.5A（ピーク）※チャンネルあたり |
| **オン抵抗** | 305mΩ（HS+LS合計、典型値） |
| **PWM周波数** | 最大250kHz |
| **動作温度** | -40℃ 〜 +85℃ |
| **パッケージ** | WSON-12（IC単体）/ DIP12（モジュール） |

### 1.2 秋月電子での購入情報

| 製品 | 価格（税込） | リンク |
|------|-------------|--------|
| **DRV8835使用モジュール** | 550円 | https://akizukidenshi.com/catalog/g/g109848/ |

**モジュールの特徴**:
- ブレッドボード対応DIP12形状
- 電源レギュレータ内蔵（5V入力対応）
- 必要な外付け部品が実装済み
- MODEピンがプルダウン済み（IN/INモードがデフォルト）

### 1.3 制御モード

DRV8835には2つの制御モードがあり、**MODEピン**の状態で選択します。

#### PHASE/ENABLEモード（MODE = HIGH）- **推奨**

```
┌──────────┬─────────┬──────────────────────────────────┐
│  PHASE   │ ENABLE  │            動作                  │
├──────────┼─────────┼──────────────────────────────────┤
│    L     │   PWM   │ 逆転（速度はPWMデューティ）      │
│    H     │   PWM   │ 正転（速度はPWMデューティ）      │
│    X     │    L    │ 停止（コースト／惰走）           │
└──────────┴─────────┴──────────────────────────────────┘

* PHASE: 方向制御（TTL: HIGH/LOW）
* ENABLE: 速度制御（PWM: 0-100%デューティ）
```

**利点**: **SERVO_HBRIDGE_3PINに完全対応**
- FWD_PIN = PHASE（方向）
- DUTY_PIN = ENABLE（速度PWM）
- BWD_PINは不使用（GND固定）

#### IN/INモード（MODE = LOW / NC）

```
┌──────────┬─────────┬──────────────────────────────────┐
│   xIN1   │  xIN2   │            動作                  │
├──────────┼─────────┼──────────────────────────────────┤
│   PWM    │    L    │ 正転（速度はPWMデューティ）      │
│    L     │   PWM   │ 逆転（速度はPWMデューティ）      │
│    L     │    L    │ コースト（惰走）                 │
│    H     │    H    │ ブレーキ（短絡制動）             │
└──────────┴─────────┴──────────────────────────────────┘
```

**利点**: より柔軟なブレーキ制御が可能
**欠点**: 2本のPWMピンが必要（SERVO_HBRIDGE_2PIN向け）

### 1.4 PHASE/ENABLE vs IN/INモードの比較

| 項目 | PHASE/ENABLEモード | IN/INモード |
|------|-------------------|-------------|
| **制御ピン数** | 2ピン（PHASE + ENABLE） | 2ピン（IN1 + IN2） |
| **PWMピン数** | 1ピン | 2ピン |
| **方向切替** | PHASEのHIGH/LOW | IN1/IN2の組み合わせ |
| **ブレーキ制御** | ENABLEをLOWで惰走のみ | IN1=IN2=HIGHで能動ブレーキ |
| **Donkey Car対応** | **SERVO_HBRIDGE_3PIN** | SERVO_HBRIDGE_2PIN |
| **推奨用途** | **HBX 2192（本ガイド）** | 差動2輪など |

---

## 2. 配線図

### 2.1 システム構成図

```
                              ┌──────────────────────────────────────┐
                              │           HBX 2192                   │
                              │                                      │
                              │    ┌─────────────┐                  │
                              │    │ 370モーター │                  │
                              │    │   (リア)    │                  │
                              │    └──────┬──────┘                  │
                              │           │                          │
                              │    ┌──────┴──────┐                  │
                              │    │  DRV8835    │                  │
                              │    │  モジュール  │                  │
                              │    └──────┬──────┘                  │
┌──────────────────┐          │           │                          │
│ 7.4V 2S LiPo     │          │    ┌──────┴──────┐                  │
│   バッテリー      ├────────────────►│ 電源入力    │                  │
│                  │          │    └─────────────┘                  │
└────────┬─────────┘          │                                      │
         │                    │    ┌─────────────┐                  │
         │    ┌───────────┐   │    │ ステアリング │                  │
         └────► 5V BEC    ├───────►│  サーボ     │                  │
              │           │   │    │ (MG90S等)   │                  │
              └─────┬─────┘   │    └─────────────┘                  │
                    │         │                                      │
                    ▼         └──────────────────────────────────────┘
         ┌──────────────────┐
         │  Raspberry Pi 4  │
         │                  │
         │  GPIO制御        │
         │  ・サーボPWM     │
         │  ・モーター方向  │
         │  ・モーターPWM   │
         └──────────────────┘
```

### 2.2 詳細配線図（PHASE/ENABLEモード）

```
                    Raspberry Pi 4
                    ┌──────────────────────────────────────────────┐
                    │                                              │
                    │  (BCM)  (BOARD)                              │
                    │                                              │
   サーボ信号 ◄─────│  GPIO18  [Pin 12]  ──────────────────────────┼────► サーボ信号線（黄/橙）
                    │                                              │
   モーター方向 ◄───│  GPIO17  [Pin 11]  ──────────────────────────┼────► DRV8835 APHASE
                    │                                              │
   モーターPWM ◄────│  GPIO13  [Pin 33]  ──────────────────────────┼────► DRV8835 AENBL
                    │                                              │
   3.3V ◄───────────│  3.3V    [Pin 1]   ──────────────────────────┼────► DRV8835 MODE
                    │                                              │
   GND ◄────────────│  GND     [Pin 6]   ──────┬───────────────────┼────► DRV8835 GND
                    │                          │                   │     ──► サーボGND
                    │                          │                   │     ──► 電源GND
                    └──────────────────────────│───────────────────┘
                                               │
                                               ▼
                                        GND共通化ポイント
```

### 2.3 DRV8835モジュール配線詳細

```
                            DRV8835 モジュール
                    ┌────────────────────────────────────┐
                    │                                    │
      7.4V Battery ─┼───► VIN  [1]        [12] AOUT1 ────┼──► 370モーター +
                    │                                    │
             GND  ──┼───► GND  [2]        [11] AOUT2 ────┼──► 370モーター -
                    │                                    │
      GPIO17 ───────┼───► AIN1/APHASE [3] [10] BOUT1 ────┼──► (未使用 / Bチャンネル)
                    │                                    │
      GPIO13 (PWM) ─┼───► AIN2/AENBL  [4] [9]  BOUT2 ────┼──► (未使用 / Bチャンネル)
                    │                                    │
      (未使用) ─────┼───► BIN1/BPHASE [5] [8]  VCC  ─────┼──► (内部接続 / NC)
                    │                                    │
      (未使用) ─────┼───► BIN2/BENBL  [6] [7]  MODE ─────┼──► 3.3V (PHASE/ENABLE選択)
                    │                                    │
                    └────────────────────────────────────┘

                    ※ PHASE/ENABLEモード時のピン名称:
                      - AIN1 → APHASE（方向制御）
                      - AIN2 → AENBL（速度PWM）
```

### 2.4 サーボ配線詳細

```
標準3線式サーボ（MG90S / SG90など）

                         サーボ
                    ┌─────────────────┐
                    │                 │
      GPIO18 (PWM) ─┼───► 信号（黄/橙）│
                    │                 │
      5V BEC  ──────┼───► VCC（赤）    │
                    │                 │
      GND  ─────────┼───► GND（茶/黒）│
                    │                 │
                    └─────────────────┘
```

### 2.5 電源系統配線図

```
       7.4V 2S LiPo バッテリー
       ┌─────────────────────┐
       │  +    7.4V          │
       │                     │
       │  -    GND           │
       └──┬──────────┬───────┘
          │          │
          │          │
    ┌─────┴─────┐    │
    │ 5V BEC    │    │
    │ (UBEC)    │    │
    │           │    │
    │ IN+  OUT+ ├────┼──────────► Raspberry Pi 5V [Pin 2,4]
    │           │    │            サーボ VCC
    │ IN-  OUT- ├────┼──────────► Raspberry Pi GND [Pin 6,9,14...]
    └───────────┘    │            サーボ GND
                     │            DRV8835 GND
                     │
                     └──────────► DRV8835 VIN (7.4V)
                                  370モーター電源

    ※ GND共通化は必須（全てのGNDを接続）
```

---

## 3. ピンアサイン表

### 3.1 Raspberry Pi 4 → DRV8835

| Raspberry Pi | BCM番号 | BOARD番号 | 接続先（DRV8835） | 機能 |
|--------------|---------|-----------|-------------------|------|
| GPIO 17 | BCM.17 | Pin 11 | APHASE (AIN1) | モーター方向制御（TTL） |
| GPIO 13 | BCM.13 | Pin 33 | AENBL (AIN2) | モーター速度制御（PWM） |
| 3.3V | - | Pin 1 | MODE | PHASE/ENABLEモード選択 |
| GND | - | Pin 6 | GND | グランド共通 |

### 3.2 Raspberry Pi 4 → サーボ

| Raspberry Pi | BCM番号 | BOARD番号 | 接続先（サーボ） | 機能 |
|--------------|---------|-----------|-----------------|------|
| GPIO 18 | BCM.18 | Pin 12 | 信号線（黄/橙） | サーボPWM制御 |
| - | - | - | VCC（赤） | 5V BECから供給 |
| GND | - | Pin 6 | GND（茶/黒） | グランド共通 |

### 3.3 DRV8835 → 370モーター

| DRV8835 | 接続先 | 備考 |
|---------|--------|------|
| AOUT1 | モーター + | 赤線（一般的） |
| AOUT2 | モーター - | 黒線（一般的） |

**注意**: モーターの回転方向が逆の場合は、AOUT1とAOUT2の接続を入れ替えてください。

### 3.4 電源接続

| 電源 | 接続先 | 電圧 | 備考 |
|------|--------|------|------|
| 7.4V バッテリー+ | DRV8835 VIN | 7.4V | モーター電源 |
| 7.4V バッテリー+ | 5V BEC 入力+ | 7.4V | 変換用 |
| 5V BEC 出力+ | Raspberry Pi 5V | 5V | Pi電源 |
| 5V BEC 出力+ | サーボ VCC | 5V | サーボ電源 |
| GND | 全て共通 | 0V | **必ず共通化** |

### 3.5 ハードウェアPWMピンの確認

Raspberry Pi 4のハードウェアPWMは**2チャンネル**のみ：

| PWMチャンネル | 使用可能ピン（BCM） | 本構成での使用 |
|--------------|-------------------|---------------|
| PWM0 | GPIO 12, GPIO 18 | **GPIO 18** → サーボ |
| PWM1 | GPIO 13, GPIO 19 | **GPIO 13** → DRV8835 AENBL |

**重要**: GPIO 12とGPIO 18は同じPWM0チャンネル（同一周波数・デューティ）。GPIO 13とGPIO 19は同じPWM1チャンネル。異なる信号を出す場合は各チャンネルから1本ずつ選択。

---

## 4. Donkey Car設定（myconfig.py）

### 4.1 完全な設定例（SERVO_HBRIDGE_3PIN）

```python
# ==============================================================================
# myconfig.py - HBX 2192 + DRV8835 PHASE/ENABLEモード
# ==============================================================================
# 対象車両: HBX 2192（1モーター + 1サーボ構成）
# モータードライバー: DRV8835（PHASE/ENABLEモード）
# 作成日: 2026年1月28日
# ==============================================================================

# ==============================================================================
# ドライブトレイン設定
# ==============================================================================
DRIVE_TRAIN_TYPE = "SERVO_HBRIDGE_3PIN"

# ==============================================================================
# SERVO_HBRIDGE_3PIN 設定（DRV8835 PHASE/ENABLEモード対応）
# ==============================================================================
SERVO_HBRIDGE_3PIN = {
    # -------------------------------------------------------------------------
    # ステアリングサーボ設定
    # -------------------------------------------------------------------------
    # GPIO18（BCM）= Pin 12（BOARD）= ハードウェアPWM0
    "PWM_STEERING_PIN": "PIGPIO.BCM.18",

    # PWMスケール（60Hzベースからの補正、通常は1.0）
    "PWM_STEERING_SCALE": 1.0,

    # PWM反転（サーボによっては必要な場合あり）
    "PWM_STEERING_INVERTED": False,

    # ステアリングキャリブレーション値（donkey calibrateで測定）
    # 左いっぱい時のPWM値（12bit: 0-4095）
    "STEERING_LEFT_PWM": 460,

    # 右いっぱい時のPWM値（12bit: 0-4095）
    "STEERING_RIGHT_PWM": 290,

    # -------------------------------------------------------------------------
    # スロットル（モーター）設定 - DRV8835 PHASE/ENABLEモード
    # -------------------------------------------------------------------------
    # 正転方向ピン（APHASE）
    # GPIO17（BCM）= Pin 11（BOARD）= TTL出力
    "FWD_PIN": "RPI_GPIO.BCM.17",

    # 逆転方向ピン（未使用 - DRV8835のPHASE/ENABLEモードでは不要）
    # ダミーピンとしてGPIO27を指定（実際には使用しない）
    # 注意: Donkey CarのL298N_HBridge_3pinクラスはBWD_PINを要求するため、
    #       未使用のGPIOを割り当てる必要があります
    "BWD_PIN": "RPI_GPIO.BCM.27",

    # 速度PWMピン（AENBL）
    # GPIO13（BCM）= Pin 33（BOARD）= ハードウェアPWM1
    "DUTY_PIN": "PIGPIO.BCM.13",
}

# ==============================================================================
# 代替設定: RPI_GPIO使用（PIGPIOデーモンが動作しない場合）
# ==============================================================================
# SERVO_HBRIDGE_3PIN = {
#     "PWM_STEERING_PIN": "RPI_GPIO.BCM.18",
#     "PWM_STEERING_SCALE": 1.0,
#     "PWM_STEERING_INVERTED": False,
#     "STEERING_LEFT_PWM": 460,
#     "STEERING_RIGHT_PWM": 290,
#     "FWD_PIN": "RPI_GPIO.BCM.17",
#     "BWD_PIN": "RPI_GPIO.BCM.27",
#     "DUTY_PIN": "RPI_GPIO.BCM.13",
# }

# ==============================================================================
# 代替設定: BOARDピン番号使用
# ==============================================================================
# SERVO_HBRIDGE_3PIN = {
#     "PWM_STEERING_PIN": "RPI_GPIO.BOARD.12",   # GPIO18
#     "PWM_STEERING_SCALE": 1.0,
#     "PWM_STEERING_INVERTED": False,
#     "STEERING_LEFT_PWM": 460,
#     "STEERING_RIGHT_PWM": 290,
#     "FWD_PIN": "RPI_GPIO.BOARD.11",            # GPIO17
#     "BWD_PIN": "RPI_GPIO.BOARD.13",            # GPIO27
#     "DUTY_PIN": "RPI_GPIO.BOARD.33",           # GPIO13
# }

# ==============================================================================
# その他の設定（必要に応じて調整）
# ==============================================================================

# カメラ設定
CAMERA_TYPE = "PICAM"
IMAGE_W = 160
IMAGE_H = 120
CAMERA_FRAMERATE = 20

# ドライブループ周波数
DRIVE_LOOP_HZ = 20

# コントローラー設定
USE_JOYSTICK_AS_DEFAULT = True
CONTROLLER_TYPE = 'xbox'  # または 'ps4', 'F710' など
JOYSTICK_MAX_THROTTLE = 0.5
JOYSTICK_STEERING_SCALE = 1.0
AUTO_RECORD_ON_THROTTLE = True
```

### 4.2 DRV8835 PHASE/ENABLEモードの動作原理

Donkey Carの`L298N_HBridge_3pin`クラスは以下の制御ロジックを持ちます：

```python
# donkeycar/parts/actuator.py より抜粋（動作原理の説明）

# 前進時（throttle > 0）:
#   FWD_PIN = HIGH
#   BWD_PIN = LOW
#   DUTY_PIN = PWM（スロットル値に応じたデューティ）

# 後進時（throttle < 0）:
#   FWD_PIN = LOW
#   BWD_PIN = HIGH
#   DUTY_PIN = PWM（スロットル絶対値に応じたデューティ）

# 停止時（throttle = 0）:
#   FWD_PIN = LOW
#   BWD_PIN = LOW
#   DUTY_PIN = 0
```

**DRV8835 PHASE/ENABLEモードでの対応**:

| Donkey Carの動作 | FWD_PIN (APHASE) | BWD_PIN (未使用) | DUTY_PIN (AENBL) | DRV8835の動作 |
|-----------------|------------------|------------------|------------------|---------------|
| 前進 | HIGH | LOW | PWM | **正転** |
| 後進 | LOW | HIGH | PWM | **逆転** |
| 停止 | LOW | LOW | 0 | **コースト** |

**重要**: BWD_PINは実際にはDRV8835に接続しません（ダミー）。DRV8835のPHASE/ENABLEモードでは、APHASEピンのみで方向を決定します。

### 4.3 キャリブレーション手順

```bash
# Raspberry Pi上で実行

# 1. pigpioデーモンを起動
sudo pigpiod

# 2. Donkey Carのキャリブレーションツールを実行
cd ~/mycar
donkey calibrate --channel 0 --bus 1  # ステアリング
donkey calibrate --channel 1 --bus 1  # スロットル（ESC使用時）

# GPIO直接制御の場合は手動テスト
python test_servo.py   # 後述のテストコード使用
python test_motor.py   # 後述のテストコード使用
```

---

## 5. テストコード

### 5.1 サーボ単体テスト（test_servo.py）

```python
#!/usr/bin/env python3
"""
サーボ単体テスト - GPIO18（PWM0）使用
HBX 2192 ステアリングサーボ動作確認用

使用方法:
    sudo pigpiod  # 事前にpigpioデーモンを起動
    python test_servo.py
"""

import pigpio
import time

# ピン設定
SERVO_PIN = 18  # BCM番号（GPIO18 = Pin 12）

# PWM設定
PWM_FREQUENCY = 50  # 50Hz（サーボ標準）

# パルス幅（マイクロ秒）
PULSE_CENTER = 1500   # 中央位置
PULSE_LEFT = 2000     # 左いっぱい（調整が必要な場合あり）
PULSE_RIGHT = 1000    # 右いっぱい（調整が必要な場合あり）

def main():
    print("=== サーボ単体テスト ===")
    print(f"GPIO: {SERVO_PIN} (BCM)")
    print(f"PWM周波数: {PWM_FREQUENCY}Hz")
    print()

    # pigpioに接続
    pi = pigpio.pi()
    if not pi.connected:
        print("ERROR: pigpioデーモンに接続できません")
        print("sudo pigpiod を実行してください")
        return

    try:
        print("サーボを中央に移動...")
        pi.set_servo_pulsewidth(SERVO_PIN, PULSE_CENTER)
        time.sleep(1)

        print("サーボを左に移動...")
        pi.set_servo_pulsewidth(SERVO_PIN, PULSE_LEFT)
        time.sleep(1)

        print("サーボを中央に移動...")
        pi.set_servo_pulsewidth(SERVO_PIN, PULSE_CENTER)
        time.sleep(1)

        print("サーボを右に移動...")
        pi.set_servo_pulsewidth(SERVO_PIN, PULSE_RIGHT)
        time.sleep(1)

        print("サーボを中央に移動...")
        pi.set_servo_pulsewidth(SERVO_PIN, PULSE_CENTER)
        time.sleep(1)

        # スイープテスト
        print()
        print("スイープテスト（左→右→左）...")
        for pulse in range(PULSE_RIGHT, PULSE_LEFT + 1, 50):
            pi.set_servo_pulsewidth(SERVO_PIN, pulse)
            time.sleep(0.05)
        for pulse in range(PULSE_LEFT, PULSE_RIGHT - 1, -50):
            pi.set_servo_pulsewidth(SERVO_PIN, pulse)
            time.sleep(0.05)

        print()
        print("テスト完了")

    except KeyboardInterrupt:
        print("\n中断されました")

    finally:
        # サーボを中央に戻して停止
        pi.set_servo_pulsewidth(SERVO_PIN, PULSE_CENTER)
        time.sleep(0.5)
        pi.set_servo_pulsewidth(SERVO_PIN, 0)  # PWM停止
        pi.stop()
        print("クリーンアップ完了")

if __name__ == "__main__":
    main()
```

### 5.2 DCモーター単体テスト（test_motor.py）

```python
#!/usr/bin/env python3
"""
DCモーター単体テスト - DRV8835 PHASE/ENABLEモード
HBX 2192 370モーター動作確認用

使用方法:
    sudo pigpiod  # 事前にpigpioデーモンを起動
    python test_motor.py

配線:
    GPIO17 (BCM) → DRV8835 APHASE（方向制御）
    GPIO13 (BCM) → DRV8835 AENBL（速度PWM）
    3.3V         → DRV8835 MODE（PHASE/ENABLEモード選択）
    GND          → DRV8835 GND
"""

import pigpio
import time

# ピン設定（BCM番号）
PHASE_PIN = 17   # 方向制御（APHASE）
ENABLE_PIN = 13  # 速度PWM（AENBL）

# PWM設定
PWM_FREQUENCY = 20000  # 20kHz（モーター制御用、可聴域外）
PWM_RANGE = 255        # デューティサイクル範囲（0-255）

def main():
    print("=== DCモーター単体テスト（DRV8835 PHASE/ENABLEモード） ===")
    print(f"PHASE_PIN (方向): GPIO{PHASE_PIN}")
    print(f"ENABLE_PIN (速度): GPIO{ENABLE_PIN}")
    print(f"PWM周波数: {PWM_FREQUENCY}Hz")
    print()

    # pigpioに接続
    pi = pigpio.pi()
    if not pi.connected:
        print("ERROR: pigpioデーモンに接続できません")
        print("sudo pigpiod を実行してください")
        return

    try:
        # ピンの初期化
        pi.set_mode(PHASE_PIN, pigpio.OUTPUT)
        pi.set_PWM_frequency(ENABLE_PIN, PWM_FREQUENCY)
        pi.set_PWM_range(ENABLE_PIN, PWM_RANGE)

        # 初期状態: 停止
        pi.write(PHASE_PIN, 0)
        pi.set_PWM_dutycycle(ENABLE_PIN, 0)
        print("初期状態: 停止")
        time.sleep(1)

        # 前進テスト
        print()
        print("=== 前進テスト ===")
        pi.write(PHASE_PIN, 1)  # PHASE = HIGH → 正転

        for speed in [64, 128, 192, 255]:
            duty_percent = int(speed / 255 * 100)
            print(f"  速度: {duty_percent}%")
            pi.set_PWM_dutycycle(ENABLE_PIN, speed)
            time.sleep(1)

        # 停止
        print("  停止...")
        pi.set_PWM_dutycycle(ENABLE_PIN, 0)
        time.sleep(1)

        # 後進テスト
        print()
        print("=== 後進テスト ===")
        pi.write(PHASE_PIN, 0)  # PHASE = LOW → 逆転

        for speed in [64, 128, 192, 255]:
            duty_percent = int(speed / 255 * 100)
            print(f"  速度: {duty_percent}%")
            pi.set_PWM_dutycycle(ENABLE_PIN, speed)
            time.sleep(1)

        # 停止
        print("  停止...")
        pi.set_PWM_dutycycle(ENABLE_PIN, 0)
        time.sleep(1)

        # 加速・減速テスト
        print()
        print("=== 加速・減速テスト（前進） ===")
        pi.write(PHASE_PIN, 1)

        print("  加速中...")
        for speed in range(0, 256, 5):
            pi.set_PWM_dutycycle(ENABLE_PIN, speed)
            time.sleep(0.02)

        print("  減速中...")
        for speed in range(255, -1, -5):
            pi.set_PWM_dutycycle(ENABLE_PIN, speed)
            time.sleep(0.02)

        print()
        print("テスト完了")

    except KeyboardInterrupt:
        print("\n中断されました")

    finally:
        # 停止してクリーンアップ
        pi.set_PWM_dutycycle(ENABLE_PIN, 0)
        pi.write(PHASE_PIN, 0)
        pi.stop()
        print("クリーンアップ完了")

if __name__ == "__main__":
    main()
```

### 5.3 統合テスト（test_integrated.py）

```python
#!/usr/bin/env python3
"""
統合テスト - サーボ + DCモーター（DRV8835）
HBX 2192 全体動作確認用

使用方法:
    sudo pigpiod  # 事前にpigpioデーモンを起動
    python test_integrated.py
"""

import pigpio
import time

# ピン設定（BCM番号）
SERVO_PIN = 18    # サーボPWM
PHASE_PIN = 17    # モーター方向
ENABLE_PIN = 13   # モーター速度PWM

# サーボ設定
SERVO_CENTER = 1500
SERVO_LEFT = 2000
SERVO_RIGHT = 1000

# モーターPWM設定
PWM_FREQUENCY = 20000
PWM_RANGE = 255

def main():
    print("=== 統合テスト（サーボ + モーター） ===")
    print()

    pi = pigpio.pi()
    if not pi.connected:
        print("ERROR: pigpioデーモンに接続できません")
        return

    try:
        # 初期化
        pi.set_mode(PHASE_PIN, pigpio.OUTPUT)
        pi.set_PWM_frequency(ENABLE_PIN, PWM_FREQUENCY)
        pi.set_PWM_range(ENABLE_PIN, PWM_RANGE)

        # 初期位置
        pi.set_servo_pulsewidth(SERVO_PIN, SERVO_CENTER)
        pi.write(PHASE_PIN, 0)
        pi.set_PWM_dutycycle(ENABLE_PIN, 0)
        print("初期化完了（サーボ中央、モーター停止）")
        time.sleep(1)

        # テストパターン
        print()
        print("=== テストパターン実行 ===")

        # 1. 直進前進
        print("1. 直進前進")
        pi.set_servo_pulsewidth(SERVO_PIN, SERVO_CENTER)
        pi.write(PHASE_PIN, 1)
        pi.set_PWM_dutycycle(ENABLE_PIN, 128)
        time.sleep(2)

        # 2. 左折前進
        print("2. 左折前進")
        pi.set_servo_pulsewidth(SERVO_PIN, SERVO_LEFT)
        time.sleep(2)

        # 3. 右折前進
        print("3. 右折前進")
        pi.set_servo_pulsewidth(SERVO_PIN, SERVO_RIGHT)
        time.sleep(2)

        # 4. 直進に戻す
        print("4. 直進に戻す")
        pi.set_servo_pulsewidth(SERVO_PIN, SERVO_CENTER)
        time.sleep(1)

        # 5. 停止
        print("5. 停止")
        pi.set_PWM_dutycycle(ENABLE_PIN, 0)
        time.sleep(1)

        # 6. 直進後進
        print("6. 直進後進")
        pi.write(PHASE_PIN, 0)
        pi.set_PWM_dutycycle(ENABLE_PIN, 128)
        time.sleep(2)

        # 終了
        print("7. 完全停止")
        pi.set_PWM_dutycycle(ENABLE_PIN, 0)
        pi.set_servo_pulsewidth(SERVO_PIN, SERVO_CENTER)

        print()
        print("統合テスト完了")

    except KeyboardInterrupt:
        print("\n中断されました")

    finally:
        pi.set_PWM_dutycycle(ENABLE_PIN, 0)
        pi.write(PHASE_PIN, 0)
        pi.set_servo_pulsewidth(SERVO_PIN, 0)
        pi.stop()
        print("クリーンアップ完了")

if __name__ == "__main__":
    main()
```

---

## 6. 注意事項

### 6.1 電源投入順序

**推奨手順**:

```
1. 全ての配線を確認（接続状態、短絡がないこと）
2. Raspberry Piの電源を投入（または5V BECを接続）
3. pigpioデーモンを起動
   $ sudo pigpiod
4. GPIOを初期状態に設定（サーボ中央、モーター停止）
5. 7.4Vバッテリーを接続
6. Donkey Carアプリケーションを起動
```

**注意**: GPIOが初期化されていない状態でモーター電源を投入すると、予期しない動作（モーターの暴走）が発生する可能性があります。

### 6.2 GND共通化の重要性

**必ず以下のGNDを共通化してください**:

```
┌─────────────────────────────────────────────────────────┐
│ GND共通化ポイント（全て接続）                           │
├─────────────────────────────────────────────────────────┤
│ ・Raspberry Pi GND                                      │
│ ・DRV8835 GND                                           │
│ ・サーボ GND                                            │
│ ・7.4Vバッテリー -（マイナス）                          │
│ ・5V BEC GND（入出力共）                                │
└─────────────────────────────────────────────────────────┘
```

**GNDが共通化されていない場合の症状**:
- サーボが不安定に動作する
- モーターが正常に回転しない
- 制御信号が認識されない
- ノイズによる誤動作

### 6.3 ノイズ対策

#### モーターノイズ対策

370モーター（ブラシモーター）はノイズ源となります。以下の対策を推奨：

```
1. デカップリングコンデンサ
   - DRV8835のVIN-GND間に100μF電解コンデンサ
   - モーター端子間に0.1μFセラミックコンデンサ

2. フェライトビーズ
   - モーター電源線にフェライトビーズを挿入

3. 配線の分離
   - 信号線（GPIO）と電源線を離す
   - ツイストペアまたはシールド線の使用
```

```
          ┌───────────────────────┐
          │      370モーター      │
          │                       │
      + ──┼──┬──────────┬─────────│
          │  │          │         │
          │ ─┴─        ─┴─        │
          │ 0.1μF     0.1μF       │  ← セラミックコンデンサ
          │ ─┬─        ─┬─        │     （ノイズ吸収）
          │  │          │         │
      - ──┼──┴──────────┴─────────│
          │                       │
          └───────────────────────┘
```

#### 電源ノイズ対策

```
DRV8835 VIN端子付近に:
- 100μF 電解コンデンサ（低周波ノイズ対策）
- 0.1μF セラミックコンデンサ（高周波ノイズ対策）
を並列で配置

         7.4V ──┬──┬── VIN
                │  │
               ─┴──┴─
              100μF 0.1μF
               ─┬─ ─┬─
                │  │
         GND ───┴──┴── GND
```

### 6.4 保護回路（推奨）

#### 過電流保護

DRV8835には過電流保護が内蔵されていますが、追加の保護として：

```
・リセッタブルヒューズ（ポリスイッチ）
  定格: 2A（370モーターの定格を超える電流で遮断）
  接続位置: バッテリー+ → DRV8835 VIN の間

         7.4V+ ──[2A ヒューズ]── DRV8835 VIN
```

#### 逆接続保護

バッテリーの逆接続を防止するため：

```
・ショットキーダイオード
  型番例: SS34（3A 40V）
  接続: バッテリー+からVINへの向きに直列挿入

         7.4V+ ──▶|── DRV8835 VIN
               (SS34)
```

### 6.5 動作確認チェックリスト

```
□ 配線確認
  □ GNDが全て共通化されている
  □ 電源電圧が正しい（7.4V、5V）
  □ 信号線が正しいGPIOに接続されている
  □ DRV8835のMODEピンが3.3Vに接続されている

□ ソフトウェア確認
  □ pigpioデーモンが起動している（sudo pigpiod）
  □ myconfig.pyの設定が正しい
  □ DRIVE_TRAIN_TYPE = "SERVO_HBRIDGE_3PIN"

□ 動作テスト
  □ サーボが左右に動く（test_servo.py）
  □ モーターが正転する（test_motor.py）
  □ モーターが逆転する（test_motor.py）
  □ モーターの速度が変化する（test_motor.py）
  □ 統合テストが正常に完了する（test_integrated.py）

□ 安全確認
  □ 車両を持ち上げた状態でテスト（タイヤが空転する状態）
  □ 緊急停止方法を確認（Ctrl+C または バッテリー切断）
  □ 周囲に人や障害物がない状態で実車テスト
```

### 6.6 トラブルシューティング

| 症状 | 考えられる原因 | 対処法 |
|------|---------------|--------|
| サーボが動かない | GPIO未初期化、配線ミス、電源不足 | pigpiod確認、配線確認、5V BEC確認 |
| モーターが動かない | PHASE/ENABLEモード未選択、配線ミス | MODEピン確認（3.3V接続）、配線確認 |
| モーターが逆回転 | AOUT1/AOUT2の逆接続 | モーター端子を入れ替え |
| モーターが暴走 | GPIO未初期化状態で電源投入 | 電源投入順序を遵守 |
| 動作が不安定 | GND未共通化、ノイズ | GND配線確認、コンデンサ追加 |
| pigpioエラー | デーモン未起動 | `sudo pigpiod` を実行 |

---

## 参考資料

### データシート

- [DRV8835 データシート (Texas Instruments)](https://www.ti.com/lit/gpn/DRV8835)
- [370モーター仕様 (Handsontec)](https://www.handsontec.com/dataspecs/motor_fan/370-Motor.pdf)

### Donkey Car

- [Donkey Car Actuators Documentation](https://docs.donkeycar.com/parts/actuators/)
- [Donkey Car Pins Documentation](https://docs.donkeycar.com/parts/pins/)
- [Donkey Car Calibration Guide](https://docs.donkeycar.com/guide/calibrate/)

### 購入リンク

| 製品 | 価格 | リンク |
|------|------|--------|
| DRV8835モジュール | 550円 | https://akizukidenshi.com/catalog/g/g109848/ |
| MG90Sサーボ | 約500円 | https://akizukidenshi.com/catalog/g/g104028/ |
| SG90サーボ | 約300円 | https://akizukidenshi.com/catalog/g/g108761/ |

### その他の参考資料

- [Pololu DRV8835 Carrier](https://www.pololu.com/product/2135)
- [Raspberry Pi GPIO Pinout](https://pinout.xyz/)
- [pigpio Library](http://abyz.me.uk/rpi/pigpio/)

---

## 8. Donkey CarをDRV8835で動かす手順

このセクションでは、実際にDonkey CarアプリケーションをDRV8835モータードライバーで動作させるための完全な手順を説明します。

### 8.1 前提条件

#### 必要なソフトウェア

| ソフトウェア | バージョン | 用途 |
|-------------|-----------|------|
| **Raspberry Pi OS** | Bookworm 64-bit | 基本OS |
| **Python** | 3.11 | Bookworm標準 |
| **Donkey Car** | >= 5.1 | 自動運転フレームワーク |
| **pigpio** | 最新 | GPIO制御（ハードウェアPWM） |

#### インストール確認

```bash
# Donkey Carのバージョン確認
pip show donkeycar | grep Version

# pigpioのインストール確認
which pigpiod

# pigpioがインストールされていない場合
sudo apt install pigpio python3-pigpio
```

#### pigpiodデーモンの起動方法

**手動起動**:
```bash
sudo pigpiod
```

**自動起動設定**（推奨）:
```bash
# systemdサービスとして有効化
sudo systemctl enable pigpiod
sudo systemctl start pigpiod

# 状態確認
sudo systemctl status pigpiod
```

**起動確認**:
```bash
# プロセスが動作しているか確認
pgrep -a pigpiod
# 出力例: 1234 /usr/bin/pigpiod

# ソケットが開いているか確認
netstat -tln | grep 8888
# または
ss -tln | grep 8888
```

### 8.2 myconfig.pyの設定手順

#### 8.2.1 myconfigファイルの場所

Donkey Carを`donkey createcar --path ~/mycar`で作成した場合:

```
~/mycar/
├── manage.py          # メインスクリプト
├── config.py          # デフォルト設定（編集しない）
├── myconfig.py        # ユーザー設定（ここを編集）
├── calibrate.py       # キャリブレーションツール
└── data/              # 走行データ保存先
```

**myconfig.pyを編集**:
```bash
cd ~/mycar
nano myconfig.py
# または
vim myconfig.py
```

#### 8.2.2 DRIVE_TRAIN_TYPEの設定

以下の行を`myconfig.py`に追加または変更します:

```python
# ==============================================================================
# ドライブトレイン設定
# ==============================================================================
DRIVE_TRAIN_TYPE = "SERVO_HBRIDGE_3PIN"
```

#### 8.2.3 SERVO_HBRIDGE_3PINの完全な設定

DRV8835のPHASE/ENABLEモードに対応した設定:

```python
# ==============================================================================
# SERVO_HBRIDGE_3PIN 設定（DRV8835 PHASE/ENABLEモード対応）
# ==============================================================================
SERVO_HBRIDGE_3PIN = {
    # -------------------------------------------------------------------------
    # ステアリングサーボ設定
    # -------------------------------------------------------------------------
    # GPIO18（BCM）= Pin 12（BOARD）= ハードウェアPWM0
    "PWM_STEERING_PIN": "PIGPIO.BCM.18",

    # PWMスケール（60Hzベースからの補正、通常は1.0）
    "PWM_STEERING_SCALE": 1.0,

    # PWM反転（サーボによっては必要な場合あり）
    "PWM_STEERING_INVERTED": False,

    # ステアリングキャリブレーション値（donkey calibrateで測定）
    "STEERING_LEFT_PWM": 460,    # 左いっぱい時のPWM値
    "STEERING_RIGHT_PWM": 290,   # 右いっぱい時のPWM値

    # -------------------------------------------------------------------------
    # スロットル（モーター）設定 - DRV8835 PHASE/ENABLEモード
    # -------------------------------------------------------------------------
    # 正転方向ピン（APHASE）- TTL出力
    "FWD_PIN": "RPI_GPIO.BCM.17",    # GPIO17 = Pin 11

    # 逆転方向ピン（DRV8835では未使用だがDonkey Carが要求するためダミー指定）
    "BWD_PIN": "RPI_GPIO.BCM.27",    # GPIO27 = Pin 13（未接続でOK）

    # 速度PWMピン（AENBL）- ハードウェアPWM1
    "DUTY_PIN": "PIGPIO.BCM.13",     # GPIO13 = Pin 33
}
```

#### 8.2.4 ステアリングとスロットルのキャリブレーション値

| 設定項目 | 説明 | 典型的な範囲 |
|---------|------|-------------|
| `STEERING_LEFT_PWM` | 左いっぱい時のPWM値 | 400 - 500 |
| `STEERING_RIGHT_PWM` | 右いっぱい時のPWM値 | 250 - 350 |

**重要**: これらの値は12bit値（0-4095）で指定します。サーボによって適切な値が異なるため、必ずキャリブレーションで確認してください。

### 8.3 キャリブレーション手順

#### 8.3.1 `donkey calibrate`コマンドの使い方

**基本的な使用方法**:

```bash
cd ~/mycar

# PIGPIOピンのキャリブレーション（推奨）
donkey calibrate --pwm-pin "PIGPIO.BCM.18"

# RPI_GPIOピンのキャリブレーション
donkey calibrate --pwm-pin "RPI_GPIO.BCM.18"
```

**コマンドオプション**:

| オプション | 説明 | 例 |
|-----------|------|-----|
| `--pwm-pin` | 対象ピンの指定 | `"PIGPIO.BCM.18"` |
| `--pwmFreq` | PWM周波数 | `60`（デフォルト） |
| `--channel` | PCA9685チャンネル（I2C使用時） | `0` |
| `--bus` | I2Cバス番号 | `1` |
| `--address` | I2Cアドレス | `0x40` |

#### 8.3.2 サーボのキャリブレーション

**手順**:

```bash
# 1. pigpioデーモンを起動
sudo pigpiod

# 2. サーボピン（GPIO18）のキャリブレーションを開始
cd ~/mycar
donkey calibrate --pwm-pin "PIGPIO.BCM.18"
```

**キャリブレーション画面**:
```
init pin PIGPIO.BCM.18
Using PWM freq: 60

Enter a PWM setting to test ('q' for quit) (0-1500): _
```

**測定手順**:

1. **中央位置の確認**:
   ```
   Enter a PWM setting to test: 375
   ```
   サーボが中央（直進位置）になるPWM値を見つけます。典型的には370-380付近。

2. **左いっぱいの測定**:
   ```
   Enter a PWM setting to test: 460
   ```
   サーボが左いっぱいになるPWM値を測定。値を増やしていき、機械的な限界に近い値を見つけます。

3. **右いっぱいの測定**:
   ```
   Enter a PWM setting to test: 290
   ```
   サーボが右いっぱいになるPWM値を測定。値を減らしていき、機械的な限界に近い値を見つけます。

4. **終了**:
   ```
   Enter a PWM setting to test: q
   ```

**測定結果の記録例**:

| 位置 | PWM値 | 備考 |
|------|-------|------|
| 左いっぱい | 460 | `STEERING_LEFT_PWM` |
| 中央 | 375 | 参考値 |
| 右いっぱい | 290 | `STEERING_RIGHT_PWM` |

#### 8.3.3 モーターのキャリブレーション

**注意**: Donkey CarのSERVO_HBRIDGE_3PINモードでは、モーター（スロットル）のキャリブレーションは**ESCのように明示的なPWM値の設定は不要**です。

代わりに、`L298N_HBridge_3pin`クラスがスロットル値（-1.0〜1.0）をPWMデューティサイクル（0〜1.0）に自動変換します。

**動作確認方法**（テストコードを使用）:

```bash
# モーターテストスクリプトを実行
cd ~/mycar
python test_motor.py  # 第5章のテストコード使用
```

**スロットル値とモーター動作の対応**:

| スロットル値 | FWD_PIN | BWD_PIN | DUTY_PIN | モーター動作 |
|-------------|---------|---------|----------|-------------|
| 1.0 (全速前進) | HIGH | LOW | 90%デューティ | 正転（最高速） |
| 0.5 (半速前進) | HIGH | LOW | 45%デューティ | 正転（半速） |
| 0.0 (停止) | LOW | LOW | 0% | 停止（コースト） |
| -0.5 (半速後進) | LOW | HIGH | 45%デューティ | 逆転（半速） |
| -1.0 (全速後進) | LOW | HIGH | 90%デューティ | 逆転（最高速） |

#### 8.3.4 DRV8835特有の注意点

**1. MODEピンの接続**

```
DRV8835のMODEピンは必ず3.3Vに接続してください。
これによりPHASE/ENABLEモードが有効になります。

MODEピンが未接続（またはLOW）の場合:
  → IN/INモードになり、SERVO_HBRIDGE_3PINでは正常に動作しません
```

**2. BWD_PINの扱い**

```
DRV8835のPHASE/ENABLEモードでは、BWD_PINは実際には使用しません。
しかし、Donkey CarのL298N_HBridge_3pinクラスは3本のピンを要求するため、
ダミーピン（GPIO27など）を設定する必要があります。

このダミーピンは物理的に接続しなくても問題ありません。
```

**3. 電圧レベルの互換性**

```
DRV8835の入力はRaspberry Piの3.3V出力と互換性があります。
追加のレベルシフターは不要です。
```

### 8.4 動作確認手順

#### 8.4.1 pigpiodの起動確認

```bash
# 起動
sudo pigpiod

# 確認
pgrep pigpiod
# 出力があればOK（PID番号が表示される）

# 詳細確認
sudo systemctl status pigpiod
# Active: active (running) と表示されればOK
```

#### 8.4.2 `python manage.py drive`での起動

```bash
cd ~/mycar

# 基本起動
python manage.py drive

# ジョイスティック使用
python manage.py drive --js

# モデル使用（自動運転モード）
python manage.py drive --model models/mypilot.tflite
```

**起動時の出力例**:
```
loading config file: /home/pi/mycar/config.py
loading personal config over-rides from myconfig.py
config loaded
PiGPIO Connected
Starting vehicle at 20 Hz
```

**エラーがない場合の確認ポイント**:
- `PiGPIO Connected` が表示される
- `Starting vehicle at 20 Hz` が表示される
- エラーメッセージが出ていない

#### 8.4.3 Webインターフェースでの操作確認

**1. Webブラウザでアクセス**:

```
http://<Raspberry PiのIPアドレス>:8887
```

例: `http://192.168.1.100:8887`

**2. Web UIでの確認項目**:

| 操作 | 確認内容 |
|------|---------|
| ステアリングスライダー | サーボが左右に動く |
| スロットルスライダー | モーターが前進・後進する |
| モード切替 | User/Local Angle/Local の切替 |
| 録画ボタン | データ記録の開始・停止 |

#### 8.4.4 キーボード操作での確認

Web UIでキーボード操作を有効にした状態で:

| キー | 動作 |
|------|------|
| `i` または `↑` | 前進 |
| `k` または `↓` | 後進 |
| `j` または `←` | 左旋回 |
| `l` または `→` | 右旋回 |
| `スペース` | 停止 |
| `r` | 録画開始/停止 |

### 8.5 トラブルシューティング

#### pigpiodが起動しない場合

**症状**:
```
Can't connect to pigpio at localhost(8888)
```

**対処法**:
```bash
# 1. pigpiodを手動で起動
sudo pigpiod

# 2. それでも失敗する場合、既存のプロセスを終了して再起動
sudo killall pigpiod
sudo pigpiod

# 3. 権限の問題がある場合
sudo usermod -a -G gpio $USER
# ログアウト→ログイン

# 4. systemdサービスとして起動
sudo systemctl start pigpiod
```

#### モーターが動かない場合

**チェックリスト**:

| 確認項目 | 対処法 |
|---------|--------|
| 電源 | 7.4Vバッテリーの接続・電圧確認 |
| MODEピン | 3.3Vに接続されているか |
| GND共通化 | 全てのGNDが接続されているか |
| GPIO設定 | `FWD_PIN`と`DUTY_PIN`のピン番号確認 |
| ドライバー設定 | `DRIVE_TRAIN_TYPE = "SERVO_HBRIDGE_3PIN"` |

**テストコードでの確認**:
```bash
# 第5章のモーターテストコードを使用
python test_motor.py

# 動作すればハードウェアは正常
# → myconfig.pyの設定を確認
```

#### サーボが動かない場合

**チェックリスト**:

| 確認項目 | 対処法 |
|---------|--------|
| pigpiod | `pgrep pigpiod`で確認 |
| サーボ電源 | 5V BECからの給電確認 |
| 信号線 | GPIO18への接続確認 |
| GND | サーボGNDがPi GNDに接続されているか |
| PWM設定 | `"PWM_STEERING_PIN": "PIGPIO.BCM.18"` |

**テストコードでの確認**:
```bash
# 第5章のサーボテストコードを使用
python test_servo.py

# 動作すればハードウェアは正常
# → myconfig.pyの設定を確認
```

#### 方向が逆の場合の対処

**ステアリングが逆（左を指示すると右に動く）**:

```python
# 方法1: LEFT/RIGHTのPWM値を入れ替え
"STEERING_LEFT_PWM": 290,   # 元のRIGHT値
"STEERING_RIGHT_PWM": 460,  # 元のLEFT値

# 方法2: INVERTEDフラグを使用
"PWM_STEERING_INVERTED": True,
```

**モーターが逆（前進を指示すると後進する）**:

```
方法1（推奨）: DRV8835のAOUT1とAOUT2の配線を入れ替え

方法2: FWD_PINとBWD_PINの設定を入れ替え
  "FWD_PIN": "RPI_GPIO.BCM.27",  # 元のBWD_PIN
  "BWD_PIN": "RPI_GPIO.BCM.17",  # 元のFWD_PIN
```

### 8.6 実際のmyconfig.py設定例（コピペ可能）

以下はHBX 2192用の完全なmyconfig.py設定例です。そのままコピーして使用できます。

```python
# ==============================================================================
# myconfig.py - HBX 2192 + DRV8835 PHASE/ENABLEモード
# ==============================================================================
# 対象車両: HBX 2192（1モーター + 1サーボ構成）
# モータードライバー: DRV8835（PHASE/ENABLEモード）
# 作成日: 2026年1月28日
# ==============================================================================

# ==============================================================================
# ドライブトレイン設定
# ==============================================================================
DRIVE_TRAIN_TYPE = "SERVO_HBRIDGE_3PIN"

# ==============================================================================
# SERVO_HBRIDGE_3PIN 設定
# ==============================================================================
# DRV8835 PHASE/ENABLEモード対応
#
# 配線:
#   GPIO18 (BCM) → サーボ信号線
#   GPIO17 (BCM) → DRV8835 APHASE（方向制御）
#   GPIO13 (BCM) → DRV8835 AENBL（速度PWM）
#   3.3V         → DRV8835 MODE（PHASE/ENABLEモード選択）
#   GND          → DRV8835 GND, サーボGND
#
SERVO_HBRIDGE_3PIN = {
    # ステアリングサーボ設定
    "PWM_STEERING_PIN": "PIGPIO.BCM.18",    # GPIO18 = Pin 12
    "PWM_STEERING_SCALE": 1.0,
    "PWM_STEERING_INVERTED": False,
    "STEERING_LEFT_PWM": 460,               # 要キャリブレーション
    "STEERING_RIGHT_PWM": 290,              # 要キャリブレーション

    # モーター設定（DRV8835 PHASE/ENABLEモード）
    "FWD_PIN": "RPI_GPIO.BCM.17",           # GPIO17 = Pin 11 → APHASE
    "BWD_PIN": "RPI_GPIO.BCM.27",           # GPIO27 = Pin 13（ダミー、未接続でOK）
    "DUTY_PIN": "PIGPIO.BCM.13",            # GPIO13 = Pin 33 → AENBL
}

# ==============================================================================
# カメラ設定
# ==============================================================================
CAMERA_TYPE = "PICAM"        # Picamera2使用
IMAGE_W = 160                # 画像幅
IMAGE_H = 120                # 画像高さ
CAMERA_FRAMERATE = 20        # フレームレート

# ==============================================================================
# ドライブループ設定
# ==============================================================================
DRIVE_LOOP_HZ = 20           # 制御ループ周波数

# ==============================================================================
# ジョイスティック設定
# ==============================================================================
USE_JOYSTICK_AS_DEFAULT = False    # True: ジョイスティック優先
CONTROLLER_TYPE = 'xbox'           # 'xbox', 'ps4', 'F710', etc.

# ジョイスティック感度
JOYSTICK_MAX_THROTTLE = 0.5        # 最大スロットル（0.0-1.0）
JOYSTICK_STEERING_SCALE = 1.0      # ステアリング感度

# ==============================================================================
# 録画設定
# ==============================================================================
AUTO_RECORD_ON_THROTTLE = True     # スロットル入力で自動録画開始

# ==============================================================================
# Web UI設定
# ==============================================================================
WEB_CONTROL_PORT = 8887            # WebサーバーポートAdafruit

# ==============================================================================
# モデル設定（自動運転時）
# ==============================================================================
DEFAULT_MODEL_TYPE = 'linear'      # 'linear', 'categorical', etc.
```

**使用方法**:

1. 上記の内容を `~/mycar/myconfig.py` にコピー
2. キャリブレーションを実行して `STEERING_LEFT_PWM` と `STEERING_RIGHT_PWM` を調整
3. `python manage.py drive` で起動

---

## 関連資料

このガイドと関連する他の調査資料：

| 資料名 | 内容 | リンク |
|--------|------|--------|
| HBX2192制御調査 | HBX 2192の仕様と推奨構成 | [20260128-2010_HBX2192制御調査.md](./20260128-2010_HBX2192制御調査.md) |
| モータードライバーIC調査 | IC比較・選定の詳細 | [20260128-2100_モータードライバーIC調査.md](./20260128-2100_モータードライバーIC調査.md) |
| GPIO直接制御調査 | GPIO制御の全体像、ハードウェアPWM制限 | [20260128-2000_GPIO直接制御調査.md](./20260128-2000_GPIO直接制御調査.md) |
| PWM動作調査レポート | PCA9685の問題点（代替検討の背景） | [20260128-1730_PWM動作調査レポート.md](./20260128-1730_PWM動作調査レポート.md) |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026年1月28日 | 初版作成 - DRV8835配線ガイド（HBX 2192用） |
| 2026年1月28日 | セクション8追加 - Donkey CarをDRV8835で動かす手順 |
| 2026年1月28日 | 関連資料セクション追加 |
