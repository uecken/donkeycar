# Donkey Car 制御周期分析レポート

**作成日**: 2026年2月3日 16:20
**担当**: robotcar-engineer / ml-engineer
**目的**: センサー・カメラ・モデル推論の制御周期を明確化し、データ収集時と推論時の違いを理解する

---

## 1. 概要

Donkey Carのリアルタイム制御は **ドライブループ** を中心に構成されている。各パーツ（カメラ、センサー、モデル、アクチュエーター）は同期的または非同期的（スレッド）に動作する。

---

## 2. ドライブループ（メインループ）

### 2.1 基本設定

| 設定項目 | 値 | 周期 | 備考 |
|---------|-----|------|------|
| `DRIVE_LOOP_HZ` | 20 | 50ms | デフォルト値 |
| 実際の周期 | ≤20Hz | ≥50ms | パーツの処理時間により変動 |

### 2.2 ループ処理フロー

```
donkeycar/vehicle.py:151-168

while self.on:
    start_time = time.time()

    self.update_parts()  # 全パーツを順次更新

    sleep_time = 1.0 / rate_hz - (time.time() - start_time)
    if sleep_time > 0.0:
        time.sleep(sleep_time)  # 目標周期まで待機
    else:
        # ジッター警告: ループが遅延している
        logger.info('WARN::Vehicle: jitter violation...')
```

### 2.3 パーツ実行モード

| モード | 実行方法 | 特徴 |
|--------|---------|------|
| **同期** | `p.run(*inputs)` | ループ内で直接実行、ループをブロック |
| **非同期** | `p.run_threaded(*inputs)` | 別スレッドで`update()`が継続実行、最新値を取得 |

---

## 3. カメラの制御周期

### 3.1 PiCamera（Picamera2）

```python
# donkeycar/parts/camera.py:23-82

class PiCamera(BaseCamera):
    def __init__(self, ...):
        # FrameDurationLimitsで0.1-1ms制限（実際は遅い）
        self.camera.set_controls({"FrameDurationLimits": (100, 1000)})

    def update(self):  # 非同期スレッドで実行
        while self.on:
            self.run()  # 継続的にフレーム取得

    def run_threaded(self):  # ドライブループから呼ばれる
        return self.frame  # 最新フレームを返すのみ
```

| 項目 | 値 | 備考 |
|------|-----|------|
| 設定 | `CAMERA_FRAMERATE = DRIVE_LOOP_HZ` | 20fps |
| 実動作 | カメラ依存 | Pi Camera 3: 30-60fps可能 |
| ドライブループへの提供 | 最新フレーム | スレッドで継続取得 |

### 3.2 Webcam

```python
# donkeycar/parts/camera.py:85-170

class Webcam(BaseCamera):
    def __init__(self, ..., framerate=20, ...):
        self.framerate = framerate  # 明示的に設定
```

---

## 4. センサーの制御周期

### 4.1 IMU（MPU6050/MPU9250）

```python
# donkeycar/parts/imu.py:29

def __init__(self, ..., poll_delay=0.0166, ...):  # 約60Hz
    self.poll_delay = poll_delay

def update(self):  # 非同期スレッド
    while self.on:
        self.poll()
        time.sleep(self.poll_delay)  # 60Hzで継続ポーリング
```

| 項目 | 値 | 周期 |
|------|-----|------|
| `poll_delay` | 0.0166秒 | 約60Hz |
| MPU9250磁力計 | AK8963_MODE_C100HZ | 100Hz |
| ドライブループへの提供 | 最新値 | スレッドで継続取得 |

### 4.2 エンコーダー（GPIO/pigpio）

```python
# donkeycar/parts/encoder.py:129

def __init__(self, ..., poll_delay=0.0166, ...):  # 約60Hz
    self.poll_delay = poll_delay
```

| 項目 | 値 | 周期 |
|------|-----|------|
| `poll_delay` | 0.0166秒 | 約60Hz |
| 動作モード | 非同期（スレッド） | 継続的にカウント |

### 4.3 LiDAR（RPLidar A1M8）

```python
# donkeycar/parts/lidar.py:49-64

class RPLidar2:
    # 実測値: 7スキャン/秒、1846測定/秒
    def __init__(self, ..., batch_ms=50, ...):
        self.batch_ms = batch_ms  # run()でのバッチ時間
```

| 項目 | 値 | 備考 |
|------|-----|------|
| スキャンレート | 約7Hz | 1回転/スキャン |
| 測定レート | 約1846Hz | 個別距離測定 |
| `batch_ms` | 50ms | run()でのデータ収集時間 |

---

## 5. PWM/アクチュエーターの周期

### 5.1 PCA9685 PWMボード

```python
# donkeycar/parts/actuator.py:128-175

class PCA9685:
    def __init__(self, ..., frequency=60, ...):
        self.default_freq = 60  # デフォルト60Hz
        self.pwm.set_pwm_freq(frequency)
```

| 項目 | 設定値 | 備考 |
|------|--------|------|
| `STEERING_PWM_FREQ` | 50Hz | サーボ標準周波数 |
| `THROTTLE_PWM_FREQ` | 50Hz | ESC標準周波数 |
| デフォルト周波数 | 60Hz | 旧コードでの設定 |

### 5.2 PWM信号の更新タイミング

```
ドライブループ(20Hz) → PWM set_pulse() → PCA9685(50Hz)
                                              ↓
                                         物理サーボ/ESC
```

**重要**: ドライブループは20Hzでも、PWM信号自体は50Hzで連続出力される。ドライブループの更新が遅れても、前回のPWM値が維持される。

---

## 6. モデル推論の周期

### 6.1 推論タイミング

```python
# donkeycar/parts/keras.py:95-116

class KerasPilot(ABC):
    def run(self, img_arr, *other_arr):
        # ドライブループ内で同期実行
        norm_img_arr = normalize_image(img_arr)
        ...
        return self.inference_from_dict(input_dict)
```

**モデルは同期実行**のため、推論時間がドライブループをブロックする。

### 6.2 推論時間の目安

| プラットフォーム | モデル | 推論時間 | 実効周波数 |
|-----------------|--------|---------|-----------|
| Raspberry Pi 4 | TFLite (INT8量子化) | 20-40ms | 25-50Hz |
| Raspberry Pi 4 | TFLite (Float32) | 40-80ms | 12-25Hz |
| Raspberry Pi 4 | Keras (Full) | 100-200ms | 5-10Hz |
| Jetson Nano | TensorRT | 10-20ms | 50-100Hz |
| GTX 1660 Ti (学習用) | Keras | 5-10ms | 100-200Hz |

### 6.3 推論がドライブループに与える影響

```
DRIVE_LOOP_HZ = 20Hz → 目標周期: 50ms

例: 推論時間40msの場合
  - カメラ取得: 2ms
  - コントローラー: 1ms
  - モデル推論: 40ms  ← ボトルネック
  - アクチュエーター: 1ms
  - Tub書き込み: 5ms
  --------------------------
  合計: 49ms → 20Hzぎりぎり維持可能

例: 推論時間80msの場合
  合計: 89ms → 約11Hz（ジッター警告発生）
```

---

## 7. データ収集時 vs 推論時の違い

### 7.1 処理フロー比較

#### データ収集モード（手動運転）

```
[20Hzループ]
  ├─ カメラ取得 (threaded → 即座)
  ├─ コントローラー入力読み取り
  ├─ モード判定: user
  ├─ （モデル推論なし）
  ├─ アクチュエーター出力
  └─ Tub書き込み (約5ms)
```

| 項目 | 処理時間 | 備考 |
|------|---------|------|
| カメラ | <1ms | スレッドから最新値取得 |
| コントローラー | 1-2ms | ジョイスティック値読み取り |
| アクチュエーター | <1ms | I2C書き込み |
| Tub書き込み | 3-10ms | ディスクI/O |
| **合計** | **10-15ms** | 余裕あり |

#### 推論モード（自動運転）

```
[20Hzループ]
  ├─ カメラ取得 (threaded → 即座)
  ├─ コントローラー入力読み取り
  ├─ モード判定: local_angle/pilot
  ├─ モデル推論 (20-80ms) ← 追加処理
  ├─ アクチュエーター出力
  └─ Tub書き込み (オプション)
```

| 項目 | 処理時間 | 備考 |
|------|---------|------|
| カメラ | <1ms | スレッドから最新値取得 |
| コントローラー | 1-2ms | モード切替確認 |
| **モデル推論** | **20-80ms** | **ボトルネック** |
| アクチュエーター | <1ms | I2C書き込み |
| Tub書き込み | 3-10ms | オプション |
| **合計** | **25-95ms** | ジッターの可能性 |

### 7.2 タイミング図

```
データ収集モード (20Hz維持可能)
─────────────────────────────────────────────────────
|  Loop 1 (15ms)  |  sleep  |  Loop 2 (15ms)  | ...
─────────────────────────────────────────────────────
0ms              15ms      50ms             65ms

推論モード (TFLite INT8, 40ms推論)
─────────────────────────────────────────────────────
|    Loop 1 (50ms)    |    Loop 2 (50ms)    | ...
─────────────────────────────────────────────────────
0ms                  50ms                  100ms
           ↑ 20Hz維持

推論モード (TFLite Float32, 80ms推論)
─────────────────────────────────────────────────────
|      Loop 1 (90ms)      |      Loop 2 (90ms)      |
─────────────────────────────────────────────────────
0ms                      90ms                     180ms
           ↑ 約11Hzに低下（ジッター警告）
```

---

## 8. 同期の重要性

### 8.1 データ収集時の同期

```
Tubレコード構造:
{
    "cam/image_array": <画像>,      ← ループ開始時点のフレーム
    "user/angle": <操舵角>,         ← 同一ループ内の入力
    "user/throttle": <スロットル>,   ← 同一ループ内の入力
    "_timestamp_ms": <タイムスタンプ>
}
```

**注意点**:
- カメラはスレッドで継続取得しているため、ループ開始時の「最新」フレームが使用される
- コントローラー入力とのタイムラグは最大 `1/DRIVE_LOOP_HZ` (50ms)

### 8.2 推論時の同期

```
推論入力:
  - 画像: ループ開始時点の最新フレーム
  - IMU: ループ開始時点の最新値（使用時）

推論出力:
  - 角度/スロットル: 同一ループ内でアクチュエーターへ

レイテンシ:
  画像取得 → 推論完了 → PWM更新 = 推論時間 + 数ms
```

---

## 9. パフォーマンスモニタリング

### 9.1 プロファイラー

```python
# donkeycar/vehicle.py:20-58

class PartProfiler:
    def on_part_start(self, p):
        self.records[p]['times'].append(time.time())

    def on_part_finished(self, p):
        delta = now - prev
        self.records[p]['times'][-1] = delta

    def report(self):
        # 各パーツの max, min, avg, 50%, 90%, 99%, 99.9% を表示
```

### 9.2 プロファイルレポートの確認

```bash
python manage.py drive --verbose
# 200ループごとにプロファイルレポートが出力される
```

出力例:
```
Part Profile Summary: (times in ms)
+----------------+-------+------+-------+-------+-------+-------+--------+
|      part      |  max  | min  |  avg  |  50%  |  90%  |  99%  | 99.9%  |
+----------------+-------+------+-------+-------+-------+-------+--------+
|    PiCamera    |  2.50 | 0.10 |  0.50 |  0.45 |  0.80 |  1.50 |  2.00  |
| JoystickController | 1.20 | 0.08 | 0.15 | 0.12 | 0.25 | 0.80 | 1.00 |
|   KerasPilot   | 45.00 | 38.00| 41.50 | 41.00 | 43.00 | 44.50 | 44.90  |
|   PWMThrottle  |  0.80 | 0.10 |  0.20 |  0.18 |  0.30 |  0.50 |  0.70  |
|   TubWriter    |  8.00 | 2.00 |  4.50 |  4.00 |  6.00 |  7.50 |  7.90  |
+----------------+-------+------+-------+-------+-------+-------+--------+
```

---

## 10. 推奨設定

### 10.1 Raspberry Pi 4 向け推奨

| 項目 | 推奨値 | 理由 |
|------|--------|------|
| `DRIVE_LOOP_HZ` | 20 | 標準値、TFLite INT8なら維持可能 |
| `CAMERA_FRAMERATE` | 20 | ドライブループと同期 |
| モデル形式 | TFLite INT8 | 推論時間最小化 |
| IMU `poll_delay` | 0.0166 | 60Hz、十分な頻度 |

### 10.2 推論性能を最優先する場合

| 項目 | 設定 | 備考 |
|------|------|------|
| `DRIVE_LOOP_HZ` | 10-15 | 推論時間に合わせて下げる |
| モデル入力サイズ | 120x160 | 小さいほど高速 |
| モデル量子化 | INT8 | Float32より2-3倍高速 |

---

## 11. まとめ

| 項目 | データ収集時 | 推論時 |
|------|-------------|--------|
| メインループ周波数 | 20Hz (維持容易) | 10-20Hz (モデル依存) |
| カメラ | 20Hz (同期) | 20Hz (スレッド) |
| IMU | 60Hz (スレッド) | 60Hz (スレッド) |
| PWM出力 | 50Hz (連続) | 50Hz (連続) |
| ボトルネック | Tub書き込み (5-10ms) | **モデル推論 (20-80ms)** |
| ジッター発生 | まれ | 推論時間>50msで頻発 |

### 重要な注意点

1. **データ収集と推論の画像同期**
   - データ収集時: 画像とユーザー入力は同一ループ内
   - 推論時: 画像から推論結果までのレイテンシが発生

2. **スレッドパーツの最新値**
   - カメラ、IMUはスレッドで継続更新
   - ドライブループは「最新値」を取得するのみ
   - 厳密な同期は保証されない

3. **PWMの独立性**
   - ドライブループが遅延しても、PWM信号は前回値を維持
   - アクチュエーターは安定動作

---

## 関連資料

- [donkeycar/vehicle.py](../../donkeycar/vehicle.py) - ドライブループ実装
- [donkeycar/parts/camera.py](../../donkeycar/parts/camera.py) - カメラパーツ
- [donkeycar/parts/imu.py](../../donkeycar/parts/imu.py) - IMUパーツ
- [donkeycar/parts/keras.py](../../donkeycar/parts/keras.py) - モデル推論
- [donkeycar/parts/actuator.py](../../donkeycar/parts/actuator.py) - PWMアクチュエーター
