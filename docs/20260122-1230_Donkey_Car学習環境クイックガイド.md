# Donkey Car 学習環境クイックガイド

**作成日**: 2026年1月22日
**対象**: Donkey Car >= 5.1

---

## 1. 推奨構成の選択

| 構成 | 初期コスト | 月額 | 推奨ユーザー |
|------|-----------|------|-------------|
| **A: Google Colab** | 0円 | 0〜1,500円 | 初心者、趣味、低コスト重視 |
| **B: 自宅サーバー** | 3〜10万円 | 電気代のみ | 頻繁に学習、本格開発 |

---

## 2. 構成A: Google Colab（推奨：初心者向け）

### 概要

```
[Raspberry Pi] → [Google Drive] → [Google Colab] → [モデル]
                   データ保存        GPU学習(T4)
```

### スペック

| 項目 | 無料版 | Pro（$10/月） |
|------|-------|--------------|
| GPU | Tesla T4（16GB） | T4/V100/A100 |
| セッション | 12時間 | 24時間 |
| RAM | 12GB | 25GB |

### セットアップ手順

**Step 1**: [Colabノートブック](https://colab.research.google.com/github/robocarstore/donkey-car-training-on-google-colab/blob/master/Donkey_Car_Training_using_Google_Colab.ipynb)を開く

**Step 2**: ランタイム → GPUに変更

**Step 3**: セルを順番に実行

```python
# Donkey Carインストール
!git clone https://github.com/autorope/donkeycar.git
%cd donkeycar && !pip install -e .[pc]

# プロジェクト作成
!donkey createcar --path /content/mycar
%cd /content/mycar

# Driveマウント・データコピー
from google.colab import drive
drive.mount('/content/drive')
!cp -r /content/drive/MyDrive/tub_* ./data/

# 学習実行
!donkey train --tub ./data/tub_* --model ./models/mypilot.h5

# ダウンロード
from google.colab import files
files.download('./models/mypilot.tflite')
```

---

## 3. 構成B: 自宅サーバー（推奨：本格運用向け）

### 概要

```
[Raspberry Pi] ←rsync→ [自宅GPUサーバー] ←Cloudflare Tunnel→ [外出先]
                         Ubuntu + GTX1660
```

### 推奨スペック

| コンポーネント | エントリー | スタンダード |
|--------------|-----------|-------------|
| **GPU** | GTX 1660（6GB） | RTX 3060（12GB） |
| **CPU** | Core i5 / Ryzen 5 | Core i7 / Ryzen 7 |
| **RAM** | 16GB | 32GB |
| **OS** | Ubuntu 22.04 LTS | Ubuntu 22.04 LTS |
| **価格** | 約3-5万円（中古） | 約8-15万円 |

### GPU対応表（抜粋）

| GPU | VRAM | Compute Capability | 対応 |
|-----|------|-------------------|------|
| GTX 1660 | 6GB | 7.5 | **対応** |
| RTX 3060 | 12GB | 8.6 | **対応** |
| RTX 4070 | 12GB | 8.9 | **対応** |

### Ubuntuセットアップ

```bash
# 1. NVIDIAドライバ
sudo apt update && sudo ubuntu-drivers autoinstall && sudo reboot

# 2. CUDA 12.2
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
sudo dpkg -i cuda-keyring_1.1-1_all.deb
sudo apt update && sudo apt install -y cuda-toolkit-12-2 libcudnn8 libcudnn8-dev

# 3. 環境変数
echo 'export PATH=/usr/local/cuda-12.2/bin:$PATH' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH=/usr/local/cuda-12.2/lib64:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc

# 4. Donkey Car
conda create -n donkey python=3.11 -y && conda activate donkey
pip install donkeycar[pc] 'tensorflow[and-cuda]==2.15.*'

# 5. 確認
python -c "import tensorflow as tf; print('GPU:', tf.config.list_physical_devices('GPU'))"
```

### WSL2セットアップ（Windows）

```powershell
# PowerShell（管理者）
wsl --install Ubuntu-22.04
```

```bash
# Ubuntu (WSL2)内
sudo apt update && sudo apt install -y python3-pip libmtdev1 libgl1
echo 'export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libstdc++.so.6' >> ~/.bashrc

# CUDA（WSL2専用リポジトリ）
wget https://developer.download.nvidia.com/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-keyring_1.1-1_all.deb
sudo dpkg -i cuda-keyring_1.1-1_all.deb
sudo apt update && sudo apt install -y cuda-toolkit-12-3 libcudnn8 libcudnn8-dev

# 以降はUbuntuと同じ
```

> **重要**: WSL2内にNVIDIAドライバをインストール**しない**（Windows側ドライバを使用）

---

## 4. Cloudflare Tunnel（自宅サーバー外部公開）

### 帯域制限

| 項目 | 無料プラン |
|------|-----------|
| **帯域制限** | **なし** |
| **トンネル数** | 1,000個/アカウント |
| **月額** | **無料** |

### Donkey Car用途での評価

| データ | サイズ | 判定 |
|--------|-------|------|
| 10,000枚学習データ | 約30MB | 問題なし |
| 学習済みモデル | 約5MB | 問題なし |
| 1セッション転送量 | 約50MB | **十分対応可能** |

### 注意事項

- 動画ストリーミング（Plex等）は利用規約で非推奨
- 極端な大量トラフィックは有料プラン要請の可能性
- **Donkey Car学習用途は全く問題なし**

### セットアップ

```bash
# cloudflaredインストール
curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
chmod +x cloudflared && sudo mv cloudflared /usr/local/bin/

# ログイン・トンネル作成
cloudflared tunnel login
cloudflared tunnel create donkey-server

# 設定ファイル (~/.cloudflared/config.yml)
cat << 'EOF' > ~/.cloudflared/config.yml
tunnel: <TUNNEL_ID>
credentials-file: /home/$USER/.cloudflared/<TUNNEL_ID>.json
ingress:
  - hostname: donkey.example.com
    service: ssh://localhost:22
  - service: http_status:404
EOF

# DNS設定・起動
cloudflared tunnel route dns donkey-server donkey.example.com
cloudflared tunnel run donkey-server
```

---

## 5. 学習コマンド

```bash
# 基本学習
donkey train --tub ./data/tub_* --model ./models/mypilot.h5

# モデルタイプ指定
donkey train --tub ./data/tub_* --model ./models/mypilot.h5 --type categorical

# Raspberry Piへ転送
scp ./models/mypilot.tflite pi@<IP>:~/mycar/models/
```

### モデルタイプ

| タイプ | VRAM | 用途 |
|--------|------|------|
| `linear` | 2GB | 連続値出力（デフォルト） |
| `categorical` | 2GB | 離散カテゴリ（推奨） |
| `rnn` | 4GB | 時系列 |

---

## 6. 学習時間目安

| 環境 | 10,000枚 |
|------|----------|
| Raspberry Pi (CPU) | 非推奨 |
| MacBook M1 (CPU) | 約20分 |
| **GTX 1660 (GPU)** | **約2-3分** |
| **RTX 3060 (GPU)** | **約1分** |
| **Colab T4 (GPU)** | **約2-3分** |

---

## 7. トラブルシューティング

| 問題 | 解決策 |
|------|--------|
| GPUが認識されない | `nvidia-smi`確認、ドライバ更新 |
| TensorFlowがGPUを使わない | `pip install tensorflow[and-cuda]`で再インストール |
| WSL2でGPUエラー | WSL内にNVIDIAドライバを入れていないか確認 |
| Colabセッション切断 | Pro版検討、またはタブをアクティブに保つ |

---

## 8. 参考リンク

- [Donkey Car公式](https://docs.donkeycar.com/)
- [Robocarstore Colabノートブック](https://github.com/robocarstore/donkey-car-training-on-google-colab)
- [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/)
- [TensorFlow GPU](https://www.tensorflow.org/install/pip)

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026年1月22日 | 初版作成 - 2構成統合、Cloudflare Tunnel追記 |
