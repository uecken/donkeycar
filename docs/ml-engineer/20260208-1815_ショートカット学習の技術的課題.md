# ショートカット学習の技術的課題

**作成日**: 2026年2月8日 18:15
**担当**: ml-engineer + robotcar-engineer
**目的**: 模倣学習でショートカット（100度右折）が学習可能か技術的に検証

---

## 1. 問題の定義

### 1.1 現状の質問

```
【質問】
ショートカットは100度程度右に曲がる必要がある。
同じような画像で「直進」と「100度右折」の2パターンがある場合、
模倣学習モデルは判断できるのか？
```

### 1.2 図解

```
              直進ルート
                 ↑
                 │
    ┌────────────┼────────────┐
    │            │            │
    │    ●───────┤            │  ← この地点の画像が似ている場合
    │    ↓       │            │
    │  ショート   │            │
    │  カット    │            │
    │  (100度右) │            │
    └────────────┴────────────┘
```

---

## 2. 技術的回答

### 2.1 結論

```
【結論】
画像が「十分に異なる」場合 → ショートカット学習可能
画像が「ほぼ同じ」場合   → モデルは混乱する（中間値を出力）
```

### 2.2 模倣学習の根本的制約

模倣学習（Behavioral Cloning）は以下の関数を学習する:

```
f(画像) → (steering, throttle)
```

**問題**: 同じ入力（画像）に対して異なる出力が期待される場合

| 画像 | 期待される出力A | 期待される出力B | 問題 |
|------|----------------|----------------|------|
| 同じ画像 | steering = 0.0（直進） | steering = 0.8（100度右） | **マルチモーダル問題** |

### 2.3 マルチモーダル問題とは

```
【学習データ】
画像X → steering = 0.0（直進データ）
画像X → steering = 0.8（ショートカットデータ）

【モデルの学習結果】
MSE損失を最小化 → 中間値を学習
画像X → steering ≈ 0.4（どちらでもない値）

【結果】
直進もショートカットもできない「中途半端な動き」
```

---

## 3. 画像が「異なる」ケース（学習可能）

### 3.1 視覚的に区別できる場合

```
【直進ポイントの画像】          【ショートカットポイントの画像】
┌─────────────────┐            ┌─────────────────┐
│    コースライン   │            │   ショートカット  │
│    ────────────  │            │   への分岐点     │
│                  │            │     ┌──┐        │
│                  │            │     └──┘ 目印    │
└─────────────────┘            └─────────────────┘
     → steering = 0.0                → steering = 0.8
```

**条件**:
- ショートカット入口に視覚的な目印がある
- コースの形状が明確に異なる
- 背景や周囲の環境が異なる

### 3.2 学習可能なケース

| 要素 | 直進ポイント | ショートカットポイント | 判断 |
|------|-------------|---------------------|------|
| コースライン | 直線 | 分岐あり | ✅ 区別可能 |
| 周囲の目印 | なし | コーン等 | ✅ 区別可能 |
| 背景 | 壁 | 開けた空間 | ✅ 区別可能 |

---

## 4. 画像が「同じ」ケース（学習困難）

### 4.1 視覚的に区別できない場合

```
【直進ポイントの画像】          【ショートカットポイントの画像】
┌─────────────────┐            ┌─────────────────┐
│    コースライン   │            │    コースライン   │
│    ────────────  │            │    ────────────  │
│                  │            │                  │
│    （同じ画像）   │            │    （同じ画像）   │
└─────────────────┘            └─────────────────┘
     → steering = 0.0                → steering = 0.8 ???
```

**問題**:
- 同じ画像に対して異なる操作を期待
- モデルは平均値を学習してしまう

### 4.2 具体的な症状

```python
# 学習データ
データ1: 画像A → steering = 0.0  # 直進
データ2: 画像A → steering = 0.8  # ショートカット（ほぼ同じ画像）

# MSE損失の最小化
損失 = (0.0 - 予測)^2 + (0.8 - 予測)^2
     → 予測 = 0.4 で最小

# 結果
モデル出力: steering ≈ 0.4
→ 直進でもショートカットでもない、中途半端な動き
```

---

## 5. 解決策

### 5.1 解決策一覧

| 解決策 | 難易度 | 効果 | Donkeycar対応 |
|--------|--------|------|---------------|
| **A. 視覚的目印を追加** | 低 | 高 | ✅ 対応不要 |
| **B. Behaviorモデル** | 中 | 高 | ✅ 標準搭載 |
| **C. Localizerモデル** | 中 | 中 | ✅ 標準搭載 |
| D. RNN/LSTMモデル | 高 | 中 | ✅ 標準搭載 |
| E. 位置情報入力 | 高 | 高 | 要カスタム |

### 5.2 解決策A: 視覚的目印を追加（推奨）

**最もシンプルで効果的な方法**

```
【対策】
ショートカット入口に視覚的な目印を設置

例:
- コーン
- テープ
- 色付きマーカー
- 特徴的な模様

【効果】
モデルは「目印がある → ショートカット」と学習
画像が異なるため、マルチモーダル問題を回避
```

### 5.3 解決策B: Behaviorモデル

**モード（直進/ショートカット）を明示的に入力**

```python
# donkeycar/parts/keras.py:537-573
class KerasBehavioral(KerasCategorical):
    """
    A Keras part that take an image and Behavior vector as input,
    outputs steering and throttle
    """

# 入力
# - 画像
# - behavior_one_hot: [1, 0] = 直進モード, [0, 1] = ショートカットモード

# 使用方法
# ボタンでモード切替 → モデルがモードに応じた操作を出力
```

**設定例**:
```python
# myconfig.py
BEHAVIOR_LIST = ["normal", "shortcut"]
BEHAVIOR_LED_COLORS = [(0, 10, 0), (10, 0, 10)]  # 緑=直進, 紫=ショートカット
```

**データ収集**:
1. 直進モードでコース周回データを収集
2. ショートカットモードでショートカットデータを収集
3. 両方のデータで学習

**推論時**:
- ショートカット地点でボタンを押してモード切替
- または自動でモード切替（要カスタム実装）

### 5.4 解決策C: Localizerモデル

**位置情報を同時に出力するモデル**

```python
# donkeycar/parts/keras.py:576-618
class KerasLocalizer(KerasPilot):
    """
    A Keras part that take an image as input,
    outputs steering and throttle, and localisation category
    """
    # 出力: angle, throttle, location (0-7の位置ID)
```

**使用方法**:
1. コースを8分割して位置IDを定義
2. 各画像に位置IDをラベリング
3. モデルは位置を認識しながら操作を学習

**限界**:
- 位置の学習精度に依存
- ショートカット判断には追加ロジックが必要

### 5.5 解決策D: RNN/LSTMモデル

**時系列情報を活用**

```python
# donkeycar/parts/keras.py:992-1036
def rnn_lstm(seq_length=3, num_outputs=2, input_shape=(120, 160, 3)):
    # 過去3フレームの画像を入力
    img_seq_shape = (seq_length,) + input_shape
```

**原理**:
- 「どこから来たか」の情報を活用
- 直進ルートから来た → 直進継続
- ショートカット方向から来た → ショートカット継続

**限界**:
- 分岐点での最初の判断は困難
- 推論速度が遅くなる可能性

---

## 6. 現プロジェクトへの推奨

### 6.1 推奨アプローチ

```
【第1優先】解決策A: 視覚的目印を追加
  ↓ 効果なしの場合
【第2優先】解決策B: Behaviorモデル
```

### 6.2 具体的な手順

#### ステップ1: 視覚的目印で検証

```
1. ショートカット入口にコーンまたはテープを設置
2. 直進データを収集（目印なしの通常ルート）
3. ショートカットデータを収集（目印ありの分岐点で右折）
4. 両方のデータで学習
5. 推論テスト
```

#### ステップ2: Behaviorモデルで検証（目印が使えない場合）

```
1. myconfig.py に BEHAVIOR_LIST を設定
2. 直進モードでデータ収集
3. ショートカットモードでデータ収集
4. --type behavior で学習
5. 推論時にボタンでモード切替
```

---

## 7. 技術的詳細

### 7.1 なぜ中間値になるか（数学的説明）

```
MSE損失関数:
L = (1/N) * Σ (y_true - y_pred)^2

データ:
  画像A → y1 = 0.0 (直進)
  画像A → y2 = 0.8 (ショートカット)

最適な予測値:
  dL/d(y_pred) = 0
  → y_pred = (y1 + y2) / 2 = 0.4

結論: 平均値を出力するのが損失最小
```

### 7.2 Behaviorモデルの原理

```
入力: 画像 + behavior_one_hot

画像A + [1, 0] (直進モード) → steering = 0.0
画像A + [0, 1] (ショートカットモード) → steering = 0.8

→ 入力が異なるため、異なる出力を学習可能
```

---

## 8. まとめ

### 8.1 質問への回答

| 質問 | 回答 |
|------|------|
| 模倣学習でショートカットは学習可能か？ | **条件付きで可能** |
| 同じ画像で直進/ショートカットを判断できるか？ | **できない（中間値を出力）** |
| 解決策は？ | **視覚的目印** または **Behaviorモデル** |

### 8.2 推奨アクション

```
【robotcar-engineer へ】
1. ショートカット入口に視覚的目印（コーン、テープ）を設置可能か確認
2. 可能なら目印を設置してデータ収集

【ml-engineer へ】
1. まず視覚的目印ありでlinearモデルを試す
2. 効果なしならbehaviorモデルに切り替え

【現実的な判断】
- 目印設置が最もシンプルで効果的
- 大会ルールで目印が禁止なら Behaviorモデルを検討
```

---

## 9. 関連資料

- [20260208-1745_JetRacer_vs_Donkeycar比較.md](20260208-1745_JetRacer_vs_Donkeycar比較.md) - 学習方式の比較
- [20260203-1700_DonkeyCar学習推論詳細ガイド.md](20260203-1700_DonkeyCar学習推論詳細ガイド.md) - モデルタイプの詳細
- [donkeycar/parts/keras.py](../../donkeycar/parts/keras.py) - Behaviorモデル実装
- [donkeycar/parts/behavior.py](../../donkeycar/parts/behavior.py) - Behaviorパーツ

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-08 18:15 | 初版作成 |
