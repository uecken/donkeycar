# モデル推論データ解析レポート

**作成日**: 2026年2月3日 15:20
**担当**: ml-engineer, robotcar-engineer（共同作業）
**対象モデル**: picopico_racers/mycar/models/mypilot.tflite

---

## 1. 解析概要

### 1.1 対象モデル情報

| 項目 | 値 |
|------|-----|
| **モデルファイル** | `picopico_racers/mycar/models/mypilot.tflite` |
| **モデルタイプ** | KerasLinear (TFLite変換済み) |
| **入力形状** | [1, 120, 160, 3] (RGB画像) |
| **出力** | angle (操舵角), throttle (スロットル) |
| **解析日** | 2026-02-03 |

### 1.2 解析目的

自動運転モデルの推論出力値とPWM制御への変換プロセスを検証し、実車での動作品質を改善するための知見を得る。

---

## 2. データ収集設定（実際の myconfig.py）

### 2.1 スロットル設定

```python
# ジョイスティック設定
JOYSTICK_MAX_THROTTLE = 1.0     # フルレンジで学習データ収集
JOYSTICK_THROTTLE_DIR = -1.0    # スティック上が前進

# PWM設定（HBX 2192 ESC用）
PWM_STEERING_THROTTLE = {
    "THROTTLE_FORWARD_PWM": 324,    # 実際: 1582μs
    "THROTTLE_STOPPED_PWM": 307,    # 実際: 1499μs
    "THROTTLE_REVERSE_PWM": 287,    # 実際: 1401μs
}
```

### 2.2 ステアリング設定

```python
PWM_STEERING_THROTTLE = {
    "STEERING_LEFT_PWM": 460,       # 左最大
    "STEERING_RIGHT_PWM": 230,      # 右最大
}
```

### 2.3 PWM値とパルス幅の対応

| 設定項目 | PWM値 | パルス幅 (μs) | 備考 |
|---------|-------|--------------|------|
| THROTTLE_FORWARD_PWM | 324 | 1582μs | 前進最大 |
| THROTTLE_STOPPED_PWM | 307 | 1499μs | 停止（ニュートラル） |
| THROTTLE_REVERSE_PWM | 287 | 1401μs | 後退最大 |

**パルス幅計算式**:
```
パルス幅(μs) = PWM値 / 4096 × 20000μs（50Hz時）
```

---

## 3. 学習結果の評価

### 3.1 学習パラメータ

| パラメータ | 設定値 |
|-----------|--------|
| BATCH_SIZE | 128 |
| TRAIN_TEST_SPLIT | 0.8 |
| MAX_EPOCHS | 100 |
| USE_EARLY_STOP | True |
| EARLY_STOP_PATIENCE | 5 |
| MIN_DELTA | 0.0005 |

### 3.2 学習結果サマリー

| 指標 | 値 | 評価 |
|------|-----|------|
| **学習エポック** | 12（Early Stop） | 早期終了 |
| **Best Epoch** | 6 | - |
| **Best Val Loss** | 0.226 | - |
| **Val Angle Loss** | 0.079 | 良好 |
| **Val Throttle Loss** | 0.147 | 改善必要 |

### 3.3 Loss曲線の分析

```
Epoch | Train Loss | Val Loss  | 状態
------|------------|-----------|------
1     | 0.485      | 0.312     | 正常減少
2     | 0.298      | 0.267     | 正常減少
3     | 0.342      | 0.251     | ★Train Lossスパイク
4     | 0.265      | 0.238     | 回復
5     | 0.248      | 0.231     | 正常
6     | 0.234      | 0.226     | ★Best (保存)
7     | 0.228      | 0.229     | 微増
8     | 0.241      | 0.232     | ★Train Lossスパイク
9     | 0.222      | 0.230     | 回復
10    | 0.235      | 0.233     | ★Train Lossスパイク
11    | 0.219      | 0.231     | 改善なし
12    | 0.215      | 0.230     | Early Stop発動
```

**問題点**:
- Train Lossに複数のスパイク（epoch 3, 8, 10）
- 学習データに外れ値または分布の偏りが存在する可能性

---

## 4. 問題点の特定

### 4.0 【重大】JOYSTICK_THROTTLE_DIR 反転バグ（根本原因）

**発見日**: 2026-02-03
**深刻度**: 致命的（全学習データが影響）

#### 4.0.1 問題の概要

Xbox コントローラーの軸値と `JOYSTICK_THROTTLE_DIR = -1.0` の組み合わせにより、**学習データのスロットル値が完全に反転**している。

#### 4.0.2 Xbox コントローラーの軸値

| 状態 | 生の軸値 | 正規化後 (-1.0〜+1.0) |
|------|---------|---------------------|
| ボタン離す | -32765 | -1.0 |
| ボタン押す | +32765 | +1.0 |

**正規化計算**: `axis_val = raw_value / 32767`

#### 4.0.3 スロットル計算の問題

Donkey Car のスロットル計算式（`donkeycar/parts/controller.py`）:

```python
self.throttle = self.throttle_dir * axis_val * self.throttle_scale
```

**現在の設定**:
- `JOYSTICK_THROTTLE_DIR = -1.0`（myconfig.py でデフォルト値を使用）
- `JOYSTICK_MAX_THROTTLE = 1.0`（throttle_scale）

#### 4.0.4 反転の証明

| 操作 | axis_val | throttle_dir | throttle_scale | 結果 throttle | 意図 |
|------|---------|--------------|----------------|---------------|------|
| **ボタン離す** | -1.0 | -1.0 | 1.0 | **+1.0 (前進!)** | 停止 |
| **ボタン押す** | +1.0 | -1.0 | 1.0 | **-1.0 (後退!)** | 前進 |

**計算式**:
```
ボタン離す: throttle = (-1.0) × (-1.0) × 1.0 = +1.0  ← 停止したいのに前進
ボタン押す: throttle = (+1.0) × (-1.0) × 1.0 = -1.0  ← 前進したいのに後退
```

#### 4.0.5 学習への影響

**学習データの状態**:
- 「直進シーン」→ 実際は throttle = -1.0（後退）として記録
- 「停止シーン」→ 実際は throttle = +1.0（前進）として記録
- **モデルは「壁に向かって加速」「直線で減速」を学習**

**これが説明する症状**:
1. ✅ 壁に向いていても Throttle が動く → モデルは「停止 = 前進」と学習
2. ✅ STEERING がほぼ動かない → throttle 反転による学習データの破損

#### 4.0.6 myconfig.py の該当箇所

```python
# picopico_racers/mycar/myconfig.py

# 明示的な設定なし（デフォルト値が使用される）
# cfg_complete.py のデフォルト:
# JOYSTICK_THROTTLE_DIR = -1.0  ← これが問題
```

**注**: Xbox コントローラーでは `JOYSTICK_THROTTLE_DIR = +1.0` が正しい設定。

#### 4.0.7 修正方法

**オプション1: myconfig.py を修正してデータを再収集（推奨）**

```python
# picopico_racers/mycar/myconfig.py に追加
JOYSTICK_THROTTLE_DIR = 1.0  # Xbox コントローラー用（+1.0 に変更）
```

その後、全データを再収集し、再学習する。

**オプション2: 既存モデルの出力を反転（応急処置）**

```python
# 推論時に throttle を反転
throttle_output = -1.0 * model_throttle_output
```

**推奨**: オプション1（データ再収集）。根本的な解決のため。

---

### 4.1 スロットル精度の問題

**Val Throttle Loss = 0.147 の解釈**:

```
RMSE = √0.147 ≈ 0.38
```

これは、モデル出力のthrottle値に約±0.38の誤差があることを意味する。

**実際の影響**:
- throttle範囲: -1.0 〜 +1.0
- 誤差 ±0.38 → 約38%の不確実性
- 停止（0.0）を指示しても、-0.38〜+0.38の出力が発生

### 4.2 学習データのthrottle分布

**推測される問題**:

学習データ収集時の操作パターン:
1. 停止〜低速域に集中（安全運転）
2. 高速域のデータが少ない
3. 急加速/急減速のサンプルが不足

```
throttle分布（推定）:
 -1.0 ████            (少ない)
 -0.5 ██████████      (中程度)
  0.0 ████████████████████████████  (多い: 停止/徐行)
 +0.5 ████████████    (中程度)
 +1.0 ████            (少ない)
```

### 4.3 モデル出力とESC動作の関係

| モデル出力 | 意図 | 実際のPWM | ESC動作 |
|-----------|------|----------|--------|
| +0.5 | 中速前進 | 315 | 前進（弱） |
| +0.1 | 微速前進 | 309 | **停止（デッドバンド内）** |
| 0.0 | 停止 | 307 | 停止 |
| -0.1 | 微速後退 | 305 | **停止（デッドバンド内）** |
| -0.5 | 中速後退 | 297 | 後退（弱） |

**問題**: ESCにはデッドバンド（ニュートラル付近の不感帯）があり、微小なthrottle出力では動作しない。

---

## 5. PWM設定の検証

### 5.1 myconfig.pyコメントの検証

現在のmyconfig.pyには以下のコメントが含まれている:

```python
"THROTTLE_FORWARD_PWM": 324,    # 1370us ← 誤り
"THROTTLE_STOPPED_PWM": 307,    # 1500us ← 正しい
"THROTTLE_REVERSE_PWM": 287,    # 1610us ← 誤り
```

**正しいパルス幅**:

| 設定項目 | PWM値 | 正しいパルス幅 | コメント値 | 判定 |
|---------|-------|---------------|-----------|------|
| THROTTLE_FORWARD_PWM | 324 | **1582μs** | 1370us | 誤り |
| THROTTLE_STOPPED_PWM | 307 | **1499μs** | 1500us | 正しい |
| THROTTLE_REVERSE_PWM | 287 | **1401μs** | 1610us | 誤り |

**計算**:
```
PWM 324: 324 / 4096 × 20000 = 1582μs（前進最大）
PWM 307: 307 / 4096 × 20000 = 1499μs（停止）
PWM 287: 287 / 4096 × 20000 = 1401μs（後退最大）
```

**結論**: **PWM値自体は正しいが、コメントのμs値が誤っている**（入れ替わっている）。

### 5.2 有効スロットル範囲の計算

**前進方向**:
```
PWM範囲: 307 → 324 = 17単位
パルス幅範囲: 1499μs → 1582μs = 83μs
```

**後退方向**:
```
PWM範囲: 307 → 287 = 20単位
パルス幅範囲: 1499μs → 1401μs = 98μs
```

**合計有効範囲**: PWM 37単位（181μs）

この範囲は標準的なESC（1000〜2000μs = 1000μs範囲）と比較して非常に狭い（約18%）。

---

## 6. robotcar-engineer への確認事項

### 6.1 ESCデッドバンドの実測依頼

**測定項目**:

| 測定項目 | 目的 | 測定方法 |
|---------|------|---------|
| **前進開始PWM** | デッドバンド上限特定 | PWM 307から徐々に増加し、車輪が回転し始める値を記録 |
| **後退開始PWM** | デッドバンド下限特定 | PWM 307から徐々に減少し、車輪が回転し始める値を記録 |
| **デッドバンド幅** | 不感帯の範囲 | 上記2値の差分 |

**推奨測定手順**:

```bash
# Raspberry Pi で実行
cd ~/mycar

# キャリブレーションツールで段階的にPWM値を変更
python3 -c "
from donkeycar.parts.actuator import PCA9685Controller
import time

pca = PCA9685Controller(channel=0, address=0x40, frequency=50)

# 停止値から開始
for pwm in range(307, 330):  # 前進方向
    print(f'PWM: {pwm}')
    pca.set_duty_cycle(pwm)
    time.sleep(1)
    input('車輪が回転したらEnter: ')
"
```

### 6.2 確認が必要な項目

| 確認項目 | 現在の推測値 | 確認優先度 |
|---------|-------------|-----------|
| 前進開始PWM | 310〜315? | 高 |
| 後退開始PWM | 300〜305? | 高 |
| ESC応答遅延 | 50〜100ms? | 中 |
| 低速域の線形性 | 不明 | 中 |

---

## 7. 改善提案（優先度順）

### 7.1 即時対応: AI_THROTTLE_MULT の設定

**設定**:
```python
# myconfig.py に追加
AI_THROTTLE_MULT = 2.0  # モデル出力を2倍に増幅
```

**効果**:
- モデル出力 0.25 → 実効値 0.50
- デッドバンドを超えやすくなる
- 低速域での応答性向上

**注意点**:
- 値が大きすぎると急発進のリスク
- 推奨範囲: 1.5〜3.0
- 実車テストで調整

### 7.2 短期対応: ESCデッドバンドの実測

**目的**: 正確なデッドバンド値を把握し、モデル出力の有効範囲を最大化

**期待される成果**:
- AI_THROTTLE_MULT の最適値を決定
- 必要に応じてPWM設定値の調整

### 7.3 中期対応: 高速走行データを追加して再学習

**データ収集ガイドライン**:

| データタイプ | 収集比率 | 目的 |
|-------------|---------|------|
| 停止/徐行 | 30% | 安全停止の学習 |
| 中速走行 | 40% | 基本的な走行パターン |
| 高速走行 | 20% | 高速域の精度向上 |
| 急加減速 | 10% | 過渡応答の学習 |

**収集時のJOYSTICK_MAX_THROTTLE設定**:

| フェーズ | 設定値 | 目的 |
|---------|--------|------|
| 安全確認走行 | 0.3 | コース確認 |
| 通常データ収集 | 0.5〜0.7 | メインデータ |
| 高速データ収集 | 0.8〜1.0 | 高速域データ |

### 7.4 長期対応: モデルアーキテクチャの検討

**現在の問題**: KerasLinearモデルは単純な回帰であり、throttle値の精度が低い

**検討オプション**:

| オプション | メリット | デメリット |
|-----------|---------|-----------|
| categorical モデル | 離散化による安定性 | 出力が段階的 |
| memory (LSTM) | 時系列情報の活用 | 計算コスト増 |
| behavior モデル | 状況依存の学習 | データ量が必要 |

---

## 8. 関連資料

### 8.1 ml-engineer 資料

| 資料名 | パス | 内容 |
|--------|------|------|
| 自動運転モデル動作確認ガイド | `docs/ml-engineer/20260202-0150_自動運転モデル動作確認ガイド.md` | TFLiteモデルの動作確認方法、デバッグツール |
| DonkeyCar自動運転ガイド | `docs/ml-engineer/20260129-2330_DonkeyCar自動運転ガイド.md` | 自動運転の基本設定 |
| モデル検証機能ガイド | `docs/ml-engineer/20260203-1450_Donkey_Car_モデル検証機能ガイド.md` | モデル検証手法 |

### 8.2 robotcar-engineer 資料

| 資料名 | パス | 内容 |
|--------|------|------|
| ジョイスティック値とPWM幅の関係 | `docs/robotcar-engineer/20260130-0010_ジョイスティック値とPWM幅の関係.md` | PWM変換の詳細解説、計算式 |
| HBX2192制御調査 | `docs/robotcar-engineer/20260128-2010_HBX2192制御調査.md` | HBX 2192 ESCの仕様、制御方法 |
| PWM動作調査レポート | `docs/robotcar-engineer/20260128-1730_PWM動作調査レポート.md` | PCA9685の動作検証 |

---

## 9. 付録: PWM計算ツール

### 9.1 throttle値からPWM値への変換

```python
def throttle_to_pwm(throttle, stopped=307, forward=324, reverse=287):
    """
    throttle値をPWM値に変換

    Args:
        throttle: -1.0 〜 +1.0
        stopped: 停止時のPWM値
        forward: 前進最大時のPWM値
        reverse: 後退最大時のPWM値

    Returns:
        PWM値 (整数)
    """
    if throttle > 0:
        return int(throttle * (forward - stopped) + stopped)
    else:
        return int((throttle + 1) * (stopped - reverse) + reverse)

# 使用例
print(f"throttle +0.5 → PWM {throttle_to_pwm(0.5)}")   # 315
print(f"throttle  0.0 → PWM {throttle_to_pwm(0.0)}")   # 307
print(f"throttle -0.5 → PWM {throttle_to_pwm(-0.5)}")  # 297
```

### 9.2 PWM値からパルス幅への変換

```python
def pwm_to_us(pwm_value, freq_hz=50):
    """PWM値からパルス幅(μs)を計算"""
    period_us = 1_000_000 / freq_hz  # 50Hz → 20000μs
    return pwm_value / 4096 * period_us

# HBX 2192の設定値検証
print(f"PWM 324 → {pwm_to_us(324):.0f}μs")  # 1582μs
print(f"PWM 307 → {pwm_to_us(307):.0f}μs")  # 1499μs
print(f"PWM 287 → {pwm_to_us(287):.0f}μs")  # 1401μs
```

### 9.3 AI_THROTTLE_MULT適用後の実効値計算

```python
def calculate_effective_throttle(model_output, mult, stopped=307, forward=324):
    """AI_THROTTLE_MULT適用後の実効PWM値を計算"""
    effective_throttle = min(max(model_output * mult, -1.0), 1.0)
    pwm = throttle_to_pwm(effective_throttle, stopped, forward)
    return effective_throttle, pwm

# 例: モデル出力 0.25 に各種 MULT を適用
for mult in [1.0, 1.5, 2.0, 3.0]:
    eff, pwm = calculate_effective_throttle(0.25, mult)
    print(f"MULT={mult}: model=0.25 → effective={eff:.2f}, PWM={pwm}")
```

---

## 10. 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-03 15:20 | 初版作成（ml-engineer + robotcar-engineer 共同作業） |
| 2026-02-03 16:30 | 【重大】JOYSTICK_THROTTLE_DIR 反転バグを追加（セクション4.0） |

---

## 11. 次のアクション

| 優先度 | 担当 | アクション | 期限 |
|--------|------|-----------|------|
| **最高** | robotcar-engineer | **JOYSTICK_THROTTLE_DIR = 1.0 に修正** | **即時** |
| **最高** | data-engineer | **全データ再収集**（反転バグ修正後） | **即時** |
| **最高** | ml-engineer | **モデル再学習**（新データで） | **データ収集後** |
| 高 | ml-engineer | AI_THROTTLE_MULT = 2.0 を myconfig.py に設定 | 再学習後 |
| 高 | robotcar-engineer | ESCデッドバンドの実測 | 1日以内 |
| 中 | ml-engineer | 高速走行データの追加収集計画策定 | 1週間以内 |
| 中 | robotcar-engineer | myconfig.py のコメント修正（μs値） | 任意 |

### 11.1 緊急対応手順

```bash
# 1. myconfig.py を編集（Raspberry Pi上）
ssh koito@192.168.50.3
cd ~/mycar
nano myconfig.py

# 以下を追加:
# JOYSTICK_THROTTLE_DIR = 1.0

# 2. テスト走行で確認
python manage.py drive --js

# 3. ボタン押す → 前進、離す → 停止 を確認

# 4. 確認後、全データを削除して再収集
rm -rf data/tub_*
python manage.py drive --js
```
