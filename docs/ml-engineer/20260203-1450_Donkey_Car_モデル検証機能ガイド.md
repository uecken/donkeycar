# Donkey Car モデル検証機能ガイド

**作成日**: 2026年2月3日 14:50
**担当**: ml-engineer
**対象**: Donkey Car 5.1+ でのモデル検証機能の使い方

---

## 1. 概要

Donkey Car には学習したモデルの性能を検証するための複数の機能が用意されています。これらを活用することで、モデルが適切に学習できているか、どの部分を見て判断しているかを可視化・分析できます。

### 利用可能な検証機能一覧

| 機能 | コマンド/ツール | 用途 |
|------|----------------|------|
| **Pilot Screen** | `donkey ui` | 画像上にモデル予測を重ねて表示 |
| **Tubplot** | `donkey tubplot` | モデル予測 vs 実際の入力をグラフで比較 |
| **Makemovie** | `donkey makemovie` | 予測オーバーレイ付き動画生成 |
| **サリエンシーマップ** | `donkey makemovie --salient` | モデルの注目領域を可視化 |

### WebUI（リアルタイム走行時）の制限

`python manage.py drive` で起動する WebUI には、モデル評価機能は**ありません**。WebUI はリアルタイム操縦とデータ収集が主目的であり、事後検証は上記のツールを使用します。

---

## 2. donkey ui（Pilot Screen）の使い方

### 2.1 概要

`donkey ui` は Kivy ベースの GUI アプリケーションで、Tub データを閲覧しながらモデル予測を視覚的に確認できます。

**主な機能**:
- Tub 内の画像を1フレームずつ表示
- 画像上にユーザー入力（緑線）とモデル予測（青線）を重ねて表示
- 複数モデルの同時比較
- 画像変換（Crop, Trapeze 等）の適用テスト
- Augmentation（Brightness, Blur）の効果確認

### 2.2 起動方法

```bash
# 仮想環境の有効化
source ~/donkey_env/bin/activate

# donkey ui の起動
donkey ui
```

**必要条件**:
- Kivy がインストールされていること
- ディスプレイが利用可能であること（SSH経由の場合は X11 forwarding が必要）

### 2.3 Pilot Screen の操作手順

1. **Tub の読み込み**
   - 「Tub」タブで config.py のあるディレクトリを選択
   - Tub データを読み込む

2. **Pilot Screen への移動**
   - 「Pilot」タブをクリック

3. **モデルの読み込み**
   - 「Model type」ドロップダウンでモデルタイプを選択
     - `linear`: Keras Linear モデル (.h5)
     - `categorical`: Keras Categorical モデル (.h5)
     - `tflite_linear`: TFLite Linear モデル (.tflite)
   - 「Load Pilot」ボタンでモデルファイルを選択

4. **フレームの確認**
   - スライダーでフレームを移動
   - 緑線 = ユーザー入力（実際の操作）
   - 青線 = モデル予測

### 2.4 表示の解釈

```
画像表示:
┌─────────────────────┐
│                     │
│      [カメラ画像]    │
│                     │
│    青線↙  ↘緑線    │  ← 線の向き = ステアリング角度
│        ↑           │  ← 線の長さ = スロットル値
└─────────────────────┘

青線（左側）: モデル予測 (pilot/angle, pilot/throttle)
緑線（右側）: ユーザー入力 (user/angle, user/throttle)
```

**良好なモデルの場合**:
- 青線と緑線がほぼ同じ方向・長さを示す

**問題があるモデルの場合**:
- 青線と緑線の乖離が大きい
- 青線が常に一方向を向いている

### 2.5 複数モデルの比較

Pilot Screen では複数のモデルを同時に読み込んで比較できます。

1. 「Add Pilot」ボタンをクリック
2. 新しいモデルを読み込む
3. 各モデルの予測が並べて表示される

---

## 3. donkey tubplot の使い方

### 3.1 概要

`donkey tubplot` は、Tub データを使ってモデルの予測値とユーザー入力を時系列グラフで比較するツールです。

### 3.2 基本コマンド

```bash
donkey tubplot --tub <tub_path> --model <model_path> --type <model_type>
```

### 3.3 パラメータ詳細

| パラメータ | 説明 | 例 |
|-----------|------|-----|
| `--tub` | Tub データのパス | `./data/tub_01_23-02-03` |
| `--model` | モデルファイルのパス | `./models/mypilot.h5` |
| `--type` | モデルタイプ | `linear`, `categorical`, `tflite_linear` |
| `--limit` | 処理するレコード数（デフォルト: 1000） | `500` |
| `--config` | config.py のパス（デフォルト: `./config.py`） | `./config.py` |
| `--noshow` | グラフを表示せずファイル保存のみ | フラグ |

### 3.4 使用例

**Keras Linear モデルの検証**:
```bash
cd ~/mycar
donkey tubplot --tub ./data/tub_01_23-02-03 --model ./models/mypilot.h5 --type linear
```

**TFLite モデルの検証**:
```bash
donkey tubplot --tub ./data/tub_01_23-02-03 --model ./models/mypilot.tflite --type tflite_linear
```

**複数 Tub の結合**:
```bash
donkey tubplot --tub ./data/tub_01 ./data/tub_02 --model ./models/mypilot.h5 --type linear
```

**ヘッドレス環境（グラフ保存のみ）**:
```bash
donkey tubplot --tub ./data/tub_01 --model ./models/mypilot.h5 --type linear --noshow
```

### 3.5 出力

実行すると以下が生成されます:

1. **グラフウィンドウ**（`--noshow` なしの場合）
   - 上段: angle の比較（user_angle vs pilot_angle）
   - 下段: throttle の比較（user_throttle vs pilot_throttle）

2. **PNG ファイル**
   - `<model_path>_pred.png` として保存される
   - 例: `./models/mypilot.h5_pred.png`

### 3.6 グラフの解釈

```
=== Angle 比較 ===
      │    ∧
 1.0  │   /│\    user_angle (実線)
      │  / │ \   pilot_angle (破線)
 0.0  ├─┼──┼──┼─
      │  \ │ /
-1.0  │   \│/
      └───────────→ frame

=== Throttle 比較 ===
 1.0  │ ────────── user_throttle
      │ ---------- pilot_throttle
 0.0  ├───────────
      └───────────→ frame
```

**良好なモデル**:
- user と pilot の線がほぼ重なっている
- 急激な変化も追従できている

**改善が必要なモデル**:
- user と pilot の線に大きな乖離がある
- pilot が user の変化に遅れている
- pilot が常に同じような値を出力している

---

## 4. donkey makemovie の使い方

### 4.1 概要

`donkey makemovie` は、Tub データから動画を生成するツールです。モデル予測のオーバーレイやサリエンシーマップを含めた可視化動画を作成できます。

### 4.2 基本コマンド

```bash
donkey makemovie --tub <tub_path> --model <model_path> --type <model_type>
```

### 4.3 パラメータ詳細

| パラメータ | 説明 | デフォルト |
|-----------|------|-----------|
| `--tub` | Tub データのパス | **必須** |
| `--out` | 出力ファイル名 | `tub_movie.mp4` |
| `--model` | モデルファイルのパス | なし |
| `--type` | モデルタイプ | config の DEFAULT_MODEL_TYPE |
| `--salient` | サリエンシーマップを重ねる | なし |
| `--start` | 開始フレーム | 0 |
| `--end` | 終了フレーム | -1（最後まで） |
| `--scale` | 画像の拡大倍率 | 2 |
| `--draw-user-input` | ユーザー入力を描画 | True |
| `--config` | config.py のパス | `./config.py` |

### 4.4 使用例

**基本的な動画生成（モデル予測付き）**:
```bash
cd ~/mycar
donkey makemovie --tub ./data/tub_01 --model ./models/mypilot.h5 --type linear
```

**サリエンシーマップ付き動画**:
```bash
donkey makemovie --tub ./data/tub_01 --model ./models/mypilot.h5 --type linear --salient
```

**カスタム出力ファイル名**:
```bash
donkey makemovie --tub ./data/tub_01 --model ./models/mypilot.h5 --out my_validation.mp4
```

**フレーム範囲の指定**:
```bash
donkey makemovie --tub ./data/tub_01 --model ./models/mypilot.h5 --start 100 --end 500
```

### 4.5 サリエンシーマップについて

サリエンシーマップは、モデルが画像のどの領域に注目して判断しているかを可視化します。

**動作原理**:
1. モデルの出力層に対する入力画像の勾配を計算
2. 勾配の大きさをヒートマップとして可視化
3. 元画像に重ねて表示

**対応モデルタイプ**:
- `linear`: サポート
- `categorical`: サポート
- `tflite_*`: **非サポート**（TFLite モデルでは使用不可）

**出力例**:
```
┌─────────────────────┐
│ 明るい領域 = 注目度高 │
│ 暗い領域 = 注目度低   │
│                     │
│  [道路のエッジ]      │  ← 通常、道路境界線に注目
│  [白線/縁石]         │  ← レーンマーカーに注目
└─────────────────────┘
```

### 4.6 必要なパッケージ

```bash
pip install moviepy
```

---

## 5. WebUI の制限事項

### 5.1 WebUI でできること

`python manage.py drive` で起動する WebUI の機能:

| 機能 | 説明 |
|------|------|
| リアルタイム映像表示 | カメラからの映像をブラウザで確認 |
| 手動操縦 | 仮想ジョイスティックまたは物理コントローラーで操作 |
| モード切替 | User / Auto Steer / Full Auto の切り替え |
| データ記録 | Tub への走行データ保存 |
| ステアリング/スロットルバー表示 | 現在の入力値をバーで表示 |

### 5.2 WebUI でできないこと

| 機能 | 代替ツール |
|------|-----------|
| モデル予測の可視化（線表示） | `donkey ui` Pilot Screen |
| 過去データとの比較 | `donkey tubplot` |
| サリエンシーマップ | `donkey makemovie --salient` |
| フレーム単位の詳細検証 | `donkey ui` Pilot Screen |

### 5.3 リアルタイム検証の代替手段

WebUI でモデルが動作しているか確認するには:

1. **モード切替の確認**
   - `A` キーで Full Auto に切り替え
   - ステアリング/スロットルバーが動くか確認

2. **ログ出力の確認**
   ```bash
   # デバッグログを有効化
   PYTHONUNBUFFERED=1 python manage.py drive --model models/mypilot.tflite --type tflite_linear 2>&1 | tee drive.log
   ```

3. **AIデバッグ機能**（別資料参照）
   - `docs/ml-engineer/20260202-0150_自動運転モデル動作確認ガイド.md` を参照

---

## 6. 推奨検証フロー

### 6.1 学習後のモデル検証手順

```
学習完了
    │
    ▼
┌─────────────────────────────────────┐
│ Step 1: tubplot でグラフ確認        │
│ donkey tubplot --tub ./data/tub_01  │
│   --model ./models/mypilot.h5       │
│   --type linear                     │
└─────────────────────────────────────┘
    │
    │ グラフで大まかな傾向を確認
    ▼
┌─────────────────────────────────────┐
│ Step 2: donkey ui で詳細確認        │
│ donkey ui                           │
│ → Pilot Screen でフレーム単位確認   │
└─────────────────────────────────────┘
    │
    │ 問題のあるフレームを特定
    ▼
┌─────────────────────────────────────┐
│ Step 3: makemovie で動画生成        │
│ donkey makemovie --tub ./data/tub_01│
│   --model ./models/mypilot.h5       │
│   --salient                         │
└─────────────────────────────────────┘
    │
    │ サリエンシーマップで注目領域確認
    ▼
┌─────────────────────────────────────┐
│ Step 4: 実車テスト                   │
│ python manage.py drive              │
│   --model ./models/mypilot.tflite   │
│   --type tflite_linear              │
└─────────────────────────────────────┘
```

### 6.2 検証チェックリスト

**tubplot での確認項目**:
- [ ] angle の予測と実測が概ね一致している
- [ ] throttle の予測と実測が概ね一致している
- [ ] 急激な変化にも追従できている
- [ ] 予測値が一定値に張り付いていない

**donkey ui での確認項目**:
- [ ] カーブで青線（予測）が緑線（実測）と同じ方向を向いている
- [ ] 直線で青線が中央付近を向いている
- [ ] コーナー進入時に適切なタイミングでステアリングを切っている

**makemovie (salient) での確認項目**:
- [ ] 道路のエッジ/白線に注目している
- [ ] 空や壁など無関係な領域に注目していない
- [ ] カーブ手前で適切な領域に注目している

---

## 7. トラブルシューティング

### 7.1 donkey ui が起動しない

**症状**: `donkey ui` 実行時にエラー

**原因と対策**:

| エラーメッセージ | 原因 | 対策 |
|----------------|------|------|
| `ModuleNotFoundError: No module named 'kivy'` | Kivy 未インストール | `pip install kivy` |
| `Unable to get a Window` | ディスプレイなし | X11 forwarding を有効化 |
| `PermissionError` | ファイル権限 | `chmod` で権限付与 |

**SSH 経由での起動**:
```bash
# X11 forwarding を有効にして接続
ssh -X user@raspberry_pi

# または VNC を使用
```

### 7.2 tubplot でエラー

**症状**: `donkey tubplot` 実行時にエラー

| エラー | 原因 | 対策 |
|--------|------|------|
| `FileNotFoundError: config.py` | カレントディレクトリが違う | `cd ~/mycar` を実行 |
| `FileNotFoundError: model` | モデルパスが違う | 絶対パスで指定 |
| `ValueError: Model type` | タイプ指定が間違っている | `--type` を確認 |

### 7.3 makemovie でエラー

**症状**: `donkey makemovie` 実行時にエラー

| エラー | 原因 | 対策 |
|--------|------|------|
| `ModuleNotFoundError: moviepy` | moviepy 未インストール | `pip install moviepy` |
| `salient: Model type not supported` | TFLite でサリエンシー | Keras モデル (.h5) を使用 |
| `Memory Error` | メモリ不足 | `--start`/`--end` で範囲限定 |

### 7.4 グラフが表示されない

**症状**: tubplot/makemovie は完了するが画像が表示されない

**対策**:
```bash
# matplotlib のバックエンド設定
export MPLBACKEND=TkAgg

# または headless モードで保存のみ
donkey tubplot --tub ./data/tub_01 --model ./models/mypilot.h5 --type linear --noshow
```

### 7.5 サリエンシーマップが生成されない

**症状**: `--salient` を指定してもサリエンシーが表示されない

**確認事項**:
1. モデルタイプが `linear` または `categorical` か
2. モデルに `out` を含むレイヤーがあるか
3. TFLite モデルでないか（TFLite は非サポート）

**ログ確認**:
```
# 正常時
Visualizing activations on layer: ['angle_out', 'throttle_out']

# 失敗時
Failed to find the model layer named with 'out'. Skipping salient.
```

---

## 8. 関連資料

| 資料名 | パス |
|--------|------|
| 自動運転モデル動作確認ガイド | `docs/ml-engineer/20260202-0150_自動運転モデル動作確認ガイド.md` |
| DonkeyCar自動運転ガイド | `docs/ml-engineer/20260129-2330_DonkeyCar自動運転ガイド.md` |
| 学習環境パフォーマンス比較 | `docs/ml-engineer/20260122-1910_学習環境パフォーマンス比較.md` |
| GPU サーバー構成ガイド | `docs/ml-engineer/gpu_server_guide.md` |

### Donkey Car 公式ドキュメント

- [Donkey Car UI](https://docs.donkeycar.com/utility/ui/)
- [Training Tips](https://docs.donkeycar.com/guide/train_autopilot/)

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-03 14:50 | 初版作成 |
