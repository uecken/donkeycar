# 自動運転モデル動作確認ガイド

**作成日**: 2026年2月2日
**担当**: ml-engineer, robotcar-engineer
**対象**: TFLiteモデルでの自動運転が正常に動作しているか確認する方法

---

## 概要

`python manage.py drive --model ~/mycar/models/mypilot.tflite --type tflite_linear` で自動運転を実行した際に、モデルが正常に動作しているかを確認する方法をまとめます。

---

## 1. 起動コマンドの書式

### 1.1 基本コマンド

```bash
python manage.py drive --model <モデルパス> --type <モデルタイプ> [オプション]
```

### 1.2 モデルファイルとタイプの対応

| ファイル拡張子 | モデル種類 | `--type` オプション |
|---------------|-----------|-------------------|
| `.h5` | Keras Linear | `linear` |
| `.h5` | Keras Categorical | `categorical` |
| `.tflite` | TFLite Linear | `tflite_linear` |
| `.tflite` | TFLite Categorical | `tflite_categorical` |
| `.savedmodel/` | TensorRT Linear | `tensorrt_linear` |

**重要**: `.tflite` ファイルには必ず `tflite_` プレフィックスをつけたタイプを指定する。

内部処理（`donkeycar/utils.py`）:
```python
# tflite_ プレフィックスが指定された場合、TFLite インタープリタを使用
if 'tflite_' in model_type:
    used_model_type = model_type.replace('tflite_', '')  # → 'linear'
```

### 1.3 ジョイスティック/コントローラーオプション

| オプション | 説明 | 使用場面 |
|-----------|------|---------|
| `--js` | ジョイスティック有効化 | 物理コントローラーで操作する場合 |
| なし | WebUIのみ | ブラウザから操作する場合 |

**`--js` フラグ使用時のログ**:
```
INFO:donkeycar.vehicle:Adding part XboxOneJoystickController.
```

**`--js` フラグなしの場合**:
- WebUIの仮想ジョイスティックで操作
- コントローラーパーツは追加されない

### 1.4 推奨コマンド例

**TFLiteモデル + ジョイスティック**:
```bash
python manage.py drive --model ~/mycar/models/mypilot.tflite --type tflite_linear --js
```

**TFLiteモデル + WebUIのみ**:
```bash
python manage.py drive --model ~/mycar/models/mypilot.tflite --type tflite_linear
```

**Kerasモデル + ジョイスティック**:
```bash
python manage.py drive --model ~/mycar/models/mypilot.h5 --type linear --js
```

### 1.5 myconfig.py でのデフォルト設定

ジョイスティックを常にデフォルトで有効にする場合:

```python
# myconfig.py
USE_JOYSTICK_AS_DEFAULT = True
JOYSTICK_DEVICE_FILE = "/dev/input/js0"
CONTROLLER_TYPE = 'xbox'  # または 'ps4', 'F710', etc.
```

---

## 2. Pythonログでの確認

### 2.1 起動ログで確認すべきポイント

```bash
python manage.py drive --model ~/mycar/models/mypilot.tflite --type tflite_linear --js
```

**正常なログ例（`--js` オプションあり）**:
```
INFO:donkeycar.parts.keras:Loading model /home/koito/mycar/models/mypilot.tflite
INFO:donkeycar.parts.interpreter:Loading model /home/koito/mycar/models/mypilot.tflite
finished loading in 0.50 sec.
INFO:donkeycar.vehicle:Adding part KerasLinear.
INFO:donkeycar.vehicle:Adding part XboxOneJoystickController.
INFO:donkeycar.vehicle:Adding part PWMSteering.
INFO:donkeycar.vehicle:Adding part PWMThrottle.
INFO:donkeycar.vehicle:Starting vehicle at 20 Hz
```

**チェック項目**:

| ログメッセージ | 意味 | 問題時 |
|--------------|------|--------|
| `Loading model ...mypilot.tflite` | モデル読み込み開始 | ファイルが存在しない場合エラー |
| `finished loading in X sec` | モデル読み込み完了 | 出ない場合はモデル破損の可能性 |
| `Adding part KerasLinear` | 推論パーツ追加 | `--type` が間違っていると別のパーツ |
| `Adding part XboxOneJoystickController` | コントローラー追加 | `--js` なし or コントローラー未接続 |
| `Starting vehicle at 20 Hz` | 車両ループ開始 | 起動前にエラーが出ると表示されない |

### 2.2 デバッグログを有効にする

**myconfig.py** に以下を追加:

```python
# ログレベルをDEBUGに変更
LOGGING_LEVEL = 'DEBUG'
```

または起動時に環境変数で指定:

```bash
PYTHONUNBUFFERED=1 python manage.py drive --model ~/mycar/models/mypilot.tflite --type tflite_linear --js 2>&1 | tee drive.log
```

### 2.3 推論出力を直接確認する

モデルが推論結果を出力しているか確認するには、**デバッグスクリプト**を使用:

**専用スクリプト（推奨）**:
```bash
# Raspberry Pi で実行
cd ~/mycar
python ~/donkeycar/scripts/test_model_inference.py --model models/mypilot.tflite

# カメラ画像でテスト
python ~/donkeycar/scripts/test_model_inference.py --model models/mypilot.tflite --camera
```

**簡易テストスクリプト**:

```python
#!/usr/bin/env python3
"""モデル推論テスト"""
import numpy as np
import tflite_runtime.interpreter as tflite
# または: import tensorflow.lite as tflite

# モデル読み込み
interpreter = tflite.Interpreter(model_path="models/mypilot.tflite")
interpreter.allocate_tensors()

# 入力/出力テンソル情報
input_details = interpreter.get_input_details()
output_details = interpreter.get_output_details()

print("=== モデル情報 ===")
print(f"入力形状: {input_details[0]['shape']}")
print(f"出力数: {len(output_details)}")

# ダミー画像で推論テスト
input_shape = input_details[0]['shape']
dummy_image = np.random.rand(*input_shape).astype(np.float32)
interpreter.set_tensor(input_details[0]['index'], dummy_image)
interpreter.invoke()

# 出力取得
for i, output in enumerate(output_details):
    result = interpreter.get_tensor(output['index'])
    print(f"出力{i}: {result}")
```

**実行**:
```bash
cd ~/mycar
python test_model.py
```

**期待される出力**:
```
=== モデル情報 ===
入力形状: [1, 120, 160, 3]
出力数: 2
出力0: [[0.123]]    # angle
出力1: [[0.456]]    # throttle
```

---

## 3. WebUIでの確認

### 3.1 WebUIへのアクセス

```
http://donkey10.local:8887
または
http://192.168.50.3:8887
```

### 3.2 モード切替

| モード | キーボード | 動作 |
|--------|----------|------|
| **User** | `U` | 手動操作（モデル使用しない） |
| **Auto Steer** | `S` | ステアリングのみモデル、スロットルは手動 |
| **Full Auto** | `A` | **完全自動運転（モデル使用）** |

**重要**: モデルを動かすには **「Full Auto」（Aキー）** に切り替える必要があります。

### 3.3 ステアリング/スロットルバーの確認

WebUIには以下のバーが表示されます:

```
ステアリング: [◄████████░░░░░░░░░░░►]  0.35
スロットル:   [▼░░░░░░░░████████▲]  0.50
```

- **Userモード**: 手動入力値を表示
- **Full Autoモード**: モデル出力値を表示（`pilot/angle`, `pilot/throttle`）

### 3.4 ブラウザコンソールでの確認

ブラウザの開発者ツール（F12）→ Consoleタブで、WebSocket通信を確認できます:

```javascript
// WebSocketメッセージ例
{"driveMode": "local", "tele": {"pilot": {"angle": 0.123, "throttle": 0.456}}}
```

---

## 4. ターミナルでのリアルタイム確認

### 4.1 PWM出力の確認

PCA9685のPWM出力を確認するには、I2Cツールを使用:

```bash
# I2Cバス上のデバイス確認
sudo i2cdetect -y 1

# PCA9685のレジスタ読み取り（Ch0: ステアリング）
sudo i2cget -y 1 0x40 0x06  # LED0_ON_L
sudo i2cget -y 1 0x40 0x08  # LED0_OFF_L
```

### 4.2 リアルタイムログ出力スクリプト

**myconfig.py** に追加して、推論値をリアルタイム表示:

```python
# 推論値のログ出力を有効化
def print_pilot_values(pilot_angle, pilot_throttle):
    print(f"Pilot: angle={pilot_angle:.3f}, throttle={pilot_throttle:.3f}")
    return pilot_angle, pilot_throttle

# manage.py の add_drivetrain() 前に追加
# V.add(Lambda(print_pilot_values), inputs=['pilot/angle', 'pilot/throttle'],
#       outputs=['pilot/angle', 'pilot/throttle'])
```

### 4.3 テレメトリログの有効化

**myconfig.py**:

```python
# テレメトリログを有効化
HAVE_MQTT_TELEMETRY = False  # MQTTは不要
TELEMETRY_LOGGING_ENABLE = True
TELEMETRY_LOGGING_LEVEL = 'INFO'
TELEMETRY_DEFAULT_INPUTS = 'pilot/angle,pilot/throttle,user/mode,recording'
```

---

## 5. 動作確認チェックリスト

### 起動前

| 項目 | 確認コマンド | 期待値 |
|------|------------|--------|
| モデルファイル存在 | `ls ~/mycar/models/mypilot.tflite` | ファイルが存在 |
| PCA9685接続 | `sudo i2cdetect -y 1` | アドレス 0x40 が表示 |
| ESC起動音 | （電源投入時） | 「ピッピピピ」 |

### 起動時

| 項目 | 確認方法 | 期待値 |
|------|---------|--------|
| モデル読み込み | ログ確認 | `finished loading` が表示 |
| パーツ追加 | ログ確認 | `Adding part KerasLinear` が表示 |
| 車両ループ開始 | ログ確認 | `Starting vehicle at 20 Hz` |

### 動作中

| 項目 | 確認方法 | 期待値 |
|------|---------|--------|
| モード | WebUI / ログ | `Full Auto` または `local` |
| ステアリング反応 | 車両を見る | カメラ画像に応じてサーボが動く |
| スロットル反応 | 車両を見る | モーターが動く |

---

## 6. トラブルシューティング

### 問題: モデル読み込みエラー

```
FileNotFoundError: models/mypilot.tflite
```

**解決策**:
```bash
# モデルの存在確認
ls -la ~/mycar/models/

# パスを絶対パスで指定
python manage.py drive --model /home/koito/mycar/models/mypilot.tflite --type tflite_linear
```

### 問題: モデルタイプの不一致

```
ValueError: Model type mismatch
```

**解決策**: `--type` オプションを確認

| モデル形式 | --type オプション |
|-----------|-----------------|
| `.h5` (Keras) | `linear` |
| `.tflite` (TFLite) | `tflite_linear` |
| `.tflite` (Categorical) | `tflite_categorical` |

### 問題: Full Autoモードで動かない

**確認事項**:
1. WebUIで「Full Auto」（`A`キー）に切り替えたか
2. ログに `user/mode: local` と表示されているか
3. モデルが推論結果を出力しているか

**デバッグ**:
```bash
# manage.py に以下を追加（一時的）
print(f"Mode: {V.mem['user/mode']}, Pilot angle: {V.mem.get('pilot/angle')}, Pilot throttle: {V.mem.get('pilot/throttle')}")
```

### 問題: ステアリング/スロットルが極端な値

**可能性**:
- 学習データの偏り
- 画像入力のサイズ/正規化の不一致

**確認**:
```python
# 入力画像のサイズ確認
print(f"Expected: {input_details[0]['shape']}")  # [1, 120, 160, 3]
print(f"Camera: {cfg.IMAGE_H} x {cfg.IMAGE_W}")   # 120 x 160
```

---

## 7. PWM値とモデル出力の関係

### モデル出力 → PWM変換

| モデル出力 | PWM値 | パルス幅 | 動作 |
|-----------|-------|---------|------|
| throttle = 1.0 | 330 | 1611μs | 前進最大 |
| throttle = 0.0 | 307 | 1499μs | 停止 |
| throttle = -1.0 | 281 | 1372μs | 後退最大 |
| angle = -1.0 | LEFT_PWM | - | 左最大 |
| angle = 0.0 | CENTER_PWM | - | 中央 |
| angle = 1.0 | RIGHT_PWM | - | 右最大 |

### 変換式

```python
# donkeycar/parts/actuator.py より
def map_range(x, X_min, X_max, Y_min, Y_max):
    X_range = X_max - X_min
    Y_range = Y_max - Y_min
    XY_ratio = Y_range / X_range
    return ((x - X_min) * XY_ratio + Y_min)

# throttle > 0 の場合
pwm = map_range(throttle, 0, 1, STOPPED_PWM, FORWARD_PWM)

# throttle < 0 の場合
pwm = map_range(throttle, -1, 0, REVERSE_PWM, STOPPED_PWM)
```

---

## 8. 推奨確認フロー

```
1. モデルファイル確認
   └── ls ~/mycar/models/mypilot.tflite

2. 起動
   └── python manage.py drive --model ~/mycar/models/mypilot.tflite --type tflite_linear --js

3. ログ確認
   └── "finished loading" と "Starting vehicle at 20 Hz" を確認

4. WebUI接続
   └── http://donkey10.local:8887

5. モード切替
   └── キーボード「A」で Full Auto に切替

6. 動作確認
   └── ステアリング/スロットルバーが動いているか
   └── 車両が反応しているか
```

---

## 9. AIデバッグ機能付き manage.py

### 9.1 概要

AI出力値（`pilot/angle`, `pilot/throttle`）をリアルタイムでターミナルに表示するデバッグ機能を追加した `manage.py` を用意しています。

**ファイル**: `scripts/manage_with_debug.py`

### 9.2 導入方法

```bash
# Raspberry Pi で実行
cd ~/mycar

# 既存のmanage.pyをバックアップ
cp manage.py manage.py.bak

# デバッグ版をコピー
cp ~/donkeycar/scripts/manage_with_debug.py manage.py

# 実行
python manage.py drive --model models/mypilot.tflite --type tflite_linear --js
```

### 9.3 出力例

**Full Auto モード時**:
```
============================================================
AI DEBUG MODE ENABLED
============================================================
AI output values will be displayed in real-time.
To disable: add 'AI_DEBUG = False' to myconfig.py
============================================================

[FULL_AUTO] angle:+0.123(310) throttle:-0.040*1.0=-0.040(306) [STRAIGHT/STOP] frame:1234
```

**表示内容**:
- `angle:+0.123(310)`: モデル出力の角度値とPWM値
- `throttle:-0.040*1.0=-0.040(306)`: モデル出力、乗数、実際の値、PWM値
- `[STRAIGHT/STOP]`: 動作解釈（LEFT/STRAIGHT/RIGHT と FWD/STOP/REV）
- `frame:1234`: フレーム番号

### 9.4 設定オプション

**myconfig.py** で設定可能:

```python
# AIデバッグ出力を無効化
AI_DEBUG = False

# スロットル乗数（モデル出力を増幅）
AI_THROTTLE_MULT = 2.0  # throttle値を2倍に
```

### 9.5 問題解析への活用

1. **モデルが停止値を出力している場合**:
   ```
   throttle:-0.040*1.0=-0.040(306) [STOP]
   ```
   → `AI_THROTTLE_MULT = 5.0` などで増幅を試す

2. **ステアリングが常に一方向**:
   ```
   angle:+0.850(328) [RIGHT]
   ```
   → 学習データの偏りを確認

3. **推論が実行されていない**:
   - Full Auto (`local`) モードになっているか確認
   - `[USER]` 表示の場合は手動モード

---

## 10. 専用デバッグツール

### 10.1 モデル推論テストスクリプト

**ファイル**: `scripts/test_model_inference.py`

Donkey Car を起動せずにモデルの推論出力を直接確認:

```bash
cd ~/mycar

# ダミー画像でテスト
python ~/donkeycar/scripts/test_model_inference.py --model models/mypilot.tflite --dummy

# カメラ画像でテスト
python ~/donkeycar/scripts/test_model_inference.py --model models/mypilot.tflite --camera

# 連続推論テスト（10回）
python ~/donkeycar/scripts/test_model_inference.py --model models/mypilot.tflite --camera --count 10
```

**出力例**:
```
【推論結果】
  angle:    -0.0421  (範囲: -1.0 〜 +1.0)
  throttle: -0.0398  (範囲: -1.0 〜 +1.0)

【PWM変換（HBX 2192）】
  ステアリング: PWM=306, パルス幅=1494μs
  スロットル:   PWM=306, パルス幅=1494μs

【動作解釈】
  ステアリング: ↑ 直進
  スロットル:   ■ 停止
```

### 10.2 パイロット値リアルタイム監視

**ファイル**: `scripts/monitor_pilot_values.py`

Donkey Car 起動中に別ターミナルからWebSocket経由で監視:

```bash
# 別ターミナルで実行
python ~/donkeycar/scripts/monitor_pilot_values.py

# カスタムポート
python ~/donkeycar/scripts/monitor_pilot_values.py --port 8887

# CSVログ出力
python ~/donkeycar/scripts/monitor_pilot_values.py --log pilot_log.csv
```

**要件**: `pip install websockets`

---

## 関連資料

| 資料名 | パス |
|--------|------|
| DonkeyCar自動運転ガイド | `docs/ml-engineer/20260129-2330_DonkeyCar自動運転ガイド.md` |
| ジョイスティック値とPWM幅の関係 | `docs/robotcar-engineer/20260130-0010_ジョイスティック値とPWM幅の関係.md` |
| HBX2192制御調査 | `docs/robotcar-engineer/20260128-2010_HBX2192制御調査.md` |
| DonkeyCar起動ガイド | `docs/robotcar-engineer/20260129-1830_DonkeyCar起動ガイド.md` |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-02 01:50 | 初版作成（ml-engineer + robotcar-engineer 共同作成） |
| 2026-02-02 02:10 | コマンド書式セクション追加、`--js` オプション説明追加 |
| 2026-02-02 03:30 | AIデバッグ機能付きmanage.py、専用デバッグツール説明追加 |
